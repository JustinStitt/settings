diff --color -Naur /usr/local/google/home/justinstitt/repos/b4/b4/0001-fix-sendgmr-from-header.patch /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/0001-fix-sendgmr-from-header.patch
--- /usr/local/google/home/justinstitt/repos/b4/b4/0001-fix-sendgmr-from-header.patch	2023-08-01 22:44:57.517599032 +0000
+++ /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/0001-fix-sendgmr-from-header.patch	1970-01-01 00:00:00.000000000 +0000
@@ -1,26 +0,0 @@
-From e7b7615d505367c4f129849adfdac4648be924d6 Mon Sep 17 00:00:00 2001
-From: Justin Stitt <justinstitt@google.com>
-Date: Tue, 1 Aug 2023 22:44:51 +0000
-Subject: [PATCH] fix sendgmr from header
-
-Signed-off-by: Justin Stitt <justinstitt@google.com>
----
- b4/__init__.py | 2 +-
- 1 file changed, 1 insertion(+), 1 deletion(-)
-
-diff --git a/b4/__init__.py b/b4/__init__.py
-index b974642..993d6f6 100644
---- a/b4/__init__.py
-+++ b/b4/__init__.py
-@@ -3259,7 +3259,7 @@ def get_smtp(dryrun: bool = False) -> Tuple[Union[smtplib.SMTP, smtplib.SMTP_SSL
-         else:
-             envpair = email.utils.parseaddr(fromaddr)
-         if envpair[1]:
--            smtp += ['-f', envpair[1]]
-+            smtp += ['-t']
-         return smtp, fromaddr
- 
-     encryption = sconfig.get('smtpencryption')
--- 
-2.41.0.585.gd2178a4bd4-goog
-
diff --color -Naur /usr/local/google/home/justinstitt/repos/b4/b4/command.py /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/command.py
--- /usr/local/google/home/justinstitt/repos/b4/b4/command.py	2023-08-03 22:45:55.036919619 +0000
+++ /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/command.py	2023-08-03 22:10:47.035710194 +0000
@@ -3,7 +3,7 @@
 # SPDX-License-Identifier: GPL-2.0-or-later
 # Copyright (C) 2020 by the Linux Foundation
 #
-__author__ = 'Konstantin Ryabitsev <konstantin@linuxfoundation.org>'
+__author__ = "Konstantin Ryabitsev <konstantin@linuxfoundation.org>"
 
 import argparse
 import logging
@@ -14,275 +14,655 @@
 
 
 def cmd_retrieval_common_opts(sp):
-    sp.add_argument('msgid', nargs='?',
-                    help='Message ID to process, or pipe a raw message')
-    sp.add_argument('-m', '--use-local-mbox', dest='localmbox', default=None,
-                    help='Instead of grabbing a thread from lore, process this mbox file (or - for stdin)')
-    sp.add_argument('--stdin-pipe-sep',
-                    help='When accepting messages on stdin, split using this pipe separator string')
-    sp.add_argument('-C', '--no-cache', dest='nocache', action='store_true', default=False,
-                    help='Do not use local cache')
+    sp.add_argument(
+        "msgid", nargs="?", help="Message ID to process, or pipe a raw message"
+    )
+    sp.add_argument(
+        "-m",
+        "--use-local-mbox",
+        dest="localmbox",
+        default=None,
+        help="Instead of grabbing a thread from lore, process this mbox file (or - for stdin)",
+    )
+    sp.add_argument(
+        "--stdin-pipe-sep",
+        help="When accepting messages on stdin, split using this pipe separator string",
+    )
+    sp.add_argument(
+        "-C",
+        "--no-cache",
+        dest="nocache",
+        action="store_true",
+        default=False,
+        help="Do not use local cache",
+    )
 
 
 def cmd_mbox_common_opts(sp):
     cmd_retrieval_common_opts(sp)
-    sp.add_argument('-o', '--outdir', default='.',
-                    help='Output into this directory (or use - to output mailbox contents to stdout)')
-    sp.add_argument('-c', '--check-newer-revisions', dest='checknewer', action='store_true', default=False,
-                    help='Check if newer patch revisions exist')
-    sp.add_argument('-n', '--mbox-name', dest='wantname', default=None,
-                    help='Filename to name the mbox destination')
-    sp.add_argument('-M', '--save-as-maildir', dest='maildir', action='store_true', default=False,
-                    help='Save as maildir (avoids mbox format ambiguities)')
+    sp.add_argument(
+        "-o",
+        "--outdir",
+        default=".",
+        help="Output into this directory (or use - to output mailbox contents to stdout)",
+    )
+    sp.add_argument(
+        "-c",
+        "--check-newer-revisions",
+        dest="checknewer",
+        action="store_true",
+        default=False,
+        help="Check if newer patch revisions exist",
+    )
+    sp.add_argument(
+        "-n",
+        "--mbox-name",
+        dest="wantname",
+        default=None,
+        help="Filename to name the mbox destination",
+    )
+    sp.add_argument(
+        "-M",
+        "--save-as-maildir",
+        dest="maildir",
+        action="store_true",
+        default=False,
+        help="Save as maildir (avoids mbox format ambiguities)",
+    )
 
 
 def cmd_am_common_opts(sp):
-    sp.add_argument('-v', '--use-version', dest='wantver', type=int, default=None,
-                    help='Get a specific version of the patch/series')
-    sp.add_argument('-t', '--apply-cover-trailers', dest='covertrailers', action='store_true', default=False,
-                    help='Apply trailers sent to the cover letter to all patches')
-    sp.add_argument('-S', '--sloppy-trailers', dest='sloppytrailers', action='store_true', default=False,
-                    help='Apply trailers without email address match checking')
-    sp.add_argument('-T', '--no-add-trailers', dest='noaddtrailers', action='store_true', default=False,
-                    help='Do not add any trailers from follow-up messages')
-    sp.add_argument('-s', '--add-my-sob', dest='addmysob', action='store_true', default=False,
-                    help='Add your own signed-off-by to every patch')
-    sp.add_argument('-l', '--add-link', dest='addlink', action='store_true', default=False,
-                    help='Add a Link: with message-id lookup URL to every patch')
-    sp.add_argument('-P', '--cherry-pick', dest='cherrypick', default=None,
-                    help='Cherry-pick a subset of patches (e.g. "-P 1-2,4,6-", '
-                         '"-P _" to use just the msgid specified, or '
-                         '"-P *globbing*" to match on commit subject)')
-    sp.add_argument('--cc-trailers', dest='copyccs', action='store_true', default=False,
-                    help='Copy all Cc\'d addresses into Cc: trailers')
-    sp.add_argument('--no-parent', dest='noparent', action='store_true', default=False,
-                    help='Break thread at the msgid specified and ignore any parent messages')
-    sp.add_argument('--allow-unicode-control-chars', dest='allowbadchars', action='store_true', default=False,
-                    help='Allow unicode control characters (very rarely legitimate)')
+    sp.add_argument(
+        "-v",
+        "--use-version",
+        dest="wantver",
+        type=int,
+        default=None,
+        help="Get a specific version of the patch/series",
+    )
+    sp.add_argument(
+        "-t",
+        "--apply-cover-trailers",
+        dest="covertrailers",
+        action="store_true",
+        default=False,
+        help="Apply trailers sent to the cover letter to all patches",
+    )
+    sp.add_argument(
+        "-S",
+        "--sloppy-trailers",
+        dest="sloppytrailers",
+        action="store_true",
+        default=False,
+        help="Apply trailers without email address match checking",
+    )
+    sp.add_argument(
+        "-T",
+        "--no-add-trailers",
+        dest="noaddtrailers",
+        action="store_true",
+        default=False,
+        help="Do not add any trailers from follow-up messages",
+    )
+    sp.add_argument(
+        "-s",
+        "--add-my-sob",
+        dest="addmysob",
+        action="store_true",
+        default=False,
+        help="Add your own signed-off-by to every patch",
+    )
+    sp.add_argument(
+        "-l",
+        "--add-link",
+        dest="addlink",
+        action="store_true",
+        default=False,
+        help="Add a Link: with message-id lookup URL to every patch",
+    )
+    sp.add_argument(
+        "-P",
+        "--cherry-pick",
+        dest="cherrypick",
+        default=None,
+        help='Cherry-pick a subset of patches (e.g. "-P 1-2,4,6-", '
+        '"-P _" to use just the msgid specified, or '
+        '"-P *globbing*" to match on commit subject)',
+    )
+    sp.add_argument(
+        "--cc-trailers",
+        dest="copyccs",
+        action="store_true",
+        default=False,
+        help="Copy all Cc'd addresses into Cc: trailers",
+    )
+    sp.add_argument(
+        "--no-parent",
+        dest="noparent",
+        action="store_true",
+        default=False,
+        help="Break thread at the msgid specified and ignore any parent messages",
+    )
+    sp.add_argument(
+        "--allow-unicode-control-chars",
+        dest="allowbadchars",
+        action="store_true",
+        default=False,
+        help="Allow unicode control characters (very rarely legitimate)",
+    )
 
 
 def cmd_mbox(cmdargs):
     import b4.mbox
+
     b4.mbox.main(cmdargs)
 
 
 def cmd_kr(cmdargs):
     import b4.kr
+
     b4.kr.main(cmdargs)
 
 
 def cmd_prep(cmdargs):
     import b4.ez
+
     b4.ez.cmd_prep(cmdargs)
 
 
 def cmd_trailers(cmdargs):
     import b4.ez
+
     b4.ez.cmd_trailers(cmdargs)
 
 
 def cmd_send(cmdargs):
     import b4.ez
+
     b4.ez.cmd_send(cmdargs)
 
 
 def cmd_am(cmdargs):
     import b4.mbox
+
     b4.mbox.main(cmdargs)
 
 
 def cmd_shazam(cmdargs):
     import b4.mbox
+
     b4.mbox.main(cmdargs)
 
 
 def cmd_pr(cmdargs):
     import b4.pr
+
     b4.pr.main(cmdargs)
 
 
 def cmd_ty(cmdargs):
     import b4.ty
+
     b4.ty.main(cmdargs)
 
 
 def cmd_diff(cmdargs):
     import b4.diff
+
     b4.diff.main(cmdargs)
 
 
 def setup_parser() -> argparse.ArgumentParser:
     # noinspection PyTypeChecker
     parser = argparse.ArgumentParser(
-        prog='b4',
-        description='A tool to work with patches in public-inbox archives',
-        epilog='Online docs available at https://b4.docs.kernel.org',
+        prog="b4",
+        description="A tool to work with patches in public-inbox archives",
+        epilog="Online docs available at https://b4.docs.kernel.org",
         formatter_class=argparse.ArgumentDefaultsHelpFormatter,
     )
-    parser.add_argument('--version', action='version', version=b4.__VERSION__)
-    parser.add_argument('-d', '--debug', action='store_true', default=False,
-                        help='Add more debugging info to the output')
-    parser.add_argument('-q', '--quiet', action='store_true', default=False,
-                        help='Output critical information only')
-    parser.add_argument('-n', '--no-interactive', action='store_true', default=False,
-                        help='Do not ask any interactive questions')
-    parser.add_argument('--offline-mode', action='store_true', default=False,
-                        help='Do not perform any network queries')
-    parser.add_argument('--no-stdin', action='store_true', default=False,
-                        help='Disable TTY detection for stdin')
-    parser.add_argument('--use-web-endpoint', dest='send_web', action='store_true', default=False,
-                        help="Force going through the web endpoint")
+    parser.add_argument("--version", action="version", version=b4.__VERSION__)
+    parser.add_argument(
+        "-d",
+        "--debug",
+        action="store_true",
+        default=False,
+        help="Add more debugging info to the output",
+    )
+    parser.add_argument(
+        "-q",
+        "--quiet",
+        action="store_true",
+        default=False,
+        help="Output critical information only",
+    )
+    parser.add_argument(
+        "-n",
+        "--no-interactive",
+        action="store_true",
+        default=False,
+        help="Do not ask any interactive questions",
+    )
+    parser.add_argument(
+        "--offline-mode",
+        action="store_true",
+        default=False,
+        help="Do not perform any network queries",
+    )
+    parser.add_argument(
+        "--no-stdin",
+        action="store_true",
+        default=False,
+        help="Disable TTY detection for stdin",
+    )
 
-    subparsers = parser.add_subparsers(help='sub-command help', dest='subcmd')
+    subparsers = parser.add_subparsers(help="sub-command help", dest="subcmd")
 
     # b4 mbox
-    sp_mbox = subparsers.add_parser('mbox', help='Download a thread as an mbox file')
+    sp_mbox = subparsers.add_parser("mbox", help="Download a thread as an mbox file")
     cmd_mbox_common_opts(sp_mbox)
-    sp_mbox.add_argument('-f', '--filter-dupes', dest='filterdupes', action='store_true', default=False,
-                         help='When adding messages to existing maildir, filter out duplicates')
-    sp_mbox.add_argument('-r', '--refetch', dest='refetch', metavar='MBOX', default=False,
-                         help='Refetch all messages in specified mbox with their original headers')
+    sp_mbox.add_argument(
+        "-f",
+        "--filter-dupes",
+        dest="filterdupes",
+        action="store_true",
+        default=False,
+        help="When adding messages to existing maildir, filter out duplicates",
+    )
+    sp_mbox.add_argument(
+        "-r",
+        "--refetch",
+        dest="refetch",
+        metavar="MBOX",
+        default=False,
+        help="Refetch all messages in specified mbox with their original headers",
+    )
     sp_mbox.set_defaults(func=cmd_mbox)
 
     # b4 am
-    sp_am = subparsers.add_parser('am', help='Create an mbox file that is ready to git-am')
+    sp_am = subparsers.add_parser(
+        "am", help="Create an mbox file that is ready to git-am"
+    )
     cmd_mbox_common_opts(sp_am)
     cmd_am_common_opts(sp_am)
-    sp_am.add_argument('-Q', '--quilt-ready', dest='quiltready', action='store_true', default=False,
-                       help='Save patches in a quilt-ready folder')
-    sp_am.add_argument('-g', '--guess-base', dest='guessbase', action='store_true', default=False,
-                       help='Try to guess the base of the series (if not specified)')
-    sp_am.add_argument('-b', '--guess-branch', dest='guessbranch', nargs='+', action='extend', type=str, default=None,
-                       help='When guessing base, restrict to this branch (use with -g)')
-    sp_am.add_argument('--guess-lookback', dest='guessdays', type=int, default=21,
-                       help='When guessing base, go back this many days from the patch date (default: 2 weeks)')
-    sp_am.add_argument('-3', '--prep-3way', dest='threeway', action='store_true', default=False,
-                       help='Prepare for a 3-way merge '
-                            '(tries to ensure that all index blobs exist by making a fake commit range)')
-    sp_am.add_argument('--no-cover', dest='nocover', action='store_true', default=False,
-                       help='Do not save the cover letter (on by default when using -o -)')
-    sp_am.add_argument('--no-partial-reroll', dest='nopartialreroll', action='store_true', default=False,
-                       help='Do not reroll partial series when detected')
+    sp_am.add_argument(
+        "-Q",
+        "--quilt-ready",
+        dest="quiltready",
+        action="store_true",
+        default=False,
+        help="Save patches in a quilt-ready folder",
+    )
+    sp_am.add_argument(
+        "-g",
+        "--guess-base",
+        dest="guessbase",
+        action="store_true",
+        default=False,
+        help="Try to guess the base of the series (if not specified)",
+    )
+    sp_am.add_argument(
+        "-b",
+        "--guess-branch",
+        dest="guessbranch",
+        nargs="+",
+        action="extend",
+        type=str,
+        default=None,
+        help="When guessing base, restrict to this branch (use with -g)",
+    )
+    sp_am.add_argument(
+        "--guess-lookback",
+        dest="guessdays",
+        type=int,
+        default=21,
+        help="When guessing base, go back this many days from the patch date (default: 2 weeks)",
+    )
+    sp_am.add_argument(
+        "-3",
+        "--prep-3way",
+        dest="threeway",
+        action="store_true",
+        default=False,
+        help="Prepare for a 3-way merge "
+        "(tries to ensure that all index blobs exist by making a fake commit range)",
+    )
+    sp_am.add_argument(
+        "--no-cover",
+        dest="nocover",
+        action="store_true",
+        default=False,
+        help="Do not save the cover letter (on by default when using -o -)",
+    )
+    sp_am.add_argument(
+        "--no-partial-reroll",
+        dest="nopartialreroll",
+        action="store_true",
+        default=False,
+        help="Do not reroll partial series when detected",
+    )
     sp_am.set_defaults(func=cmd_am)
 
     # b4 shazam
-    sp_sh = subparsers.add_parser('shazam', help='Like b4 am, but applies the series to your tree')
+    sp_sh = subparsers.add_parser(
+        "shazam", help="Like b4 am, but applies the series to your tree"
+    )
     cmd_retrieval_common_opts(sp_sh)
     cmd_am_common_opts(sp_sh)
     sh_g = sp_sh.add_mutually_exclusive_group()
-    sh_g.add_argument('-H', '--make-fetch-head', dest='makefetchhead', action='store_true', default=False,
-                      help='Attempt to treat series as a pull request and fetch it into FETCH_HEAD')
-    sh_g.add_argument('-M', '--merge', dest='merge', action='store_true', default=False,
-                      help='Attempt to merge series as if it were a pull request (execs git-merge)')
-    sp_sh.add_argument('--guess-lookback', dest='guessdays', type=int, default=21,
-                       help=('(use with -H or -M) When guessing base, go back this many days from the patch date '
-                             '(default: 3 weeks)'))
-    sp_sh.add_argument('--merge-base', dest='mergebase', type=str, default=None,
-                       help='(use with -H or -M) Force this base when merging')
+    sh_g.add_argument(
+        "-H",
+        "--make-fetch-head",
+        dest="makefetchhead",
+        action="store_true",
+        default=False,
+        help="Attempt to treat series as a pull request and fetch it into FETCH_HEAD",
+    )
+    sh_g.add_argument(
+        "-M",
+        "--merge",
+        dest="merge",
+        action="store_true",
+        default=False,
+        help="Attempt to merge series as if it were a pull request (execs git-merge)",
+    )
+    sp_sh.add_argument(
+        "--guess-lookback",
+        dest="guessdays",
+        type=int,
+        default=21,
+        help=(
+            "(use with -H or -M) When guessing base, go back this many days from the patch date "
+            "(default: 3 weeks)"
+        ),
+    )
     sp_sh.set_defaults(func=cmd_shazam)
 
     # b4 pr
-    sp_pr = subparsers.add_parser('pr', help='Fetch a pull request found in a message ID')
-    sp_pr.add_argument('-g', '--gitdir', default=None,
-                       help='Operate on this git tree instead of current dir')
-    sp_pr.add_argument('-b', '--branch', default=None,
-                       help='Check out FETCH_HEAD into this branch after fetching')
-    sp_pr.add_argument('-c', '--check', action='store_true', default=False,
-                       help='Check if pull request has already been applied')
-    sp_pr.add_argument('-e', '--explode', action='store_true', default=False,
-                       help='Convert a pull request into an mbox full of patches')
-    sp_pr.add_argument('-o', '--output-mbox', dest='outmbox', default=None,
-                       help='Save exploded messages into this mailbox (default: msgid.mbx)')
-    sp_pr.add_argument('-l', '--retrieve-links', action='store_true', dest='getlinks', default=False,
-                       help='Attempt to retrieve any Link: URLs (use with -e)')
-    sp_pr.add_argument('-f', '--from-addr', dest='mailfrom', default=None,
-                       help='Use this From: in exploded messages (use with -e)')
-    sp_pr.add_argument('-s', '--send-as-identity', dest='sendidentity', default=None,
-                       help=('Use git-send-email to send exploded series (use with -e);'
-                             'the identity must match a [sendemail "identity"] config section'))
-    sp_pr.add_argument('--dry-run', dest='dryrun', action='store_true', default=False,
-                       help='Force a --dry-run on git-send-email invocation (use with -s)')
-    sp_pr.add_argument('msgid', nargs='?',
-                       help='Message ID to process, or pipe a raw message')
+    sp_pr = subparsers.add_parser(
+        "pr", help="Fetch a pull request found in a message ID"
+    )
+    sp_pr.add_argument(
+        "-g",
+        "--gitdir",
+        default=None,
+        help="Operate on this git tree instead of current dir",
+    )
+    sp_pr.add_argument(
+        "-b",
+        "--branch",
+        default=None,
+        help="Check out FETCH_HEAD into this branch after fetching",
+    )
+    sp_pr.add_argument(
+        "-c",
+        "--check",
+        action="store_true",
+        default=False,
+        help="Check if pull request has already been applied",
+    )
+    sp_pr.add_argument(
+        "-e",
+        "--explode",
+        action="store_true",
+        default=False,
+        help="Convert a pull request into an mbox full of patches",
+    )
+    sp_pr.add_argument(
+        "-o",
+        "--output-mbox",
+        dest="outmbox",
+        default=None,
+        help="Save exploded messages into this mailbox (default: msgid.mbx)",
+    )
+    sp_pr.add_argument(
+        "-l",
+        "--retrieve-links",
+        action="store_true",
+        dest="getlinks",
+        default=False,
+        help="Attempt to retrieve any Link: URLs (use with -e)",
+    )
+    sp_pr.add_argument(
+        "-f",
+        "--from-addr",
+        dest="mailfrom",
+        default=None,
+        help="Use this From: in exploded messages (use with -e)",
+    )
+    sp_pr.add_argument(
+        "-s",
+        "--send-as-identity",
+        dest="sendidentity",
+        default=None,
+        help=(
+            "Use git-send-email to send exploded series (use with -e);"
+            'the identity must match a [sendemail "identity"] config section'
+        ),
+    )
+    sp_pr.add_argument(
+        "--dry-run",
+        dest="dryrun",
+        action="store_true",
+        default=False,
+        help="Force a --dry-run on git-send-email invocation (use with -s)",
+    )
+    sp_pr.add_argument(
+        "msgid", nargs="?", help="Message ID to process, or pipe a raw message"
+    )
     sp_pr.set_defaults(func=cmd_pr)
 
     # b4 ty
-    sp_ty = subparsers.add_parser('ty', help='Generate thanks email when something gets merged/applied')
-    sp_ty.add_argument('-g', '--gitdir', default=None,
-                       help='Operate on this git tree instead of current dir')
-    sp_ty.add_argument('-o', '--outdir', default='.',
-                       help='Write thanks files into this dir (default=.)')
-    sp_ty.add_argument('-l', '--list', action='store_true', default=False,
-                       help='List pull requests and patch series you have retrieved')
-    sp_ty.add_argument('-t', '--thank-for', dest='thankfor', default=None,
-                       help='Generate thankyous for specific entries from -l (e.g.: 1,3-5,7-; or "all")')
-    sp_ty.add_argument('-d', '--discard', default=None,
-                       help='Discard specific messages from -l (e.g.: 1,3-5,7-; or "all")')
-    sp_ty.add_argument('-a', '--auto', action='store_true', default=False,
-                       help='Use the Auto-Thankanator to figure out what got applied/merged')
-    sp_ty.add_argument('-b', '--branch', default=None,
-                       help='The branch to check against, instead of current')
-    sp_ty.add_argument('--since', default='1.week',
-                       help='The --since option to use when auto-matching patches (default=1.week)')
-    sp_ty.add_argument('-S', '--send-email', action='store_true', dest='sendemail', default=False,
-                       help='Send email instead of writing out .thanks files')
-    sp_ty.add_argument('--dry-run', action='store_true', dest='dryrun', default=False,
-                       help='Print out emails instead of sending them')
-    sp_ty.add_argument('--pw-set-state', default=None,
-                       help='Set this patchwork state instead of default (use with -a, -t or -d)')
+    sp_ty = subparsers.add_parser(
+        "ty", help="Generate thanks email when something gets merged/applied"
+    )
+    sp_ty.add_argument(
+        "-g",
+        "--gitdir",
+        default=None,
+        help="Operate on this git tree instead of current dir",
+    )
+    sp_ty.add_argument(
+        "-o",
+        "--outdir",
+        default=".",
+        help="Write thanks files into this dir (default=.)",
+    )
+    sp_ty.add_argument(
+        "-l",
+        "--list",
+        action="store_true",
+        default=False,
+        help="List pull requests and patch series you have retrieved",
+    )
+    sp_ty.add_argument(
+        "-t",
+        "--thank-for",
+        dest="thankfor",
+        default=None,
+        help='Generate thankyous for specific entries from -l (e.g.: 1,3-5,7-; or "all")',
+    )
+    sp_ty.add_argument(
+        "-d",
+        "--discard",
+        default=None,
+        help='Discard specific messages from -l (e.g.: 1,3-5,7-; or "all")',
+    )
+    sp_ty.add_argument(
+        "-a",
+        "--auto",
+        action="store_true",
+        default=False,
+        help="Use the Auto-Thankanator to figure out what got applied/merged",
+    )
+    sp_ty.add_argument(
+        "-b",
+        "--branch",
+        default=None,
+        help="The branch to check against, instead of current",
+    )
+    sp_ty.add_argument(
+        "--since",
+        default="1.week",
+        help="The --since option to use when auto-matching patches (default=1.week)",
+    )
+    sp_ty.add_argument(
+        "-S",
+        "--send-email",
+        action="store_true",
+        dest="sendemail",
+        default=False,
+        help="Send email instead of writing out .thanks files",
+    )
+    sp_ty.add_argument(
+        "--dry-run",
+        action="store_true",
+        dest="dryrun",
+        default=False,
+        help="Print out emails instead of sending them",
+    )
+    sp_ty.add_argument(
+        "--pw-set-state",
+        default=None,
+        help="Set this patchwork state instead of default (use with -a, -t or -d)",
+    )
     sp_ty.set_defaults(func=cmd_ty)
 
     # b4 diff
-    sp_diff = subparsers.add_parser('diff', help='Show a range-diff to previous series revision')
-    sp_diff.add_argument('msgid', nargs='?',
-                         help='Message ID to process, or pipe a raw message')
-    sp_diff.add_argument('-g', '--gitdir', default=None,
-                         help='Operate on this git tree instead of current dir')
-    sp_diff.add_argument('-C', '--no-cache', dest='nocache', action='store_true', default=False,
-                         help='Do not use local cache')
-    sp_diff.add_argument('-v', '--compare-versions', dest='wantvers', type=int, default=None, nargs='+',
-                         help='Compare specific versions instead of latest and one before that, e.g. -v 3 5')
-    sp_diff.add_argument('-n', '--no-diff', dest='nodiff', action='store_true', default=False,
-                         help='Do not generate a diff, just show the command to do it')
-    sp_diff.add_argument('-o', '--output-diff', dest='outdiff', default=None,
-                         help='Save diff into this file instead of outputting to stdout')
-    sp_diff.add_argument('-c', '--color', dest='color', action='store_true', default=False,
-                         help='Force color output even when writing to file')
-    sp_diff.add_argument('-m', '--compare-am-mboxes', dest='ambox', nargs=2, default=None,
-                         help='Compare two mbx files prepared with "b4 am"')
+    sp_diff = subparsers.add_parser(
+        "diff", help="Show a range-diff to previous series revision"
+    )
+    sp_diff.add_argument(
+        "msgid", nargs="?", help="Message ID to process, or pipe a raw message"
+    )
+    sp_diff.add_argument(
+        "-g",
+        "--gitdir",
+        default=None,
+        help="Operate on this git tree instead of current dir",
+    )
+    sp_diff.add_argument(
+        "-C",
+        "--no-cache",
+        dest="nocache",
+        action="store_true",
+        default=False,
+        help="Do not use local cache",
+    )
+    sp_diff.add_argument(
+        "-v",
+        "--compare-versions",
+        dest="wantvers",
+        type=int,
+        default=None,
+        nargs="+",
+        help="Compare specific versions instead of latest and one before that, e.g. -v 3 5",
+    )
+    sp_diff.add_argument(
+        "-n",
+        "--no-diff",
+        dest="nodiff",
+        action="store_true",
+        default=False,
+        help="Do not generate a diff, just show the command to do it",
+    )
+    sp_diff.add_argument(
+        "-o",
+        "--output-diff",
+        dest="outdiff",
+        default=None,
+        help="Save diff into this file instead of outputting to stdout",
+    )
+    sp_diff.add_argument(
+        "-c",
+        "--color",
+        dest="color",
+        action="store_true",
+        default=False,
+        help="Force color output even when writing to file",
+    )
+    sp_diff.add_argument(
+        "-m",
+        "--compare-am-mboxes",
+        dest="ambox",
+        nargs=2,
+        default=None,
+        help='Compare two mbx files prepared with "b4 am"',
+    )
     sp_diff.set_defaults(func=cmd_diff)
 
     # b4 kr
-    sp_kr = subparsers.add_parser('kr', help='Keyring operations')
+    sp_kr = subparsers.add_parser("kr", help="Keyring operations")
     cmd_retrieval_common_opts(sp_kr)
-    sp_kr.add_argument('--show-keys', dest='showkeys', action='store_true', default=False,
-                       help='Show all developer keys found in a thread')
+    sp_kr.add_argument(
+        "--show-keys",
+        dest="showkeys",
+        action="store_true",
+        default=False,
+        help="Show all developer keys found in a thread",
+    )
     sp_kr.set_defaults(func=cmd_kr)
 
     # b4 prep
-    sp_prep = subparsers.add_parser('prep', help='Work on patch series to submit for mailing list review')
-    sp_prep.add_argument('-c', '--auto-to-cc', action='store_true', default=False,
-                         help='Automatically populate cover letter trailers with To and Cc addresses')
-    sp_prep.add_argument('--force-revision', metavar='N', type=int,
-                         help='Force revision to be this number instead')
-    sp_prep.add_argument('--set-prefixes', metavar='PREFIX', nargs='+',
-                         help='Extra prefixes to add to [PATCH] (e.g.: RFC mydrv)')
+    sp_prep = subparsers.add_parser(
+        "prep", help="Work on patch series to submit for mailing list review"
+    )
+    sp_prep.add_argument(
+        "-c",
+        "--auto-to-cc",
+        action="store_true",
+        default=False,
+        help="Automatically populate cover letter trailers with To and Cc addresses",
+    )
+    sp_prep.add_argument(
+        "--force-revision",
+        metavar="N",
+        type=int,
+        help="Force revision to be this number instead",
+    )
+    sp_prep.add_argument(
+        "--set-prefixes",
+        metavar="PREFIX",
+        nargs="+",
+        help="Extra prefixes to add to [PATCH] (e.g.: RFC mydrv)",
+    )
 
     spp_g = sp_prep.add_mutually_exclusive_group()
-    spp_g.add_argument('-p', '--format-patch', metavar='OUTPUT_DIR',
-                       help='Output prep-tracked commits as patches')
-    spp_g.add_argument('--edit-cover', action='store_true', default=False,
-                       help='Edit the cover letter in your defined $EDITOR (or core.editor)')
-    spp_g.add_argument('--show-revision', action='store_true', default=False,
-                       help='Show current series revision number')
-    spp_g.add_argument('--compare-to', metavar='vN',
-                       help='Display a range-diff to previously sent revision N')
-    spp_g.add_argument('--manual-reroll', dest='reroll', default=None, metavar='COVER_MSGID',
-                       help='Mark current revision as sent and reroll (requires cover letter msgid)')
-    spp_g.add_argument('--show-info', metavar='PARAM', nargs='?', const=':_all',
-                       help='Show series info in a format that can be passed to other commands.')
-    spp_g.add_argument('--cleanup', metavar='BRANCHNAME', nargs='?', const='_show',
-                       help='Archive and remove a prep-tracked branch and all its sent/ tags')
+    spp_g.add_argument(
+        "-p",
+        "--format-patch",
+        metavar="OUTPUT_DIR",
+        help="Output prep-tracked commits as patches",
+    )
+    spp_g.add_argument(
+        "--edit-cover",
+        action="store_true",
+        default=False,
+        help="Edit the cover letter in your defined $EDITOR (or core.editor)",
+    )
+    spp_g.add_argument(
+        "--show-revision",
+        action="store_true",
+        default=False,
+        help="Show current series revision number",
+    )
+    spp_g.add_argument(
+        "--compare-to",
+        metavar="vN",
+        help="Display a range-diff to previously sent revision N",
+    )
+    spp_g.add_argument(
+        "--manual-reroll",
+        dest="reroll",
+        default=None,
+        metavar="COVER_MSGID",
+        help="Mark current revision as sent and reroll (requires cover letter msgid)",
+    )
+    spp_g.add_argument(
+        "--show-info",
+        action="store_true",
+        default=False,
+        help="Show current series info in a column-parseable format",
+    )
     spp_g.add_argument(
         "--check",
         action="store_true",
@@ -290,54 +670,138 @@
         help="Run ./scripts/checkpatch.pl on your entire patch series",
     )
 
-    ag_prepn = sp_prep.add_argument_group('Create new branch', 'Create a new branch for working on patch series')
-    ag_prepn.add_argument('-n', '--new', dest='new_series_name',
-                          help='Create a new branch for working on a patch series')
-    ag_prepn.add_argument('-f', '--fork-point', dest='fork_point',
-                          help='When creating a new branch, use this fork point instead of HEAD')
-    ag_prepn.add_argument('-F', '--from-thread', metavar='MSGID', dest='msgid',
-                          help='When creating a new branch, use this thread')
-    ag_prepe = sp_prep.add_argument_group('Enroll existing branch', 'Enroll existing branch for prep work')
-    ag_prepe.add_argument('-e', '--enroll', dest='enroll_base', nargs='?', const='@{upstream}',
-                          help='Enroll current branch, using its configured upstream branch as fork base, or the passed tag, branch, or commit')
+    ag_prepn = sp_prep.add_argument_group(
+        "Create new branch", "Create a new branch for working on patch series"
+    )
+    ag_prepn.add_argument(
+        "-n",
+        "--new",
+        dest="new_series_name",
+        help="Create a new branch for working on a patch series",
+    )
+    ag_prepn.add_argument(
+        "-f",
+        "--fork-point",
+        dest="fork_point",
+        help="When creating a new branch, use this fork point instead of HEAD",
+    )
+    ag_prepn.add_argument(
+        "-F",
+        "--from-thread",
+        metavar="MSGID",
+        dest="msgid",
+        help="When creating a new branch, use this thread",
+    )
+    ag_prepe = sp_prep.add_argument_group(
+        "Enroll existing branch", "Enroll existing branch for prep work"
+    )
+    ag_prepe.add_argument(
+        "-e",
+        "--enroll",
+        dest="enroll_base",
+        help="Enroll current branch, using the passed tag, branch, or commit as fork base",
+    )
     sp_prep.set_defaults(func=cmd_prep)
 
     # b4 trailers
-    sp_trl = subparsers.add_parser('trailers', help='Operate on trailers received for mailing list reviews')
-    sp_trl.add_argument('-u', '--update', action='store_true', default=False,
-                        help='Update branch commits with latest received trailers')
-    sp_trl.add_argument('-S', '--sloppy-trailers', dest='sloppytrailers', action='store_true', default=False,
-                        help='Apply trailers without email address match checking')
-    sp_trl.add_argument('-F', '--trailers-from', dest='trailers_from',
-                        help='Look for trailers in the thread with this msgid instead of using the series change-id')
-    sp_trl.add_argument('--since', default='1.month',
-                        help='The --since option to use with -F when auto-matching patches (default=1.month)')
+    sp_trl = subparsers.add_parser(
+        "trailers", help="Operate on trailers received for mailing list reviews"
+    )
+    sp_trl.add_argument(
+        "-u",
+        "--update",
+        action="store_true",
+        default=False,
+        help="Update branch commits with latest received trailers",
+    )
+    sp_trl.add_argument(
+        "-S",
+        "--sloppy-trailers",
+        dest="sloppytrailers",
+        action="store_true",
+        default=False,
+        help="Apply trailers without email address match checking",
+    )
+    sp_trl.add_argument(
+        "-F",
+        "--trailers-from",
+        dest="trailers_from",
+        help="Look for trailers in the thread with this msgid instead of using the series change-id",
+    )
+    sp_trl.add_argument(
+        "--since",
+        default="1.month",
+        help="The --since option to use with -F when auto-matching patches (default=1.month)",
+    )
     cmd_retrieval_common_opts(sp_trl)
     sp_trl.set_defaults(func=cmd_trailers)
 
     # b4 send
-    sp_send = subparsers.add_parser('send', help='Submit your work for review on the mailing lists')
-    sp_send.add_argument('-d', '--dry-run', dest='dryrun', action='store_true', default=False,
-                         help='Do not send, just dump out raw smtp messages to the stdout')
-    sp_send.add_argument('-o', '--output-dir',
-                         help='Do not send, write raw messages to this directory (forces --dry-run)')
-    sp_send.add_argument('--reflect', action='store_true', default=False,
-                         help='Send everything to yourself instead of the actual recipients')
-    sp_send.add_argument('--no-trailer-to-cc', action='store_true', default=False,
-                         help='Do not add any addresses found in the cover or patch trailers to To: or Cc:')
-    sp_send.add_argument('--to', nargs='+', help='Addresses to add to the To: list')
-    sp_send.add_argument('--cc', nargs='+', help='Addresses to add to the Cc: list')
-    sp_send.add_argument('--not-me-too', action='store_true', default=False,
-                         help='Remove yourself from the To: or Cc: list')
-    sp_send.add_argument('--resend', metavar='vN', nargs='?', const='latest',
-                         help='Resend a previously sent version of the series')
-    sp_send.add_argument('--no-sign', action='store_true', default=False,
-                         help='Do not add the cryptographic attestation signature header')
-    ag_sendh = sp_send.add_argument_group('Web submission', 'Authenticate with the web submission endpoint')
-    ag_sendh.add_argument('--web-auth-new', dest='auth_new', action='store_true', default=False,
-                          help='Initiate a new web authentication request')
-    ag_sendh.add_argument('--web-auth-verify', dest='auth_verify', metavar='VERIFY_TOKEN',
-                          help='Submit the token received via verification email')
+    sp_send = subparsers.add_parser(
+        "send", help="Submit your work for review on the mailing lists"
+    )
+    sp_send.add_argument(
+        "-d",
+        "--dry-run",
+        dest="dryrun",
+        action="store_true",
+        default=False,
+        help="Do not send, just dump out raw smtp messages to the stdout",
+    )
+    sp_send.add_argument(
+        "-o",
+        "--output-dir",
+        help="Do not send, write raw messages to this directory (forces --dry-run)",
+    )
+    sp_send.add_argument(
+        "--reflect",
+        action="store_true",
+        default=False,
+        help="Send everything to yourself instead of the actual recipients",
+    )
+    sp_send.add_argument(
+        "--no-trailer-to-cc",
+        action="store_true",
+        default=False,
+        help="Do not add any addresses found in the cover or patch trailers to To: or Cc:",
+    )
+    sp_send.add_argument("--to", nargs="+", help="Addresses to add to the To: list")
+    sp_send.add_argument("--cc", nargs="+", help="Addresses to add to the Cc: list")
+    sp_send.add_argument(
+        "--not-me-too",
+        action="store_true",
+        default=False,
+        help="Remove yourself from the To: or Cc: list",
+    )
+    sp_send.add_argument(
+        "--resend",
+        metavar="vN",
+        nargs="?",
+        const="latest",
+        help="Resend a previously sent version of the series",
+    )
+    sp_send.add_argument(
+        "--no-sign",
+        action="store_true",
+        default=False,
+        help="Do not add the cryptographic attestation signature header",
+    )
+    ag_sendh = sp_send.add_argument_group(
+        "Web submission", "Authenticate with the web submission endpoint"
+    )
+    ag_sendh.add_argument(
+        "--web-auth-new",
+        dest="auth_new",
+        action="store_true",
+        default=False,
+        help="Initiate a new web authentication request",
+    )
+    ag_sendh.add_argument(
+        "--web-auth-verify",
+        dest="auth_verify",
+        metavar="VERIFY_TOKEN",
+        help="Submit the token received via verification email",
+    )
     sp_send.set_defaults(func=cmd_send)
 
     return parser
@@ -349,7 +813,7 @@
     logger.setLevel(logging.DEBUG)
 
     ch = logging.StreamHandler()
-    formatter = logging.Formatter('%(message)s')
+    formatter = logging.Formatter("%(message)s")
     ch.setFormatter(formatter)
 
     if cmdargs.quiet:
@@ -361,28 +825,29 @@
 
     logger.addHandler(ch)
 
-    if 'func' not in cmdargs:
+    if "func" not in cmdargs:
         parser.print_help()
         sys.exit(1)
 
     if cmdargs.offline_mode:
-        logger.info('Running in OFFLINE mode')
+        logger.info("Running in OFFLINE mode")
         b4.can_network = False
 
     cmdargs.func(cmdargs)
 
 
-if __name__ == '__main__':
+if __name__ == "__main__":
     # We're running from a checkout, so reflect git commit in the version
     import os
+
     # noinspection PyBroadException
     try:
-        if b4.__VERSION__.find('-dev') > 0:
+        if b4.__VERSION__.find("-dev") > 0:
             base = os.path.dirname(os.path.dirname(os.path.realpath(__file__)))
-            dotgit = os.path.join(base, '.git')
-            ecode, short = b4.git_run_command(dotgit, ['rev-parse', '--short', 'HEAD'])
+            dotgit = os.path.join(base, ".git")
+            ecode, short = b4.git_run_command(dotgit, ["rev-parse", "--short", "HEAD"])
             if ecode == 0:
-                b4.__VERSION__ = '%s-%.5s' % (b4.__VERSION__, short.strip())
+                b4.__VERSION__ = "%s-%.5s" % (b4.__VERSION__, short.strip())
     except Exception as ex:
         # Any failures above are non-fatal
         pass
diff --color -Naur /usr/local/google/home/justinstitt/repos/b4/b4/ez.py /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/ez.py
--- /usr/local/google/home/justinstitt/repos/b4/b4/ez.py	2023-08-03 22:45:55.036919619 +0000
+++ /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/ez.py	2023-08-08 21:08:20.661113936 +0000
@@ -24,10 +24,9 @@
 import textwrap
 import gzip
 import io
-import tarfile
 
-from email import utils
 from typing import Optional, Tuple, List, Union
+from email import utils
 from string import Template
 from pathlib import Path
 
@@ -63,7 +62,7 @@
 change-id: ${change_id}
 
 Best regards,
--- 
+--
 ${signature}
 """
 
@@ -374,23 +373,14 @@
         seriesname = branchname
         slug = re.sub(r'\W+', '-', branchname).strip('-').lower()
         enroll_base = cmdargs.enroll_base
-        # Convert @{upstream}, @{push} to an abbreviated ref
-        gitargs = ['rev-parse', '--abbrev-ref', '--verify', enroll_base]
-        ecode, out = b4.git_run_command(None, gitargs)
-        if ecode > 0:
-            if enroll_base == '@{upstream}' or enroll_base == '@{u}':
-                logger.critical('CRITICAL: current branch has no configured upstream')
-                sys.exit(1)
-        elif out:
-            enroll_base = out.strip()
         # Is it a branch?
-        gitargs = ['show-ref', f'refs/heads/{enroll_base}', f'refs/remotes/{enroll_base}']
+        gitargs = ['show-ref', '--heads', enroll_base]
         lines = b4.git_get_command_lines(None, gitargs)
         if lines:
             try:
                 forkpoint = get_base_forkpoint(enroll_base, mybranch)
             except RuntimeError as ex:
-                logger.critical('CRITICAL: could not use %s as enrollment base:', enroll_base)
+                logger.critical('CRITICAL: could not use %s as enrollment base:')
                 logger.critical('          %s', ex)
                 sys.exit(1)
             basebranch = enroll_base
@@ -403,7 +393,7 @@
                 raise RuntimeError('Object %s not found' % enroll_base)
             forkpoint = out.strip()
             # check branches where this object lives
-            heads = b4.git_branch_contains(None, forkpoint, checkall=True)
+            heads = b4.git_branch_contains(None, forkpoint)
             if mybranch not in heads:
                 logger.critical('CRITICAL: object %s does not exist on current branch', enroll_base)
                 sys.exit(1)
@@ -546,10 +536,10 @@
     return mj + json.dumps(data, indent=2)
 
 
-def load_cover(strip_comments: bool = False, usebranch: Optional[str] = None) -> Tuple[str, dict]:
-    strategy = get_cover_strategy(usebranch)
+def load_cover(strip_comments: bool = False) -> Tuple[str, dict]:
+    strategy = get_cover_strategy()
     if strategy in {'commit', 'tip-commit'}:
-        cover_commit = find_cover_commit(usebranch=usebranch)
+        cover_commit = find_cover_commit()
         if not cover_commit:
             cover = ''
             tracking = dict()
@@ -627,10 +617,8 @@
 # 'tip-merge': in an empty merge commit at the tip of the branch : TODO
 #              (once/if git upstream properly supports it)
 
-def get_cover_strategy(usebranch: Optional[str] = None) -> str:
-    if usebranch:
-        branch = usebranch
-    else:
+def get_cover_strategy(branch: Optional[str] = None) -> str:
+    if branch is None:
         branch = b4.git_get_current_branch()
     # Check local branch config for the strategy
     bconfig = b4.get_config_from_git(rf'branch\.{branch}\..*')
@@ -648,15 +636,12 @@
     sys.exit(1)
 
 
-def is_prep_branch(mustbe: bool = False, usebranch: Optional[str] = None) -> bool:
+def is_prep_branch(mustbe: bool = False) -> bool:
     mustmsg = 'CRITICAL: This is not a prep-managed branch.'
-    if usebranch:
-        mybranch = usebranch
-    else:
-        mybranch = b4.git_get_current_branch()
+    mybranch = b4.git_get_current_branch()
     strategy = get_cover_strategy(mybranch)
     if strategy in {'commit', 'tip-commit'}:
-        if find_cover_commit(usebranch=mybranch) is None:
+        if find_cover_commit() is None:
             if mustbe:
                 logger.critical(mustmsg)
                 sys.exit(1)
@@ -676,14 +661,11 @@
     sys.exit(1)
 
 
-def find_cover_commit(usebranch: Optional[str] = None) -> Optional[str]:
+def find_cover_commit() -> Optional[str]:
     # Walk back commits until we find the cover letter
     # Our covers always contain the MAGIC_MARKER line
     logger.debug('Looking for the cover letter commit with magic marker "%s"', MAGIC_MARKER)
-    if not usebranch:
-        usebranch = b4.git_get_current_branch()
-    gitargs = ['log', '--grep', MAGIC_MARKER, '-F', '--pretty=oneline', '--max-count=1', '--since=1.year',
-               usebranch]
+    gitargs = ['log', '--grep', MAGIC_MARKER, '-F', '--pretty=oneline', '--max-count=1', '--since=1.year']
     lines = b4.git_get_command_lines(None, gitargs)
     if not lines:
         return None
@@ -710,16 +692,25 @@
 
 
 def edit_cover() -> None:
+    from re import sub
     cover, tracking = load_cover()
     # What's our editor? And yes, the default is vi, bite me.
     corecfg = b4.get_config_from_git(r'core\..*', {'editor': os.environ.get('EDITOR', 'vi')})
     editor = corecfg.get('editor')
     logger.debug('editor=%s', editor)
+    previous_revision = max(tracking['series']['revision'] - 1, 1)
+    diff_prev_revision = compare(compareto=str(previous_revision), get_output=True).split('\n')
+    diff_prev_revision = '\n'.join(['# ' + line for line in diff_prev_revision])
+    diff_revision_sep = '######'
+    diff_revision_patt = r'######(.|\n)*'
     # Use COMMIT_EDITMSG name in hopes that editors autoload git commit rules
     with tempfile.TemporaryDirectory(prefix='b4-') as temp_dir:
         temp_fpath = os.path.join(temp_dir, 'COMMIT_EDITMSG')
-        with open(temp_fpath, 'xb') as temp_cover:
+        with open(temp_fpath, 'ab') as temp_cover:
             temp_cover.write(cover.encode())
+            temp_cover.write(b'\n' + diff_revision_sep.encode())
+            temp_cover.write(b'\n')
+            temp_cover.write(diff_prev_revision.encode())
 
         sp = shlex.shlex(editor, posix=True)
         sp.whitespace_split = True
@@ -730,6 +721,7 @@
 
         with open(temp_fpath, 'rb') as temp_cover:
             new_cover = temp_cover.read().decode(errors='replace').strip()
+            new_cover = sub(diff_revision_patt, '', new_cover)
 
     if new_cover == cover:
         logger.info('Cover letter unchanged.')
@@ -742,17 +734,14 @@
     logger.info('Cover letter updated.')
 
 
-def get_series_start(usebranch: Optional[str] = None) -> str:
-    if usebranch:
-        mybranch = usebranch
-    else:
-        mybranch = b4.git_get_current_branch()
-    strategy = get_cover_strategy(usebranch=mybranch)
+def get_series_start() -> str:
+    strategy = get_cover_strategy()
     forkpoint = None
     if strategy == 'commit':
         # Easy, we start at the cover letter commit
-        return find_cover_commit(usebranch=mybranch)
+        return find_cover_commit()
     if strategy == 'branch-description':
+        mybranch = b4.git_get_current_branch()
         bcfg = b4.get_config_from_git(rf'branch\.{mybranch}\..*')
         tracking = bcfg.get('b4-tracking')
         if not tracking:
@@ -767,7 +756,7 @@
             sys.exit(1)
         logger.debug('series_start: %s, commitcount=%s', forkpoint, commitcount)
     if strategy == 'tip-commit':
-        cover, tracking = load_cover(usebranch=mybranch)
+        cover, tracking = load_cover()
         basebranch = tracking['series']['base-branch']
         try:
             forkpoint = get_base_forkpoint(basebranch)
@@ -965,23 +954,18 @@
     ecode, out, err = b4._run_command(cmdargs, stdin=msgbytes, rundir=topdir)  # noqa
     if ecode > 0:
         logger.critical('CRITICAL: Running %s failed:', ' '.join(cmdargs))
-        logger.critical(err.decode(errors='ignore'))
+        logger.critical(err.decode())
         raise RuntimeError('Running command failed: %s' % ' '.join(cmdargs))
-    addrs = out.strip().decode(errors='ignore')
+    addrs = out.strip().decode()
     if not addrs:
         return list()
     return utils.getaddresses(addrs.split('\n'))
 
 
-def get_series_details(start_commit: Optional[str] = None, usebranch: Optional[str] = None
-                       ) -> Tuple[str, str, str, List[str], str, str]:
-    if usebranch:
-        mybranch = usebranch
-    else:
-        mybranch = b4.git_get_current_branch()
+def get_series_details(start_commit: Optional[str] = None) -> Tuple[str, str, str, List[str], str, str]:
     if not start_commit:
-        start_commit = get_series_start(usebranch=mybranch)
-    strategy = get_cover_strategy(usebranch=mybranch)
+        start_commit = get_series_start()
+    strategy = get_cover_strategy()
     if strategy == 'commit':
         gitargs = ['rev-parse', f'{start_commit}~1']
         lines = b4.git_get_command_lines(None, gitargs)
@@ -989,10 +973,10 @@
     else:
         base_commit = start_commit
     if strategy == 'tip-commit':
-        cover_commit = find_cover_commit(usebranch=mybranch)
+        cover_commit = find_cover_commit()
         endrange = b4.git_revparse_obj(f'{cover_commit}~1')
     else:
-        endrange = b4.git_revparse_obj(mybranch)
+        endrange = b4.git_revparse_obj('HEAD')
     gitargs = ['shortlog', f'{start_commit}..{endrange}']
     ecode, shortlog = b4.git_run_command(None, gitargs)
     gitargs = ['diff', '--stat', f'{start_commit}..{endrange}']
@@ -1153,7 +1137,7 @@
 
 
 def rethread(patches: List[Tuple[str, email.message.Message]]):
-    refto = patches[0][1].get('message-id')
+    refto  = patches[0][1].get('message-id')
     for commit, msg in patches[1:]:
         msg.add_header('References', refto)
         msg.add_header('In-Reply-To', refto)
@@ -1243,21 +1227,11 @@
     if addtracking:
         patches[0][1].add_header('X-B4-Tracking', thdata)
 
-    samethread = config.get('send-same-thread', '').lower() in {'yes', 'true', 'y'}
-    if samethread and revision > 1:
-        oldrev = revision - 1
-        voldrev = f'v{oldrev}'
-        try:
-            oldmsgid = tracking['series']['history'][voldrev][-1]
-            patches[0][1].add_header('In-Reply-To', f'<{oldmsgid}>')
-            patches[0][1].add_header('References', f'<{oldmsgid}>')
-        except (KeyError, IndexError):
-            logger.debug('Could not find previous series msgid, skipping %s', voldrev)
-
     header = csubject.full_subject
     if prefixes:
         header = '[' + ', '.join(prefixes) + f'] {header}'
     tag_msg = f'{header}\n\n{cover_letter}'
+
     return alltos, allccs, tag_msg, patches
 
 
@@ -1322,24 +1296,19 @@
 
     tag_msg = None
     cl_msgid = None
-    cover, tracking = load_cover(strip_comments=True)
     if cmdargs.resend:
         if cmdargs.resend == 'latest':
+            cover, tracking = load_cover()
             revstr = tracking['series']['revision'] - 1
         else:
             revstr = cmdargs.resend
 
-        # Start with full change-id based tag name
-        tagname, revision = get_sent_tagname(tracking['series']['change-id'], SENT_TAG_PREFIX, revstr)
+        tagname, revision = get_sent_tagname(mybranch, SENT_TAG_PREFIX, revstr)
 
         if revision is None:
             logger.critical('Could not figure out revision from %s', revstr)
             sys.exit(1)
 
-        if not b4.git_revparse_tag(None, tagname):
-            # Try initial branch-name only based version
-            tagname, revision = get_sent_tagname(mybranch, SENT_TAG_PREFIX, revstr)
-
         try:
             todests, ccdests, patches = get_sent_tag_as_patches(tagname, revision=revision)
         except RuntimeError as ex:
@@ -1349,6 +1318,7 @@
         logger.info('Converted the tag to %s messages', len(patches))
 
     else:
+        cover, tracking = load_cover(strip_comments=True)
         status = b4.git_get_repo_status()
         if len(status):
             logger.critical('CRITICAL: Repository contains uncommitted changes.')
@@ -1460,8 +1430,10 @@
         pathlib.Path(cmdargs.output_dir).mkdir(parents=True, exist_ok=True)
 
     sconfig = b4.get_sendemail_config()
+    # If we have an smtp server defined, always use that instead of the endpoint
+    # we may make this configurable in the future, but this almost always makes sense
     endpoint = None
-    if not sconfig.get('smtpserver') or cmdargs.send_web:
+    if not sconfig.get('smtpserver'):
         endpoint = config.get('send-endpoint-web', '')
         if not re.search(r'^https?://', endpoint):
             logger.debug('Endpoint does not start with https, ignoring: %s', endpoint)
@@ -1595,7 +1567,7 @@
                 msg.add_header('Cc', b4.format_addrs(pcc))
 
         send_msgs.append(msg)
-
+    subj='dummy'
     if endpoint:
         # Web endpoint always requires signing
         if not sign:
@@ -1619,7 +1591,7 @@
             sys.exit(1)
 
         try:
-            sent = b4.send_mail(smtp, send_msgs, fromaddr=fromaddr, patatt_sign=sign,
+            sent, subj = b4.send_mail(smtp, send_msgs, fromaddr=fromaddr, patatt_sign=sign,
                                 dryrun=cmdargs.dryrun, output_dir=cmdargs.output_dir,
                                 reflect=cmdargs.reflect)
         except RuntimeError as ex:
@@ -1645,10 +1617,10 @@
         logger.debug('Not updating cover/tracking on resend')
         return
 
-    reroll(mybranch, tag_msg, cl_msgid)
+    reroll(mybranch, tag_msg, cl_msgid, subj=subj)
 
 
-def get_sent_tagname(tagbase: str, tagprefix: str, revstr: Union[str, int]) -> Tuple[str, Optional[int]]:
+def get_sent_tagname(branch: str, tagprefix: str, revstr: Union[str, int]) -> Tuple[str, Optional[int]]:
     revision = None
     try:
         revision = int(revstr)
@@ -1662,12 +1634,12 @@
             return revstr.replace('refs/tags/', ''), revision
         revision = int(matches.groups()[0])
 
-    if tagbase.startswith('b4/'):
-        return f'{tagprefix}{tagbase[3:]}-v{revision}', revision
-    return f'{tagprefix}{tagbase}-v{revision}', revision
+    if branch.startswith('b4/'):
+        return f'{tagprefix}{branch[3:]}-v{revision}', revision
+    return f'{tagprefix}{branch}-v{revision}', revision
 
 
-def reroll(mybranch: str, tag_msg: str, msgid: str, tagprefix: str = SENT_TAG_PREFIX):
+def reroll(mybranch: str, tag_msg: str, msgid: str, tagprefix: str = SENT_TAG_PREFIX, subj: str=""):
     # Remove signature
     chunks = tag_msg.rsplit('\n-- \n')
     if len(chunks) > 1:
@@ -1675,11 +1647,12 @@
 
     cover, tracking = load_cover(strip_comments=True)
     revision = tracking['series']['revision']
-    change_id = tracking['series']['change-id']
-
-    tagname, revision = get_sent_tagname(change_id, tagprefix, revision)
+    print(f"DEBUG: {mybranch=}")
+    tagname, revision = get_sent_tagname(mybranch, tagprefix, revision)
     logger.debug('checking if we already have %s', tagname)
-    if not b4.git_revparse_tag(None, tagname):
+    gitargs = ['rev-parse', f'refs/tags/{tagname}']
+    ecode, out = b4.git_run_command(None, gitargs)
+    if ecode > 0:
         try:
             strategy = get_cover_strategy()
             if strategy == 'commit':
@@ -1754,6 +1727,8 @@
         'newrev': newrev,
         'oldrev_link': oldrev_link,
     }
+    print("Markdown Link:\n\033[96m[{}]({})\033[0m".format(subj, oldrev_link)) #]]
+
     prepend = Template(DEFAULT_CHANGELOG_TEMPLATE.lstrip()).safe_substitute(tptvals)
     found = False
     new_sections = list()
@@ -1794,221 +1769,38 @@
                 logger.info('  %s: %s', rn, config['linkmask'] % link)
 
 
-def write_to_tar(bio_tar: tarfile.TarFile, name, mtime, bio_file: io.BytesIO):
-    tifo = tarfile.TarInfo(name)
-    tuser = os.getlogin()
-    tuid = os.getuid()
-    tgid = os.getgid()
-    tifo.uid = tuid
-    tifo.gid = tgid
-    tifo.uname = tuser
-    tifo.gname = tuser
-    tifo.mtime = mtime
-    tifo.size = bio_file.tell()
-    bio_file.seek(0)
-    bio_tar.addfile(tifo, bio_file)
-
-
-def cleanup(param: str) -> None:
-    if param == '_show':
-        # Show all b4-tracked branches
-        lines = b4.git_get_command_lines(None, ['show-ref', '--heads'])
-        if not lines:
-            logger.critical('Git show-ref returned no heads')
-            sys.exit(1)
-        mybranches = list()
-        for line in lines:
-            parts = line.split(maxsplit=1)
-            if parts[1].startswith('refs/heads/b4/'):
-                mybranches.append(parts[1].replace('refs/heads/', ''))
-        if not len(mybranches):
-            logger.info('No b4-tracked branches found')
-            sys.exit(0)
-
-        logger.info('Please specify branch:')
-        for branch in mybranches:
-            logger.info(' %s', branch)
-        return
-
-    mybranch = param
-    if not b4.git_branch_exists(None, mybranch):
-        logger.critical('Not a known branch: %s', mybranch)
-        sys.exit(1)
-    is_prep_branch(mustbe=True, usebranch=mybranch)
-    base_commit, start_commit, end_commit, oneline, shortlog, diffstat = get_series_details(usebranch=mybranch)
-    # start commit and end commit can't be the same
-    if start_commit == end_commit:
-        logger.critical('CRITICAL: %s appears to be an empty branch', mybranch)
-        sys.exit(1)
-    # Refuse to clean up the currently checked out branch
-    curbranch = b4.git_get_current_branch()
-    if curbranch == mybranch:
-        logger.critical('CRITICAL: %s is currently checked out, cannot cleanup', mybranch)
-        sys.exit(1)
-    cover, tracking = load_cover(usebranch=mybranch)
-    # Find all tags
-    ts = tracking['series']
-    tags = list()
-    logger.info('Will archive and delete all of the following:')
-    logger.info('---')
-    logger.info('branch: %s', mybranch)
-    if 'history' in ts:
-        for rn, links in ts['history'].items():
-            tagname, revision = get_sent_tagname(ts.get('change-id'), SENT_TAG_PREFIX, rn)
-            tag_commit = b4.git_revparse_tag(None, tagname)
-            if not tag_commit:
-                tagname, revision = get_sent_tagname(mybranch, SENT_TAG_PREFIX, rn)
-                tag_commit = b4.git_revparse_tag(None, tagname)
-            if not tag_commit:
-                logger.debug('No tag matching revision %s', revision)
-                continue
-            try:
-                cover, base_commit, change_id = get_base_changeid_from_tag(tagname)
-            except RuntimeError as ex:
-                logger.debug('Could not get base-commit info from %s: %s', tagname, ex)
-                continue
-
-            logger.info(' tag: %s', tagname)
-            tags.append((tagname, base_commit, tag_commit, revision, cover))
-    logger.info('---')
-    try:
-        input('Press Enter to confirm or Ctrl-C to abort')
-    except KeyboardInterrupt:
-        logger.info('')
-        sys.exit(130)
-
-    tio = io.BytesIO()
-    change_id = ts.get('change-id')
-    deletes = list()
-
-    with tarfile.open(fileobj=tio, mode='w:gz') as tfh:
-        mnow = int(time.time())
-        # Add cover
-        ifh = io.BytesIO()
-        ifh.write(cover.encode())
-        write_to_tar(tfh, f'{change_id}/cover.txt', mnow, ifh)
-        ifh.close()
-        # Add tracking
-        ifh = io.BytesIO()
-        ifh.write(make_magic_json(tracking).encode())
-        write_to_tar(tfh, f'{change_id}/tracking.js', mnow, ifh)
-        ifh.close()
-        # Add the current series
-        logger.info('Archiving branch %s', mybranch)
-        patches = b4.git_range_to_patches(None, start_commit, end_commit)
-        ifh = io.BytesIO()
-        b4.save_git_am_mbox([patch[1] for patch in patches], ifh)
-        write_to_tar(tfh, f'{change_id}/patches.mbx', mnow, ifh)
-        ifh.close()
-        deletes.append(['branch', '--delete', '--force', mybranch])
-
-        for tagname, base_commit, tag_commit, revision, cover in tags:
-            logger.info('Archiving %s', tagname)
-            # use tag date as mtime
-            lines = b4.git_get_command_lines(None, ['log', '-1', '--format=%ct', tagname])
-            if not lines:
-                logger.critical('Could not get tag date for %s', tagname)
-                sys.exit(1)
-            mtime = int(lines[0])
-            ifh = io.BytesIO()
-            ifh.write(cover.encode())
-            write_to_tar(tfh, f'{change_id}/{SENT_TAG_PREFIX}patches-v{revision}.cover', mtime, ifh)
-            ifh.close()
-            patches = b4.git_range_to_patches(None, base_commit, tag_commit)
-            ifh = io.BytesIO()
-            b4.save_git_am_mbox([patch[1] for patch in patches], ifh)
-            write_to_tar(tfh, f'{change_id}/{SENT_TAG_PREFIX}patches-v{revision}.mbx', mtime, ifh)
-            deletes.append(['tag', '--delete', tagname])
-
-    # Write in data_dir
-    datadir = b4.get_data_dir()
-    archpath = os.path.join(datadir, 'prep-archived')
-    pathlib.Path(archpath).mkdir(parents=True, exist_ok=True)
-    tarpath = os.path.join(archpath, f'{change_id}.tar.gz')
-    logger.info('Writing %s', tarpath)
-    with open(tarpath, mode='wb') as tout:
-        tout.write(tio.getvalue())
-    logger.info('Cleaning up git refs')
-    for gitargs in deletes:
-        b4.git_run_command(None, gitargs)
-    logger.info('---')
-    logger.info('Wrote: %s', tarpath)
-
-
-def show_info(param: str) -> None:
-    # is param a name of the branch?
-    if ':' in param:
-        chunks = param.split(':')
-        if len(chunks[0]):
-            if b4.git_branch_exists(None, chunks[0]):
-                mybranch = chunks[0]
-            elif b4.git_branch_exists(None, f'b4/{chunks[0]}'):
-                mybranch = f'b4/{chunks[0]}'
-            else:
-                logger.critical('No such branch: %s', chunks[0])
-                sys.exit(1)
-        else:
-            mybranch = b4.git_get_current_branch()
-        if not len(chunks[1]):
-            getval = '_all'
-        else:
-            getval = chunks[1]
-    elif b4.git_branch_exists(None, param):
-        mybranch = param
-        getval = '_all'
-    else:
-        mybranch = b4.git_get_current_branch()
-        getval = param
-
-    is_prep_branch(mustbe=True, usebranch=mybranch)
-    info = dict()
-    info['branch'] = mybranch
-    cover, tracking = load_cover(usebranch=mybranch)
+def show_info() -> None:
+    is_prep_branch(mustbe=True)
+    mybranch = b4.git_get_current_branch(None)
+    print('branch: %s' % mybranch)
+    cover, tracking = load_cover()
     csubject, cbody = get_cover_subject_body(cover)
-    info['cover-subject'] = csubject.full_subject
+    print('cover-subject: %s' % csubject.full_subject)
     ts = tracking['series']
     if ts.get('prefixes'):
-        info['prefixes'] = ' '.join(ts.get('prefixes'))
-    info['change-id'] = ts.get('change-id')
+        print('prefixes: %s' % ' '.join(ts.get('prefixes')))
+    print('change-id: %s' % ts.get('change-id'))
     revision = ts.get('revision')
-    info['revision'] = revision
-    strategy = get_cover_strategy(usebranch=mybranch)
-    info['cover-strategy'] = strategy
+    print('revision: %s' % revision)
+    strategy = get_cover_strategy()
+    print('cover-strategy: %s' % strategy)
     if ts.get('base-branch'):
-        info['base-branch'] = ts['base-branch']
-    base_commit, start_commit, end_commit, oneline, shortlog, diffstat = get_series_details(usebranch=mybranch)
-    info['base-commit'] = base_commit
-    info['start-commit'] = start_commit
-    info['end-commit'] = end_commit
-    info['series-range'] = f'{start_commit}..{end_commit}'
+        print('base-branch: %s' % ts['base-branch'])
+    base_commit, start_commit, end_commit, oneline, shortlog, diffstat = get_series_details()
+    print('base-commit: %s' % base_commit)
+    print('start-commit: %s' % start_commit)
+    print('end-commit: %s' % end_commit)
     for line in oneline:
         short, subject = line.split(maxsplit=1)
-        info[f'commit-{short}'] = subject
+        print('commit-%s: %s' % (short, subject))
     if 'history' in ts:
         for rn, links in reversed(ts['history'].items()):
-            tagname, revision = get_sent_tagname(ts.get('change-id'), SENT_TAG_PREFIX, rn)
-            tag_commit = b4.git_revparse_tag(None, tagname)
-            if not tag_commit:
-                logger.debug('No tag %s, trying with base branch name %s', tagname, mybranch)
-                tagname, revision = get_sent_tagname(mybranch, SENT_TAG_PREFIX, rn)
-                tag_commit = b4.git_revparse_tag(None, tagname)
-            if not tag_commit:
-                logger.debug('No tag matching revision %s', revision)
-                continue
+            tagname, revision = get_sent_tagname(mybranch, SENT_TAG_PREFIX, rn)
             try:
                 cover, base_commit, change_id = get_base_changeid_from_tag(tagname)
-                info[f'series-{rn}'] = '%s..%s %s' % (base_commit[:12], tag_commit[:12], links[0])
-            except RuntimeError as ex:
-                logger.debug('Could not get base-commit info from %s: %s', tagname, ex)
-
-    if getval == '_all':
-        for key, val in info.items():
-            print('%s: %s' % (key, val))
-    elif getval in info:
-        print(info[getval])
-    else:
-        logger.critical('No info about %s', getval)
-        sys.exit(1)
+                print('series-%s: %s..%s %s' % (rn, base_commit[:12], tagname, links[0]))
+            except RuntimeError:
+                logger.debug('No tag matching %s', tagname)
 
 
 def force_revision(forceto: int) -> None:
@@ -2018,18 +1810,15 @@
     store_cover(cover, tracking)
 
 
-def compare(compareto: str) -> None:
-    cover, tracking = load_cover()
-    # Try the new format first
-    tagname, revision = get_sent_tagname(tracking['series']['change-id'], SENT_TAG_PREFIX, compareto)
-    prev_end = b4.git_revparse_tag(None, tagname)
-    if not prev_end:
-        mybranch = b4.git_get_current_branch(None)
-        tagname, revision = get_sent_tagname(mybranch, SENT_TAG_PREFIX, compareto)
-        prev_end = b4.git_revparse_tag(None, tagname)
-    if not prev_end:
+def compare(compareto: str, get_output: bool = False) -> None:
+    mybranch = b4.git_get_current_branch(None)
+    tagname, revision = get_sent_tagname(mybranch, SENT_TAG_PREFIX, compareto)
+    gitargs = ['rev-parse', tagname]
+    lines = b4.git_get_command_lines(None, gitargs)
+    if not lines:
         logger.critical('CRITICAL: Could not rev-parse %s', tagname)
         sys.exit(1)
+    prev_end = lines[0]
     try:
         cover, base_commit, change_id = get_base_changeid_from_tag(tagname)
     except RuntimeError as ex:
@@ -2050,7 +1839,13 @@
     grdcmd = ['git', 'range-diff', '%.12s..%.12s' % (prev_start, prev_end), '%.12s..%.12s' % (curr_start, curr_end)]
     # We exec range-diff and let it take over
     logger.debug('Running %s', ' '.join(grdcmd))
-    os.execvp(grdcmd[0], grdcmd)
+
+    if not get_output:
+        os.execvp(grdcmd[0], grdcmd)
+        return
+    proc = subprocess.Popen(grdcmd, shell=False, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
+    stdout, _ = proc.communicate()
+    return stdout.decode('utf-8')
 
 
 def auto_to_cc() -> None:
@@ -2175,13 +1970,14 @@
     start = get_series_start()
     end = 'HEAD'
     cover_commit = find_cover_commit()
-    patches = b4.git_range_to_patches(None, start, end, ignore_commits={cover_commit})
+    patches = b4.git_range_to_patches(None, start, end, ignore_commits=set([cover_commit]))
     command = ['./scripts/checkpatch.pl', '--git'] + [x[0] for x in patches]
 
     result = run(command)
 
     return result.returncode
 
+
 def cmd_prep(cmdargs: argparse.Namespace) -> None:
     check_can_gfr()
     status = b4.git_get_repo_status()
@@ -2219,10 +2015,7 @@
         return show_revision()
 
     if cmdargs.show_info:
-        return show_info(cmdargs.show_info)
-
-    if cmdargs.cleanup:
-        return cleanup(cmdargs.cleanup)
+        return show_info()
 
     if cmdargs.format_patch:
         return format_patch(cmdargs.format_patch)
diff --color -Naur /usr/local/google/home/justinstitt/repos/b4/b4/__init__.py /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__init__.py
--- /usr/local/google/home/justinstitt/repos/b4/b4/__init__.py	2023-08-03 21:50:09.945332478 +0000
+++ /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__init__.py	2023-08-03 22:50:19.188560405 +0000
@@ -60,7 +60,7 @@
 # global setting allowing us to turn off networking
 can_network = True
 
-__VERSION__ = '0.13-dev'
+__VERSION__ = '0.12.3'
 PW_REST_API_VERSION = '1.2'
 
 
@@ -95,10 +95,6 @@
     'midmask': LOREADDR + '/all/%s',
     'linkmask': LOREADDR + '/r/%s',
     'searchmask': LOREADDR + '/all/?x=m&t=1&q=%s',
-    # You can override the format for the Link: trailer, e.g.
-    # if you would rather use the Message-Id trailer. It takes the
-    # message-id as the expansion for %s
-    # linktrailermask = Message-Id: <%s>
     'listid-preference': '*.feeds.kernel.org,*.linux.dev,*.kernel.org,*',
     'save-maildirs': 'no',
     # off: do not bother checking attestation
@@ -122,7 +118,7 @@
     'thanks-pr-template': None,
     # See thanks-am-template.example
     'thanks-am-template': None,
-    # If this is not set, we'll use what we find in 
+    # If this is not set, we'll use what we find in
     # git-config for gpg.program, and if that's not set,
     # we'll use "gpg" and hope for the better
     'gpgbin': None,
@@ -334,9 +330,6 @@
                     pmsg.followup_trailers += trailers
                     break
                 if pmsg.in_reply_to and pmsg.in_reply_to in self.msgid_map:
-                    # Avoid bad message id causing infinite loop
-                    if pmsg == self.msgid_map[pmsg.in_reply_to]:
-                        break
                     lvl += 1
                     for pltr in pmsg.trailers:
                         pltr.lmsg = pmsg
@@ -527,7 +520,7 @@
             self.add_extra_trailers(self.patches[0].followup_trailers)  # noqa
 
     def get_am_ready(self, noaddtrailers=False, covertrailers=False, addmysob=False, addlink=False,
-                     cherrypick=None, copyccs=False, allowbadchars=False) -> List[email.message.Message]:
+                     linkmask=None, cherrypick=None, copyccs=False, allowbadchars=False) -> List[email.message.Message]:
 
         usercfg = get_user_config()
         config = get_main_config()
@@ -587,21 +580,11 @@
             if lmsg is not None:
                 extras = list()
                 if addlink:
-                    linktrailer = None
-                    ltrmask = config.get('linktrailermask')
-                    if ltrmask:
-                        if ltrmask.find(':'):
-                            lparts = ltrmask.split(':', maxsplit=1)
-                            llname = lparts[0].strip()
-                            llval = lparts[1].strip() % lmsg.msgid
-                            linktrailer = LoreTrailer(name=llname, value=llval)
-                        else:
-                            logger.critical('linktrailermask does not look like a valid trailer, using defaults')
-
-                    if not linktrailer:
-                        llval = config.get('linkmask', LOREADDR + '/r/%s') % lmsg.msgid
-                        linktrailer = LoreTrailer(name='Link', value=llval)
-                    extras.append(linktrailer)
+                    if linkmask is None:
+                        linkmask = config.get('linkmask')
+                    linkval = linkmask % lmsg.msgid
+                    lltr = LoreTrailer(name='Link', value=linkval)
+                    extras.append(lltr)
 
                 if attsame and not attcrit:
                     if attmark:
@@ -1470,7 +1453,7 @@
                     transform: Literal['encode', 'decode', 'preserve'] = 'preserve') -> bytes:
         hname, hval = hdr
         if hname.lower() in ('to', 'cc', 'from', 'x-original-from'):
-            _parts = [f'{hname}: ']
+            _parts = [f'{hname}: ',]
             first = True
             for addr in email.utils.getaddresses([hval]):
                 if transform == 'encode' and not addr[0].isascii():
@@ -1525,7 +1508,7 @@
         return f'{nl} '.join(_parts).encode()
 
     @staticmethod
-    def get_msg_as_bytes(msg: email.message.Message, nl: str = '\n',
+    def get_msg_as_bytes(msg: email.message.Message, nl: str ='\n',
                          headers: Literal['encode', 'decode', 'preserve'] = 'preserve') -> bytes:
         bdata = b''
         for hname, hval in msg.items():
@@ -2589,8 +2572,6 @@
         if 'name' not in USER_CONFIG:
             udata = pwd.getpwuid(os.getuid())
             USER_CONFIG['name'] = udata.pw_gecos
-        if 'email' not in USER_CONFIG:
-            USER_CONFIG['email'] = os.environ['EMAIL']
     return USER_CONFIG
 
 
@@ -2978,34 +2959,14 @@
     return patches
 
 
-def git_commit_exists(gitdir: Optional[str], commit_id: str) -> bool:
+def git_commit_exists(gitdir, commit_id):
     gitargs = ['cat-file', '-e', commit_id]
     ecode, out = git_run_command(gitdir, gitargs)
     return ecode == 0
 
 
-def git_branch_exists(gitdir: Optional[str], branch_name: str):
-    gitargs = ['rev-parse', branch_name]
-    ecode, out = git_run_command(gitdir, gitargs)
-    return ecode == 0
-
-
-def git_revparse_tag(gitdir: Optional[str], tagname: str) -> Optional[str]:
-    if not tagname.startswith('refs/tags/'):
-        fulltag = f'refs/tags/{tagname}'
-    else:
-        fulltag = tagname
-    gitargs = ['rev-parse', fulltag]
-    ecode, out = git_run_command(gitdir, gitargs)
-    if ecode > 0:
-        return None
-    return out.strip()
-
-
-def git_branch_contains(gitdir: Optional[str], commit_id: str, checkall: bool = False) -> List[str]:
+def git_branch_contains(gitdir, commit_id):
     gitargs = ['branch', '--format=%(refname:short)', '--contains', commit_id]
-    if checkall:
-        gitargs.append('--all')
     lines = git_get_command_lines(gitdir, gitargs)
     return lines
 
@@ -3229,7 +3190,9 @@
     sconfig = get_sendemail_config()
     # Limited support for smtp settings to begin with, but should cover the vast majority of cases
     fromaddr = sconfig.get('from')
+    print(f"{fromaddr=}")
     if not fromaddr:
+        print(f"{fromaddr=} 2")
         # We fall back to user.email
         usercfg = get_user_config()
         fromaddr = usercfg['email']
@@ -3247,18 +3210,22 @@
         sp = shlex.shlex(server, posix=True)
         sp.whitespace_split = True
         smtp = list(sp)
+
         if '-i' not in smtp:
             smtp.append('-i')
+
         # Do we have the envelopesender defined?
-        env_sender = sconfig.get('envelopesender', '')
-        if env_sender:
-            if env_sender == 'auto':
-                envpair = email.utils.parseaddr(fromaddr)
-            else:
-                envpair = email.utils.parseaddr(env_sender)
-            if envpair[1]:
-                smtp += ['-f', envpair[1]]
-        logger.debug('sendmail command: %s', ' '.join(smtp))
+        env_sender = sconfig.get('envelopesender')
+        if not env_sender or env_sender == "auto":
+            envpair = email.utils.parseaddr(fromaddr)
+        else:
+            envpair = email.utils.parseaddr(env_sender)
+
+        # envpair is ('', '') if email.utils.parseaddr fails to parse
+        if envpair != ('', ''):
+            # smtp += ['-t'] if 'sendgmr' in server else ['-f', envpair[1]]
+            smtp += ['f']
+
         return smtp, fromaddr
 
     encryption = sconfig.get('smtpencryption')
@@ -3377,7 +3344,7 @@
               fromaddr: Optional[str], destaddrs: Optional[Union[set, list]] = None,
               patatt_sign: bool = False, dryrun: bool = False,
               output_dir: Optional[str] = None, web_endpoint: Optional[str] = None,
-              reflect: bool = False) -> Optional[int]:
+              reflect: bool = False) -> tuple[Optional[int], str]:
 
     tosend = list()
     if output_dir is not None:
@@ -3431,7 +3398,7 @@
         tosend.append((myaddrs, bdata, ls))
 
     if not len(tosend):
-        return 0
+        return 0, 0
 
     logger.info('---')
     if web_endpoint:
@@ -3457,10 +3424,11 @@
 
         if rdata.get('result') == 'error':
             logger.critical('Error from endpoint: %s', rdata.get('message'))
-            return 0
+            return 0, 0
 
     sent = 0
     envpair = email.utils.parseaddr(fromaddr)
+    subj = ''
     if isinstance(smtp, list):
         # This is a local command
         if reflect:
@@ -3469,6 +3437,7 @@
             logger.info('Sending via "%s"', ' '.join(smtp))
         for destaddrs, bdata, lsubject in tosend:
             logger.info('  %s', lsubject.full_subject)
+            subj = lsubject.full_subject
             if reflect:
                 cmdargs = list(smtp) + [envpair[1]]
             else:
@@ -3483,13 +3452,13 @@
             # Force compliant eols
             bdata = re.sub(rb'\r\n|\n|\r(?!\n)', b'\r\n', bdata)
             logger.info('  %s', lsubject.full_subject)
+            subj = lsubject.full_subject
             if reflect:
                 smtp.sendmail(fromaddr, [envpair[1]], bdata)
             else:
                 smtp.sendmail(fromaddr, destaddrs, bdata)
             sent += 1
-
-    return sent
+    return sent, subj
 
 
 def git_get_current_branch(gitdir: Optional[str] = None, short: bool = True) -> Optional[str]:
@@ -3623,7 +3592,6 @@
 
     return msgid, msgs
 
-
 def git_revparse_obj(gitobj: str) -> str:
     ecode, out = git_run_command(None, ['rev-parse', gitobj])
     if ecode > 0:
diff --color -Naur /usr/local/google/home/justinstitt/repos/b4/b4/mbox.py /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/mbox.py
--- /usr/local/google/home/justinstitt/repos/b4/b4/mbox.py	2023-07-17 22:13:41.942073527 +0000
+++ /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/mbox.py	2023-07-17 20:22:03.168602190 +0000
@@ -106,7 +106,7 @@
     try:
         am_msgs = lser.get_am_ready(noaddtrailers=cmdargs.noaddtrailers,
                                     covertrailers=covertrailers, addmysob=cmdargs.addmysob,
-                                    addlink=cmdargs.addlink, cherrypick=cherrypick,
+                                    addlink=cmdargs.addlink, linkmask=config['linkmask'], cherrypick=cherrypick,
                                     copyccs=cmdargs.copyccs, allowbadchars=cmdargs.allowbadchars)
     except KeyError:
         sys.exit(1)
@@ -218,7 +218,6 @@
         logger.critical(' Link: %s', linkurl)
 
     base_commit = None
-
     matches = re.search(r'base-commit: .*?([\da-f]+)', first_body, re.MULTILINE)
     if matches:
         base_commit = matches.groups()[0]
@@ -233,7 +232,7 @@
         if not b4.git_commit_exists(topdir, base_commit):
             logger.info(' Base: base-commit %s not known, ignoring', base_commit)
             base_commit = None
-        elif not cmdargs.mergebase:
+        else:
             logger.info(' Base: using specified base-commit %s', base_commit)
 
     if not base_commit and topdir and cmdargs.guessbase:
@@ -251,12 +250,6 @@
         except IndexError:
             logger.critical(' Base: failed to guess base')
 
-    if cmdargs.mergebase:
-        if base_commit:
-            logger.warn(' Base: overriding submitter provided base-commit %s', base_commit)
-        base_commit = cmdargs.mergebase
-        logger.info(' Base: using CLI provided base-commit %s', base_commit)
-
     if cmdargs.subcmd == 'shazam':
         if not topdir:
             logger.critical('Could not figure out where your git dir is, cannot shazam.')
@@ -362,7 +355,6 @@
                 'authorname': cmsg.fromname,
                 'authoremail': cmsg.fromemail,
                 'covermessage': covermessage,
-                'mid': top_msgid,
                 'midurl': linkurl,
             }
             if len(am_msgs) > 1:
@@ -684,8 +676,8 @@
 
 
 def main(cmdargs: argparse.Namespace) -> None:
-    # We force some settings
     if cmdargs.subcmd == 'shazam':
+        # We force some settings
         cmdargs.checknewer = True
         cmdargs.threeway = False
         cmdargs.nopartialreroll = False
@@ -697,8 +689,6 @@
             cmdargs.guessbase = True
         else:
             cmdargs.guessbase = False
-    else:
-        cmdargs.mergebase = False
 
     if cmdargs.checknewer:
         # Force nocache mode
diff --color -Naur /usr/local/google/home/justinstitt/repos/b4/b4/pr.py /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/pr.py
--- /usr/local/google/home/justinstitt/repos/b4/b4/pr.py	2023-07-17 22:13:41.942073527 +0000
+++ /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/pr.py	2023-07-17 20:22:03.168602190 +0000
@@ -19,7 +19,7 @@
 import urllib.parse
 import requests
 
-from datetime import datetime
+from datetime import datetime, timedelta
 
 from email import utils, charset
 from email.mime.text import MIMEText
@@ -358,7 +358,7 @@
             msg.add_header('X-Original-List-Id', b4.LoreMessage.clean_header(lmsg.msg['List-Id']))
 
         msgs.append(msg)
-        logger.info('  %s', re.sub(r'\n\s*', ' ', msg.get('Subject')))
+        logger.info('  %s', re.sub(r'\n\s*', ' ' , msg.get('Subject')))
 
     logger.info('Exploded %s messages', len(msgs))
     if retrieve_links and linked_ids:
diff --color -Naur /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/command.cpython-311.pyc /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/command.cpython-311.pyc
--- /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/command.cpython-311.pyc	1970-01-01 00:00:00.000000000 +0000
+++ /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/command.cpython-311.pyc	2023-08-03 22:14:14.583422369 +0000
@@ -0,0 +1,139 @@
+
+    %dY                     |   d Z ddlZddlZddlZddlZej        Zd Zd Zd Zd Z	d Z
+d Zd	 Zd
+ Zd Zd Zd Zd Zd Zdej        fdZd Zedk    rddlZ	 ej                            d          dk    rej                            ej                            ej                            e                              Zej                            ed          Z  ej!        e g d          \  Z"Z#e"dk    r$ej        de#$                                de_        n# e%$ r
+Z&Y dZ&[&ndZ&[&ww xY w e             dS dS )z5Konstantin Ryabitsev <konstantin@linuxfoundation.org>    Nc                     |                      ddd           |                      dddd d	           |                      d
+d           |                      dddddd           d S )Nmsgid?,Message ID to process, or pipe a raw messagenargshelp-mz--use-local-mbox	localmboxzOInstead of grabbing a thread from lore, process this mbox file (or - for stdin)destdefaultr	   z--stdin-pipe-sepzHWhen accepting messages on stdin, split using this pipe separator stringr	   -C
+--no-cachenocache
+store_trueFDo not use local cacher   actionr   r	   )add_argumentsps    T/usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/command.pycmd_retrieval_common_optsr      s    OOs!O     OO^     OOW     OO%          c                     t          |            |                     dddd           |                     dddd	d
+d           |                     dddd d           |                     dddd	d
+d           d S )N-o--outdir.zJOutput into this directory (or use - to output mailbox contents to stdout)r   r	   -cz--check-newer-revisions
+checknewerr   Fz$Check if newer patch revisions existr   -nz--mbox-namewantnamez%Filename to name the mbox destinationr   -Mz--save-as-maildirmaildirz0Save as maildir (avoids mbox format ambiguities))r   r   r   s    r   cmd_mbox_common_optsr(   )   s    b!!!OOY	     OO!3     OO4     OO?      r   c                 $   |                      dddt          d d           |                      dddd	d
+d           |                      dddd	d
+d           |                      dddd	d
+d           |                      dddd	d
+d           |                      dddd	d
+d           |                      dddd d !           |                      d"d#d	d
+d$           |                      d%d&d	d
+d'           |                      d(d)d	d
+d*           d S )+N-vz--use-versionwantverz*Get a specific version of the patch/seriesr   typer   r	   -tz--apply-cover-trailerscovertrailersr   Fz6Apply trailers sent to the cover letter to all patchesr   -S--sloppy-trailerssloppytrailers3Apply trailers without email address match checkingz-Tz--no-add-trailersnoaddtrailersz/Do not add any trailers from follow-up messages-sz--add-my-sobaddmysobz)Add your own signed-off-by to every patch-lz
+--add-linkaddlinkz5Add a Link: with message-id lookup URL to every patchz-Pz--cherry-pick
+cherrypickzCherry-pick a subset of patches (e.g. "-P 1-2,4,6-", "-P _" to use just the msgid specified, or "-P *globbing*" to match on commit subject)r   z--cc-trailerscopyccsz)Copy all Cc'd addresses into Cc: trailersz--no-parentnoparentzBBreak thread at the msgid specified and ignore any parent messagesz--allow-unicode-control-charsallowbadcharsz9Allow unicode control characters (very rarely legitimate))r   intr   s    r   cmd_am_common_optsr>   J   s   OO9     OO E     OOB     OO>     OO8     OOD     OO6     OO8     OOQ     OO'H      r   c                 B    dd l }|j                            |            d S Nr   b4.mboxmboxmaincmdargsb4s     r   cmd_mboxrH      %    NNNGLLr   c                 B    dd l }|j                            |            d S r@   )b4.krkrrD   rE   s     r   cmd_krrM      %    LLLEJJwr   c                 B    dd l }|j                            |            d S r@   )b4.ezezcmd_preprE   s     r   rR   rR      %    LLLENN7r   c                 B    dd l }|j                            |            d S r@   )rP   rQ   cmd_trailersrE   s     r   rU   rU      s'    LLLEwr   c                 B    dd l }|j                            |            d S r@   )rP   rQ   cmd_sendrE   s     r   rW   rW      rS   r   c                 B    dd l }|j                            |            d S r@   rA   rE   s     r   cmd_amrY      rI   r   c                 B    dd l }|j                            |            d S r@   rA   rE   s     r   
+cmd_shazamr[      rI   r   c                 B    dd l }|j                            |            d S r@   )b4.prprrD   rE   s     r   cmd_prr_      rN   r   c                 B    dd l }|j                            |            d S r@   )b4.tytyrD   rE   s     r   cmd_tyrc      rN   r   c                 B    dd l }|j                            |            d S r@   )b4.diffdiffrD   rE   s     r   cmd_diffrg      rI   r   returnc            
+         t          j        dddt           j                  } |                     ddt          j                   |                     dd	d
+dd           |                     ddd
+dd           |                     ddd
+dd           |                     dd
+dd           |                     dd
+dd           |                     dd          }|                    dd          }t          |           |                    ddd d
+dd!"           |                    d#d$d%d&dd'(           |	                    t          )           |                    d*d+          }t          |           t          |           |                    d,d-d.d
+dd/"           |                    d0d1d2d
+dd3"           |                    d4d5d6d7d8t          d d9:           |                    d;d<t          d=d>?           |                    d@dAdBd
+ddC"           |                    dDdEd
+ddF"           |                    dGdHd
+ddI"           |	                    t          )           |                    dJdK          }t          |           t          |           |                                }|                    dLdMdNd
+ddO"           |                    dPdQdRd
+ddS"           |                    d;d<t          d=dT?           |	                    t"          )           |                    dUdV          }|                    d0dWd dXY           |                    d4dZd d[Y           |                    d\d]d
+dd^           |                    d_d`d
+dda           |                    dbdcddd def           |                    dgdhd
+diddjk           |                    ddldmd dnf           |                    dodpdqd drf           |                    dsdtd
+ddu"           |                    dvdwdxy           |	                    t$          )           |                    dzd{          }|                    d0dWd dXY           |                    dbd|d}d~Y           |                    dgdd
+dd           |                    dddd df           |                    ddd dY           |                    ddd
+dd           |                    d4dZd dY           |                    dddY           |                    ddd
+dddk           |                    dsd
+dtddk           |                    dd dY           |	                    t&          )           |                    dd          }|                    dvdwdxy           |                    d0dWd dXY           |                    dddd
+dd"           |                    dddt          d d7d           |                    dddd
+dd"           |                    dbddd df           |                    d\ddd
+dd"           |                    ddddd d           |	                    t(          )           |                    dd          }	t          |	           |	                    ddd
+dd"           |		                    t*          )           |                    dd          }
+|
+                    d\dd
+dd           |
+                    ddt          d           |
+                    ddd7d           |
+                                }|                    dddd           |                    dd
+dd           |                    dd
+dd           |                    ddd           |                    ddd dd           |                    dd
+dd           |                    d]d
+dd           |
+                    dd          }|                    dddd           |                    dddd           |                    ddddvd           |
+                    dd          }|                    d_ddd           |
+	                    t.          )           |                    dd          }|                    ddd
+dd           |                    dddd
+dd"           |                    dddd           |                    dddY           t          |           |	                    t0          )           |                    dd          }|                    ddsdtd
+dd"           |                    dbdd           |                    dd
+dd           |                    dd
+dd           |                    dd7dy           |                    dd7d y           |                    dd
+dd           |                    dddwdd           |                    dd
+dd           |                    d	d
+          }|                    ddd
+dd"           |                    dddd           |	                    t2          )           | S (  NrG   z4A tool to work with patches in public-inbox archivesz3Online docs available at https://b4.docs.kernel.org)progdescriptionepilogformatter_classz	--versionversion)r   rn   z-dz--debugr   Fz%Add more debugging info to the output)r   r   r	   z-qz--quietz Output critical information onlyr$   z--no-interactivez$Do not ask any interactive questionsz--offline-modez"Do not perform any network queriesz
+--no-stdinzDisable TTY detection for stdinzsub-command helpsubcmd)r	   r   rC   z!Download a thread as an mbox filer   z-fz--filter-dupesfilterdupesz?When adding messages to existing maildir, filter out duplicatesr   z-rz	--refetchrefetchMBOXzBRefetch all messages in specified mbox with their original headers)r   metavarr   r	   )funcamz+Create an mbox file that is ready to git-amz-Qz--quilt-ready
+quiltreadyz$Save patches in a quilt-ready folderz-gz--guess-base	guessbasez6Try to guess the base of the series (if not specified)z-bz--guess-branchguessbranch+extendz9When guessing base, restrict to this branch (use with -g))r   r   r   r-   r   r	   z--guess-lookback	guessdays   zQWhen guessing base, go back this many days from the patch date (default: 2 weeks)r,   z-3z--prep-3waythreewayzdPrepare for a 3-way merge (tries to ensure that all index blobs exist by making a fake commit range)z
+--no-covernocoverz<Do not save the cover letter (on by default when using -o -)z--no-partial-rerollnopartialrerollz*Do not reroll partial series when detectedshazamz/Like b4 am, but applies the series to your treez-Hz--make-fetch-headmakefetchheadzFAttempt to treat series as a pull request and fetch it into FETCH_HEADr&   z--mergemergezFAttempt to merge series as if it were a pull request (execs git-merge)ze(use with -H or -M) When guessing base, go back this many days from the patch date (default: 3 weeks)r^   z*Fetch a pull request found in a message IDz--gitdirz/Operate on this git tree instead of current dirr!   z--branchz4Check out FETCH_HEAD into this branch after fetchingr"   z--checkz.Check if pull request has already been appliedz-ez	--explodez3Convert a pull request into an mbox full of patchesr   z--output-mboxoutmboxz=Save exploded messages into this mailbox (default: msgid.mbx)r   r7   z--retrieve-linksgetlinksz0Attempt to retrieve any Link: URLs (use with -e))r   r   r   r	   z--from-addrmailfromz1Use this From: in exploded messages (use with -e)r5   z--send-as-identitysendidentityzxUse git-send-email to send exploded series (use with -e);the identity must match a [sendemail "identity"] config sectionz	--dry-rundryrunz<Force a --dry-run on git-send-email invocation (use with -s)r   r   r   r   rb   z8Generate thanks email when something gets merged/appliedr   r    z,Write thanks files into this dir (default=.)z--listz6List pull requests and patch series you have retrievedr.   z--thank-forthankforzJGenerate thankyous for specific entries from -l (e.g.: 1,3-5,7-; or "all")z	--discardz<Discard specific messages from -l (e.g.: 1,3-5,7-; or "all")z-az--autoz>Use the Auto-Thankanator to figure out what got applied/mergedz/The branch to check against, instead of currentz--sincez1.weekzEThe --since option to use when auto-matching patches (default=1.week)r0   z--send-email	sendemailz/Send email instead of writing out .thanks filesz(Print out emails instead of sending themz--pw-set-statezCSet this patchwork state instead of default (use with -a, -t or -d)rf   z-Show a range-diff to previous series revisionr   r   r   r   r*   z--compare-versionswantverszLCompare specific versions instead of latest and one before that, e.g. -v 3 5)r   r-   r   r   r	   z	--no-diffnodiffz6Do not generate a diff, just show the command to do itz--output-diffoutdiffz8Save diff into this file instead of outputting to stdoutz--colorcolorz,Force color output even when writing to filer
+   z--compare-am-mboxesambox   z+Compare two mbx files prepared with "b4 am")r   r   r   r	   rL   zKeyring operationsz--show-keysshowkeysz)Show all developer keys found in a threadprepz6Work on patch series to submit for mailing list reviewz--auto-to-cczEAutomatically populate cover letter trailers with To and Cc addressesz--force-revisionNz(Force revision to be this number instead)rs   r-   r	   z--set-prefixesPREFIXz2Extra prefixes to add to [PATCH] (e.g.: RFC mydrv))rs   r   r	   z-pz--format-patch
+OUTPUT_DIRz&Output prep-tracked commits as patches)rs   r	   z--edit-coverz>Edit the cover letter in your defined $EDITOR (or core.editor)z--show-revisionz#Show current series revision numberz--compare-tovNz2Display a range-diff to previously sent revision Nz--manual-rerollrerollCOVER_MSGIDzFMark current revision as sent and reroll (requires cover letter msgid))r   r   rs   r	   z--show-infoz5Show current series info in a column-parseable formatz7Run ./scripts/checkpatch.pl on your entire patch serieszCreate new branchz/Create a new branch for working on patch seriesz--newnew_series_namez1Create a new branch for working on a patch series)r   r	   z--fork-point
+fork_pointz?When creating a new branch, use this fork point instead of HEADz-Fz--from-threadMSGIDz+When creating a new branch, use this thread)rs   r   r	   zEnroll existing branchz$Enroll existing branch for prep workz--enrollenroll_basezKEnroll current branch, using the passed tag, branch, or commit as fork basetrailersz5Operate on trailers received for mailing list reviewsz-uz--updatez3Update branch commits with latest received trailersr1   r2   r3   z--trailers-fromtrailers_fromzULook for trailers in the thread with this msgid instead of using the series change-idz1.monthzNThe --since option to use with -F when auto-matching patches (default=1.month)sendz0Submit your work for review on the mailing listsz:Do not send, just dump out raw smtp messages to the stdoutz--output-dirzDDo not send, write raw messages to this directory (forces --dry-run)z	--reflectz<Send everything to yourself instead of the actual recipientsz--no-trailer-to-cczKDo not add any addresses found in the cover or patch trailers to To: or Cc:z--toz Addresses to add to the To: listz--ccz Addresses to add to the Cc: listz--not-me-tooz(Remove yourself from the To: or Cc: listz--resendlatestz.Resend a previously sent version of the series)rs   r   constr	   z	--no-signz9Do not add the cryptographic attestation signature headerzWeb submissionz-Authenticate with the web submission endpointz--web-auth-newauth_newz)Initiate a new web authentication requestz--web-auth-verifyauth_verifyVERIFY_TOKENz0Submit the token received via verification email)r   rs   r	   )argparseArgumentParserArgumentDefaultsHelpFormatterr   rG   __VERSION__add_subparsers
+add_parserr(   set_defaultsrH   r>   strr=   rY   r   add_mutually_exclusive_groupr[   r_   rc   rg   rM   add_argument_grouprR   rU   rW   )parser
+subparserssp_mboxsp_amsp_shsh_gsp_prsp_tysp_diffsp_krsp_prepspp_gag_prepnag_prepesp_trlsp_sendag_sendhs                    r   setup_parserr      s   $JD >	  F Ir~NNN
+4     /     3     1	     .	     &&,>X&NNJ ##F1T#UUG!!!N     Q     h''' !!@ "  E u	3     
+E     
+H  	 	 	 
+`     
+U     
+K     
+9     
+F### !!H "  E e$$$u--//DU     	U     
+!  	 	 	 
+J''' !!? "  E 
+>	     
+C	     
+=     
+B     
+L     
+?     
+@     
+N  	 	 	 
+K     
+s!O     
+F### !!M "  E 
+>	     
+;	     
+E     
+Y     
+K	     
+M     
+>	     
+T    
+ 
+>     
+7     
+R    
+ 
+F### ##D $  G s!O     >	     %     [     E     G     ;     :     h''' !!$-A!BBEe$$$	8     
+F### ##M $  G T     7	     A	     0022E	5	     
+M	     
+2	     
+A    
+ 
+U     
+D	     
+F	     ))N H @	     N	     :     )) "H H Z	     h''' ""P #  F B     B     d	     ]    
+ f%%%
+\*** ##G $  G I     S    
+ K	     Z	     s1STTTs1STTT7	     =     H	     ))I H 8     ?	     h'''Mr   c                     t                      } |                                 }t                              t          j                   t	          j                    }t	          j        d          }|                    |           |j	        r |                    t          j
+                   nF|j        r |                    t          j                   n|                    t          j                   t                              |           d|vr(|                                  t          j        d           |j        r&t                              d           dt&          _        |                    |           d S )Nz%(message)srt      zRunning in OFFLINE modeF)r   
+parse_argsloggersetLevelloggingDEBUGStreamHandler	FormattersetFormatterquietCRITICALdebugINFO
+addHandler
+print_helpsysexitoffline_modeinforG   can_networkrt   )r   rF   ch	formatters       r   cmdr   *  s2   ^^F!!G
+OOGM"""			 	 B!-00IOOI} "
+G$%%%%	 "
+GM""""
+GL!!!
+bW -...LLr   __main__z-devz.git)z	rev-parsez--shortHEAD-z.5)'
+__author__r   r   rG   r   r   r   r(   r>   rH   rM   rR   rU   rW   rY   r[   r_   rc   rg   r   r   r   __name__osr   findpathdirnamerealpath__file__basejoindotgitgit_run_commandecodeshortstrip	Exceptionex r   r   <module>r      s9   E
+   				 
+
+
+
+	  2  BN N Nb                       P	h- P	 P	 P	 P	f  : zIII	>v&&**7??27??273C3CH3M3M#N#NOODW\\$//F-2-f6V6V6VWWLE5zz.0nnnekkmmmm!L    CEEEEE s   CD D-(D-
\ No newline at end of file
diff --color -Naur /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/diff.cpython-311.pyc /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/diff.cpython-311.pyc
--- /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/diff.cpython-311.pyc	1970-01-01 00:00:00.000000000 +0000
+++ /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/diff.cpython-311.pyc	2023-07-17 20:22:03.196602145 +0000
@@ -0,0 +1,45 @@
+
+    d                     j    d Z ddlZddlZddlZddlZddlZddlZddlZddlZej	        Z	d Z
+d Zd ZdS )z5Konstantin Ryabitsev <konstantin@linuxfoundation.org>    Nc                 H	   t          j        |           }| j        }|rAt          |          dk    r.t                              d           t          j        d           |}|r%|dd                    d |D                       z   z  }t          j	        |d          }t          j                            |          r| j        st                              d           t                      }t          j        |          D ]o}t#          t          j                            ||          d	          5 }|                    t'          j        |                     d d d            n# 1 swxY w Y   pn?t          j        || j        
+          }|st                              d|           d S t           j                            |d|          }t          j                            |          rt1          j        |           t5          j        |                              d           d}|D ]}t#          t          j                            |d|z            d          5 }|                    |                    t           j                             d d d            n# 1 swxY w Y   |dz  }t          |          }	t                              d           t                              d|	           t          j                     }
+|D ]}|
+!                    |           |rBt          |          dk    r/tE          |
+j#        $                                          }|d         }n|r2t          |          dk    rtE          |          }tK          |          }nLtE          |
+j#        $                                          }tK          |
+j#        $                                          }||k    r6t                              d           t                              d           dS ||
+j#        vrdS ||
+j#        vrdS |
+j#        |         j&        s|
+'                    |d           |
+j#        |         j&        s|
+'                    |d           |
+j#        |         |
+j#        |         fS )N   z'Can only compare two versions at a time   -c                 ,    g | ]}t          |          S  )str).0xs     Q/usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/diff.py
+<listcomp>z+diff_same_thread_series.<locals>.<listcomp>   s    %?%?%?c!ff%?%?%?    z	diff.msgs)suffixzUsing cached copy of the lookuprb)nocachezUnable to retrieve thread: %s)	directionwantversT)parentsr   z%04dwb)policy---z#Analyzing %s messages in the threadz,ERROR: Could not auto-find previous revisionz;       Run "b4 am -T" manually, then "b4 diff -m mbx1 mbx2"NNF)sloppytrailers)(b4	get_msgidr   lenloggercriticalsysexitjoinget_cache_fileospathexistsr   infolistlistdiropenappendemailmessage_from_binary_fileget_pi_thread_by_msgidmboxget_extra_seriesshutilrmtreepathlibPathmkdirwriteas_bytes	emlpolicyLoreMailboxadd_messagemaxserieskeysmincompletepartial_reroll)cmdargsmsgidr   
+identifiercachedirmsgsmsgfhatcountlmbxupperlowers                r   diff_same_thread_seriesrM      s   L!!EH CMMA%%ABBB J AcCHH%?%?h%?%?%?@@@@
+ K@@@H	w~~h  5666vv:h'' 	@ 	@Cbgll8S11488 @BE:2>>???@ @ @ @ @ @ @ @ @ @ @ @ @ @ @	@ (HHH 	OO;UCCCFw''X'NN7>>(## 	$M(###X$$T$222 	 	Cbgll8Vb[994@@ <BR\::;;;< < < < < < < < < < < < < < <!GBBIIE
+KK
+KK5u===>D   (CMMQ&&DK$$&&''	 (c(mmq((HHDK$$&&''DK$$&&''~~FGGGUVVVzDKzDKz;u& 9E%888;u& 9E%888;ut{5111s$   0(E$$E(	+E(	 4J  J$	'J$	c                    t                      }| j        D ]}t          j                            |          st
+                              d|            dS t          j                            |          rt          j	        |          }nt          j
+        |          }t          |          }t
+                              d||           t          j                    }|                                D ]\  }}|                    |           t          |j                  dk     r/t
+                              d|           t%          j        d           t          |j                  dk    rt
+                              d|           |                    |j        t+          |j                                                                      |S )NzCannot open %sr   zLoading %s messages from %sr   zNo valid patches found in %sz3More than one series version in %s, will use latest)r(   amboxr$   r%   r&   r   r   isdirmailboxMaildirr/   r   r'   r   r9   itemsr:   r<   r    r!   r+   r;   r=   )rA   chunksmboxfilembxrI   rJ   keyrF   s           r   diff_mboxesrX   \   s~   VVFM < <w~~h'' 	OO,h777::7=="" 	)/(++CC,x((CC15(CCC~		 	" 	"HCS!!!!t{aOO:HEEEHQKKKt{aOOQS[\\\dk#dk&6&6&8&8"9"9:;;;;Mr   c           	         | j         t          |           \  }}nt          |           \  }}||t          j        d           |                    | j                  \  }}||Nt                              d           t                              d|j	                   t          j        d           |                    | j                  \  }}||Nt                              d           t                              d|j	                   t          j        d           d|dd|dd	|dd|d}| j
+        rWt                              d
+|j	        |j	                   t                              d|            t          j        d           t                              d|j	        |j	                   t                              d|           d| d| | d| g}| j        | j        r|                    d           t          j        | j        |          \  }	}
+|	dk    ret                              d           t                              d           t                              d|            t          j        d           | j        6t                              d| j                   t#          | j        d          }n&t                              d           t          j        }|                    |
+           d S )Nr   )gitdirr   z3Could not create fake-am range for lower series v%sz3Could not create fake-am range for upper series v%szgit range-diff z.12z.. z Success, to compare v%s and v%s:z    r   zDiffing v%s and v%sz    Running: %sz
+range-diffz--colorzUnable to generate diffzTry running it yourself:z
+Writing %sw)rO   rX   rM   r    r!   make_fake_am_rangerZ   r   r   revisionnodiffr'   outdiffcolorr+   r   git_run_commandr*   stdoutr6   )rA   lseruserlsclecuscuecgrdcmdgitargsecoderdiffrG   s               r   mainrn   w   s   }  ))
+dd,W55
+d|t| &&gn&==HC
+{ckMt}]]]&&gn&==HC
+{ckMt}]]];>333SSSS###NF~ 6t}UUUO6OO$$$
+KK%t}dmDDD
+KK!6***__s__oooo>G'-y!!!%gng>>LE5qyy12222333v((("L'/222'/3''EZHHUOOOOOr   )
+__author__r$   r    r   b4.mboxrQ   r,   r1   r3   r   rM   rX   rn   r   r   r   <module>rq      s    E
+ 				 
+
+
+
+ 				     	E2 E2 E2P  6+ + + + +r   
\ No newline at end of file
diff --color -Naur /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/ez.cpython-311.pyc /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/ez.cpython-311.pyc
--- /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/ez.cpython-311.pyc	1970-01-01 00:00:00.000000000 +0000
+++ /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/ez.cpython-311.pyc	2023-08-08 21:08:27.957103475 +0000
@@ -0,0 +1,523 @@
+
+    d9                       d Z ddlZddlZddlZddlZddlZddlZddlZddl	Z	ddl
+Z
+ddlZddlZddlZddlZddlZddlZddlZddlZddlZddlZddlmZmZmZmZ ddlmZ ddlmZ ddlmZ 	 ddlZdZn# e$ r dZY nw xY w	 ddl Z!dZ"n# e$ r dZ"Y nw xY wej#        Z#d	Z$d
+Z%dZ&dZ'dZ(dee)e)e)e)e)e)f         fdZ*dddZ+dej,        ddfdZ-dede)dee.         de.fdZ/dfde)dee)         de)fdZ0dej,        ddfdZ1de2de)fdZ3dgde4dee)e2f         fdZ5dgde)d e2d!e4ddfd"Z6dfd#ee)         de)fd$Z7dgd%e4de4fd&Z8dee)         fd'Z9 G d( d)          Z:ddd*Z;de)fd+Z<dej,        ddfd,Z=dee)         d-e>deee)e)f                  fd.Z?dfd/ee)         dee)e)e)ee)         e)e)f         fd0Z@d1eAd2e)ddfd3ZBd4e)dee)e)e)f         fd5ZCdfd6e)d7e)d8ee)         de)fd9ZDd:e)deeee)f         fd;ZE	 dhd<ejF        d=e)d>eee)ejG        jH        f                  d:e)d?e.d@e4fdAZId:e)d>eee)ejG        jH        f                  ddfdBZJdCe)deejF        e)f         fdDZKd>eee)ejG        jH        f                  fdEZLdee)e)f         fdFZMdidGe4d@e4dHe4deeee)eee)ejG        jH        f                  f         fdIZNd4e)d7e.deeeeee)ejG        jH        f                  f         fdJZOdKe)ddfdLZPdej,        ddfdMZQd#e)dNe)dOee)e.f         dee)ee.         f         fdPZRe%dQfde)dRe)dSe)dNe)dTe)f
+dUZSdddVZTdddWZUdddXZVdYe.ddfdZZWdgd[e)d\e4ddfd]ZXddd^ZYd_eAddfd`ZZde.fdaZ[dej,        ddfdbZ\dej,        ddfdcZ]dS )jz5Konstantin Ryabitsev <konstantin@linuxfoundation.org>    N)OptionalTupleListUnion)utils)Template)PathTFz--- b4-submit-tracking ---zsent/z"https://lkml.kernel.org/_b4_submitz
+${cover}
+
+---
+${shortlog}
+
+${diffstat}
+---
+base-commit: ${base_commit}
+change-id: ${change_id}
+
+Best regards,
+--
+${signature}
+z
+Changes in v${newrev}:
+- EDITME: describe what is new in this series revision.
+- EDITME: use bulletpoints and terse descriptions.
+- Link to v${oldrev}: ${oldrev_link}
+
+returnc                     t          j                    } |                     dd          }t          j        d|          sd }|st          j                    }t          j                            t          j        	                    |d                    r"t                              d           t          }nt          d          t          j                    }|                    d          }|st          d          |                    d	          }t          j                    }|                    d
+d          }t          j        |          \  }}	||||||	fS )Nsend-endpoint-web 
+^https?://Kconfig=No sendemail configs found, will use the default web endpointzSWeb submission endpoint (b4.send-endpoint-web) is not defined, or is not a web URL.emailz#No email configured, set user.emailnameselectordefault)b4get_main_configgetresearchgit_get_toplevelospathexistsjoinloggerdebugDEFAULT_ENDPOINTRuntimeErrorget_user_configpatattget_algo_keydata)
+configendpointtopdirusercfgmyemailmynamepconfigr   algokeydatas
+             O/usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/ez.pyget_auth_configsr0   N   s4   !!Fzz-r22H9]H--  v$&&7>>"',,vy99:: 	vLLXYYY'HHtuuu ""Gkk'""G B@AAA[[  F$&&G{{:y11H+G44MD'VWhg==    c                     	 t                      \  } }}}}}n# t          j        $ rS}t                              d           t                              d|           t          j        d           Y d }~ncd }~wt          $ rS}t                              d           t                              d|           t          j        d           Y d }~nd }~ww xY w|dk    rjdddd	|g}t          j	        |          \  }}	}
+|d
+k    r0t                              d||           t          j        d           |	
+                                }n|dk    rid
+dlm} d
+dlm}  ||                                |          }t!          j        |j                                                  
+                                }n/t                              d|           t          j        d           t                              d           t                              d|            t                              d|           t                              d|           t                              d|           |dk    rt                              d||           nt                              d||           t                              d           	 t)          d           n># t*          $ r1 t                              d           t          j        d           Y nw xY wd||||d}t                              d|            t          j                    }|                    | |          }t                              d           |j        dk    r	 |                                }|                    d           d!k    r5t                              d"|           t                              d#           t          j        d
+           nK# t6          $ r>}t                              d$|j                   t          j        d           Y d }~nd }~ww xY wt                              d%|j                   t          j        d           d S )&Nz*CRITICAL: no usable signing key configured          %s   z-CRITICAL: unable to set up web authenticationopenpgpz--exportz--export-optionszexport-minimal-ar   z0CRITICAL: unable to get PGP public key for %s:%sed25519)
+SigningKey)Base64Encoder)encoderzJCRITICAL: algorithm %s not currently supported for web endpoint submissionz1Will submit a new email authorization request to:z  Endpoint: %sz      Name: %sz  Identity: %sz  Selector: %sz    Pubkey: %s:%s---z)Press Enter to confirm or Ctrl-C to abortr      zauth-new)actionr   identityr   pubkeyz!Submitting new auth request to %sjson   resultsuccessz"Challenge generated and sent to %szEOnce you receive it, run b4 send --web-auth-verify [challenge-string]"Odd response from the endpoint: %s"500 response from the endpoint: %s)r0   r$   
+NoKeyErrorr   criticalsysexitr"   r   gpg_run_commanddecodenacl.signingr8   nacl.encodingr9   encodebase64	b64encode
+verify_keyinfoinputKeyboardInterruptget_requests_sessionpoststatus_coderA   r   	Exceptiontext)r'   r+   r*   r   r-   r.   exgpgargsecodeouterrr?   r8   r9   skreqsesresrdatas                      r/   auth_newre   h   s8   	=M=O=O:&'8T77   DEEE+++   GHHH+++
+ y13CT7S,W55sC199OONPTV]^^^HQKKK			++++++//////Z((-@@@!"-"6"6"8"899@@BBdfjkkk
+KKCDDD
+KK (+++
+KK &)))
+KK '***
+KK (+++y'w7777'v666
+KK9::::   B
+  C KK3X>>>
+
+!
+#
+#C
+((8#(
+&
+&C
+KK
+#		HHJJEyy""i//@'JJJcdddHQKKKK 	 	 	OO@#(KKKHQKKKKKKKK	 OO8#(CCCHQKKKKKsM    CA	A55CA	CCK 8LLA6O> >
+Q4QQcmdargsc                    | j         }t                      \  }}}}}}t                              d           t          j                                        }|                    d|           |                    dd           |                    d           |	                    d| dd           |
+                    t          j        	          }		 t          j        |	                                          }	ne# t          j        $ rS}
+t                              d
+           t                              d|
+           t%          j        d           Y d }
+~
+nd }
+~
+ww xY wd|	d}t                              d|           t          j                    }|                    ||          }t                              d           |j        dk    r	 |                                }|                    d          dk    r5t                              d|           t                              d           t%          j        d           nK# t2          $ r>}
+t                              d|j                   t%          j        d           Y d }
+~
+nd }
+~
+ww xY wt                              d|j                   t%          j        d           d S )NzSigning challengeFromSubjectzb4-send-verifyutf-8zverify:
+charset)policyz-CRITICAL: Unable to sign verification messager3   r4   zauth-verify)r=   msgzSubmitting verification to %sr@   r;   rB   rC   rD   z&Challenge successfully verified for %sz5You may now use this endpoint for submitting patches.r   rE   rF   )auth_verifyr0   r   rS   r   messageEmailMessage
+add_headerset_charsetset_payloadas_bytesr   	emlpolicyr$   rfc2822_signrL   SigningErrorrH   rI   rJ   rV   rW   rX   rA   r   rY   rZ   )rf   vstrr'   r+   r*   r   r-   r.   cmsgbdatar[   ra   rb   rc   rd   s                  r/   rp   rp      s   D9I9K9K6Hfgxw
+KK#$$$=%%''DOOFG$$$OOI/000W't'''999MMM..E#E**1133   GHHH+++   C KK/:::
+
+!
+#
+#C
+((8#(
+&
+&C
+KK
+#		HHJJEyy""i//DgNNNSTTTHQKKKK 	 	 	OO@#(KKKHQKKKKKKKK	 OO8#(CCCHQKKKKKs2   &C9 9EA	EEA6I 
+J4JJ  revrangemaxrevsc                     d| g}t          j        d |          }|r2t          |          |k    rt          dt          |          z            t          |          S )Nzrev-listz*Too many commits in the range provided: %s)r   git_get_command_lineslenr"   )r~   r   gitargsliness       r/   get_rev_countr      s]    8$G$T733E V3u::''G#e**TUUUu::r1   
+basebranchmybranchc                 J   |t          j                    }t                              d|            dd| g}t          j        d |          }|s1t                              d|            t          d| d|d          |d         }t                              d	|| |           |S )
+NzFinding the fork-point with %sz
+merge-basez--fork-pointz0CRITICAL: Could not find common ancestor with %sz	Branches z and z have no common ancestorsr   z"Fork-point between %s and %s is %s)r   git_get_current_branchr   r    r   rH   r"   )r   r   r   r   	forkpoints        r/   get_base_forkpointr      s    ,..
+LL1:>>>^Z8G$T733E cJJWWWlJJJX`X`X`abbbaI
+LL5xYWWWr1   c                    t          j                    }d|vsd|vr.t                              d           t	          j        d           d x}x}x}x}}| j        rt          j        |           }t          j        |          }|s.t                              d           t	          j        d           t          j	                    }	|D ]}
+|	
+                    |
+           |	                                }|j        r#|j        d         }|j                            d          }|rt                              d           	 |                    d	          dk    r1|                    d
+d          }|d                                         }t)          j        |          }t-          j        |          }t1          j        |                                          }t                              d|           t7                      }t9          j        d|j        t8          j                  D ]8}t           j                             |          r n|!                    |           9d"                    |                                          }nN# tF          $ r?}t                              d           t                              d|           Y d }~n
+d }~ww xY w|}|s!t                              d           |j        }t9          j$        dd|t8          j                  }|j%         d| d|z   }|j&        }| j'        s|rK|                    d          }tQ          |          dk    r"d"                    |dd                   | _'        ne|j)        *                    d          }tQ          |          dk    r0d"                    |                    d          d d                   }|| _'        |j+        }|r)| j,        s"t                              d|           || _,        n|j        d         j        }|j-        dz   }|.                    d !          }t          /                    d"           t          j0                    }tc                      }d }| j'        rd }| j,        sd#| _,        |}n|d$k    rd%d&d'| j,        g}t          j2        d |          }|s4t                              d(| j,                   t	          j        d           |D ]V}|                    d          }|d         d)k    r%|d         |k    r%t                              d*|| j,                   |} nWn|}|Nt                              d+| j,                   t                              d,           t	          j        d           t9          j$        d-d| j'                                      d          3                                }d.|z  }d/d0|| j,        g} t          j4        d | d 1          \  }!}"|!dk    rIt                              d2|           t                              |"           t	          j        |!           t          /                    d3|           | j'        }#n| j5        rUd }t          j0                    }|}#t9          j$        d-d|                              d          3                                }| j5        }$d4d5|$g}t          j2        d |          }|rv	 tm          |$|          }%n`# tn          $ rS}t                              d6           t                              d|           t	          j        d           Y d }~nd }~ww xY w|$}nd7d8|$g}t          j4        d |          \  }!}"|!dk    r-t                              d9|$           to          d:|$z            |"                                }%t          j8        d |%          }&||&vr/t                              d;|$           t	          j        d           |d$k    r|&9                    |           t7          |&          D ],}'|':                    d<          r|&9                    |'           -tQ          |&          dk    r]t                              d=|$           t                              dd>"                    |&                     t	          j        d           tQ          |&          dk     r/t                              d?|$           t	          j        d           |&;                                }	 ty          |% d@          }(na# tn          $ rT}t                              dA|$           t                              d|           t	          j        d           Y d }~nd }~ww xY w|(rt          /                    dB|(           nt          /                    dC|$           |(r|d$k    rd7d#g}t          j2        d |          }|s.t                              dD           t	          j        d           |d                                         })|% d@|) }dEdF|%g}t          j4        d |d 1          \  }!}"|!dk    rIt                              dG|%           t                              |"           t	          j        d           t{                      \  }}*n.t                              dH           t	          j        d           t          j>        d dI| dJ|           |szdK|#z  dLdMdNdOdPdQdRdSdLdTdUdVdLdWdXdYdZd[dLd\|                    ddL          d]|                    ddL          d^dLdLf}d_"                    |          }t          /                    d`           |st~          j@        A                                B                    da          d|dt          jD                    jE        d db         }+|d}t7                      },| jF        rt7          | jF                  },nOt          jG                    }-|-                    dc          r'|-                    dc                                          },dd||+|,dei}|r||dd         df<   |d$k    r||dd         dg<   t          ||d h           |rQdi|g}t          j4        d |          \  }!}"|!dk    r/t                              dj|           t	          j        d           |r1t          /                    dktQ          |                     t          /                    d"           t          jJ                    }.t          jK        ||.           |.L                                }/t          j4        d dlg|/d m          \  }!}"t          /                    |"                                           |!dk    r/t                              dn|"           t	          j        |!           t          /                    d"           t          /                    do           d S d S )pNr   r   zSCRITICAL: Unable to add your Signed-off-by: git returned no user.name or user.emailr4   z#CRITICAL: no messages in the threadr   zx-b4-trackingz1Found x-b4-tracking header, attempting to restorezv=1; b=zb=maxsplitztracking: %s^---\nflagsz
+---
+z:CRITICAL: unable to restore tracking information, ignoringr3   z0Unrecognized cover letter format, will use as-isz^(#.*)$z>\1z
+
+EDITME: Imported from fz(
+        Please review before sending.
+
+-   F)with_counter   _   zUsing %s as fork-pointT)noaddtrailersr;   HEADcommitbranch-vz
+--containsz*CRITICAL: no branch contains fork-point %s*z$branch %s does contain fork-point %sz5CRITICAL: fork-point %s is not on the current branch.zE          Switch to the branch you want to use as base and try again.z\W+zb4/%scheckoutz-b)	logstderrz*CRITICAL: Failed to create a new branch %szCreated new branch %szshow-refz--headsz.CRITICAL: could not use %s as enrollment base:	rev-parsez--verifyz#CRITICAL: Could not find object: %szObject %s not foundz4CRITICAL: object %s does not exist on current branchb4/zPCRITICAL: Multiple branches contain object %s, please pass a branch name as base, z>CRITICAL: No other branch contains %s: cannot use as fork base..z)CRITICAL: could not use %s as fork point:zWill track %s commitsz*NOTE: No new commits since fork-point "%s"z*CRITICAL: Could not rev-parse current HEADresetz--hardz0CRITICAL: not able to reset current branch to %sz%CRITICAL: unknown operation requestedbranch.z.b4-prep-cover-strategyzEDITME: cover title for %sr   zC# Describe the purpose of this series. The information you put herezC# will be used by the project maintainer to make a decision whetherzH# your patches should be reviewed, and in what priority order. Please bezF# very detailed and link to any relevant discussions or sites that thezJ# maintainer can review to better understand your proposed changes. If youzD# only have a single patch in your series, the contents of the coverzF# letter will be appended to the "under-the-cut" portion of the patch.zF# Lines starting with # will be removed from the cover letter. You canzD# use them to add notes or reminders to yourself. If you want to usezB# markdown headers in your cover letter, start the line with ">#".zH# You can add trailers to the cover letter. Any email addresses found inzC# these trailers will be added to the addresses specified/generatedzF# during the b4 send stage. You can also run "b4 prep --auto-to-cc" toz@# auto-populate the To: and Cc: trailers based on the code beingz# modified.zSigned-off-by: z <>rk   zACreated the default cover letter, you can edit with --edit-cover.%Y%m%d   zsend-prefixesseries)revision	change-idprefixesfrom-threadbase-branch)newcherry-pickz+Could not cherry-pick commits from range %szApplying %s patchesamstdinr   z'Could not apply patches from thread: %szINOTE: any follow-up trailers were ignored; apply them with b4 trailers -u)Mr   r#   r   rH   rI   rJ   msgid	get_msgidget_pi_thread_by_msgidLoreMailboxadd_message
+get_series	has_coverpatchesro   r   r    findsplitstriprP   	b64decodegzip
+decompressrA   loadsrL   listr   bodyMDIFFSTAT_REr   appendr   rY   subsubject	change_idnew_series_namer   lsubjectget_slugbase_commit
+fork_pointr   get_am_readyrS   r   get_cover_strategyr   lowergit_run_commandenroll_baser   r"   git_branch_containsremove
+startswithpopr   
+load_covergit_set_configdatetimedatetodaystrftimeuuiduuid4hexset_prefixesr   store_coverioBytesIOsave_git_am_mboxgetvalue)0rf   r)   covertrackingr   thread_msgidr   r   	list_msgslmbxro   lserr{   b64trackingchunks	ztracking	btrackingcover_sectionssectionr[   r   cchunksslugr   r   strategycherry_ranger   r   r   line
+branchnameargsr]   r^   
+seriesnamer   r   headsheadcommitcountr'   jdatachangeidr   r&   ifhambytess0                                                   r/   start_new_seriesr     s    ""GWw 6 6mnnn;??E?H?w?} KW%%-e44	 	OOABBBHQKKK~ 	" 	"CS!!!!  > ;	1<?D(,,77K %PQQQ8 #''	22a77!,!2!24!!2!D!D&,Qioo&7&7 & 0 = =I $	 : :I#z)*:*:*<*<==HLL:::%)VVN#%8Ity#M#M#M 7 7>0099 "!E&--g6666%NN>::@@BBEE  8 8 8OO$`aaaOONB777777778
+  % "OPPP	 F:vuBDAAAE B B/4B B BEJKE I* 
+3 	3'ooc22G7||a''25((71R4=2I2I/=11u1EED4yy2~~"xx
+
+3(;<<.2G+*K 17#5 15{CCC%0"  <?0L =1$##$#77E(**H!##HL x
+! 	!'G!JJ 8###T<9KL0w??  OO$PRYRdeeeHQKKK!  D!ZZZ33FayC'' ayH,,%KXW^Wijjj%-
+ -
+ &
+! WY`Yklll ghhhvfc7#:;;AA#FFLLNNt^
+D*g.@A'ddCCC
+s199OOH*UUUOOC   HUOOO+Z888,
+
+		 O
+.00
+
+vfc:..44S99??AA)y+6(w77 #	).{HEE		    PQQQ333 %JJ #J<G+D'::JE3qyy E{SSS"#8;#FGGG		I*4;;Eu$$ VXcddd8##X&&& KK + +Du-- +T***u::>>OO$v$/1 1 1OONDIIe4D4DEEEHQKKKu::>>OO$dfqrrrHQKKK"YY[[
+	'9(8(8(899KK 	 	 	OOGUUUOONB///HQKKKKKKKK	
+  	SKK/====KKDkRRR 	8x//"F+G,T7;;E  LMMMQx~~''H'55855L)4G+D'TJJJJE3qyy RT]^^^$$$ "||uu 	?@@@ dIjIII8TTT Y-
+:VV[Y]WYYWU[VYS-4[[-D-D-D-DgkkRY[]F^F^F^F^_-0 		%  WXXX ;!)!4!4!6!6!?!?!I!I!I!I444QUQ[Q]Q]QabecebeQfQfgH66 	?G011HH'))Fzz/** ?!::o66<<>> $%$ 
+  	=0<HX}-x0:HX}-xT****  ,/'g66
+s199OOI<XXXHQKKK a)3w<<888Ejll
+GS))),,..'tfGtTTT
+sCIIKK   199OOEsKKKHUOOOE_`````a asK   EJ
+ 
+
+K5KK\ 
+]<)A	]77]<e! !
+f?+A
+f::f?datac                 H    t            d}|t          j        | d          z   S )NzE
+# This section is used internally by b4 prep for tracking purposes.
+r   )indent)MAGIC_MARKERrA   dumps)r  mjs     r/   make_magic_jsonr    s3     R R RB
+4*****r1   strip_commentsc                    t                      }|dv rt                      }|sd}t                      }nBddd|g}t          j        d |          \  }}|dk    r.t
+                              d           t          j        d           |}|	                    t                    \  }}	|		                    d	d
+          \  }
+}t          j        d	|z             }n|dk    rjt          j                    }t          j        d| d          }|                    dd          }t          j        |                    dd                    }n/t
+                              d|           t          j        d           t
+                              d|           | rbt#          j        dd|t"          j                  }t#          j        dd|t"          j                  }d|v r|                    dd          }d|v |                                |fS )N>   r   
+tip-commitr   showz-sz--format=%Br   z%CRITICAL: unable to load cover letterr4   {r   branch-descriptionbranch\.\..*descriptionb4-trackingz{}z'Not yet supported for %s cover strategyztracking data: %sz^#.*$r   z^>(#.*)$z\1z
+
+
+
+
+)r   find_cover_commitdictr   r   r   rH   rI   rJ   r   r  rA   r   r   get_config_from_gitr   r    r   r   r   replacer   )r  r   cover_commitr   r   r   r]   r^   contents
+magic_jsonjunkmdatar   bcfgs                 r/   r   r     s   !##H+++(** 	/EvvHHt]LAG+D'::JE3qyy GHHHH (| < <E:$**3*;;KD%z#+..HH	)	)	),..%&@(&@&@&@AA++:dhh}d;;<< 	A8LLL
+LL$h/// 4xU"$777{E5===%MM(F33E % ;;==(""r1   contentr   r   c                    t                      }|dv ri| dz   t          |          z   }|r{g d}t          j        d ||                                d          \  }}|dk    rCt
+                              d           t
+                              |           t          d          nt                      }|s)t
+                              d	           t          d
+          t                      }	|	
+                    ||           t          j                            ddd| dg          }| dg|_        t          j        ||	j                  }
+t
+                              d           |
+                                 |dk    rxt          j        d           }t          j        d d| d|            t+          j        |          }t          j        d d| d|           t
+                              d           d S d S )N>   r   r  r  )r   z--allow-empty-Fr   Tr   r   z0CRITICAL: Generating cover letter commit failed:zError saving cover letterz1CRITICAL: Could not find the cover letter commit.z,Error saving cover letter (commit not found)--force--quiet--refsz~1..HEADcommit_callbackz4Invoking git-filter-repo to update the cover letter.r  r   z.descriptionz.b4-trackingz-Updated branch description and tracking info.)r   r  r   r   rO   r   rH   r"   r  FRCommitMessageEditoraddfrFilteringOptions
+parse_argsrefs
+RepoFiltercallbackrS   runr   r   rA   r	  )r!  r   r   r   cover_messager   r]   r^   r   fredfrfr   trackstrs                r/   r   r   D  s   !##H+++&(?8+D+DD 	999D+D$m>R>R>T>T`deeeJE3qyy RSSS$$$"#>??? 
+ '((F S STTT"#QRRR(**DHHV]+++&119iV\SfSfSf2ghhD",,,-DI-dmDDDCKKNOOOGGIII''',T22
+$ @( @ @ @'JJJ:h''
+$ @( @ @ @(KKKCDDDDD ('r1   r   c                    | t          j                    } t          j        d|  d          }d|v r1|                    d          }t                              d|           n)t          j                    }|                    dd          }|dv r|S t                              d|           t          j	        d	           d S )
+Nr  r  zb4-prep-cover-strategyz"Got strategy=%s from branch-configzprep-cover-strategyr   >   r   r  r  z)CRITICAL: unknown prep-cover-strategy: %sr4   )
+r   r   r  r   r   r    r   rH   rI   rJ   )r   bconfigr   r&   s       r/   r   r   l  s    ~*,,$%=%=%=%=>>G7**;;78898DDDD#%%::3X>>AAA
+OO?JJJHQKKKKKr1   mustbec                    d}t          j                    }t          |          }|dv rBt                      2| r.t                              |           t          j        d           dS dS |dk    rat          j        d| d          }|	                    d	          rdS | r.t                              |           t          j        d           dS t                              d
+|           t          j        d           d S )Nz,CRITICAL: This is not a prep-managed branch.>   r   r  r4   FTr  r  r  r  z$CRITICAL: unknown cover strategy: %s)
+r   r   r   r  r   rH   rI   rJ   r  r   )r8  mustmsgr   r   r   s        r/   is_prep_branchr;    s    <G(**H!(++H+++& (((5t'''%&@(&@&@&@AA88M"" 	4 	OOG$$$HQKKKu
+OO:HEEEHQKKKKKr1   c                  
+   t                               dt                     ddt          ddddg} t          j        d |           }|sd S |d                                         d         }t                               d	|           |S )
+Nz:Looking for the cover letter commit with magic marker "%s"logz--grepr#  z--pretty=onelinez--max-count=1z--since=1.yearr   zCover commit found in %s)r   r    r  r   r   r   )r   r   founds      r/   r  r    s     LLM|\\\hd4FYijG$T733E t!HNNQE
+LL+U333Lr1   c                   J    e Zd ZU eed<   ddee         fdZdedefdZd Z	dS )	r)  edit_mapNc                 B    |r	|| _         d S t                      | _         d S N)r@  r  )selfr@  s     r/   __init__zFRCommitMessageEditor.__init__  s$     	#$DMMM FFDMMMr1   r   rq   c                 b    |                                 | j        |                                 <   d S rB  )rO   r@  )rC  r   rq   s      r/   r*  zFRCommitMessageEditor.add  s&    )0)9)9fmmoo&&&r1   c                 T    |j         | j        v r| j        |j                  |_        d S d S rB  )original_idr@  rq   )rC  r   metadatas      r/   r0  zFRCommitMessageEditor.callback  s/    ..!]6+=>FNNN /.r1   rB  )
+__name__
+__module____qualname__r  __annotations__r   rD  strr*  r0   r1   r/   r)  r)    st         NNN# #$ # # # #:# : : : : :? ? ? ? ?r1   r)  c                     ddl m}  t                      \  }}t          j        ddt
+          j                            dd          i          }|                    d          }t          	                    d|           t          |d         d	         d
+z
+  d
+          }t          t          |          d                              d          }d                    d |D                       }d}d}t          j        d          5 }	t
+          j                            |	d          }
+t%          |
+d          5 }|                    |                                           |                    d|                                z              |                    d           |                    |                                           d d d            n# 1 swxY w Y   t+          j        |d          }d|_        t/          |          |
+gz   }t          	                    dd                    |          z             t1          j        |          }|                                 t%          |
+d          5 }|                                                    d                                          } | |d|          }d d d            n# 1 swxY w Y   d d d            n# 1 swxY w Y   ||k    rt                              d           d S t?          |                                          st                              d           d S tA          ||           t                              d           d S ) Nr   )r   zcore\..*editorEDITORviz	editor=%sr   r   r4   T)	compareto
+get_outputrk   c                     g | ]}d |z   S )z# rN  ).0r   s     r/   
+<listcomp>zedit_cover.<locals>.<listcomp>  s    #O#O#ODD4K#O#O#Or1   z######z######(.|\n)*zb4-)prefixCOMMIT_EDITMSGab   
+posix
+Running %s rbr  )errorsr   zCover letter unchanged.z6New cover letter blank, leaving current one unchanged.zCover letter updated.)!r   r   r   r   r  r   environr   r   r    maxcomparerM  r   r   tempfileTemporaryDirectoryr   openwriterO   shlexwhitespace_splitr   
+subprocessPopenwaitreadrL   r   rS   r   r   )r   r   r   corecfgrP  previous_revisiondiff_prev_revisiondiff_revision_sepdiff_revision_patttemp_dir
+temp_fpath
+temp_coversprf   	new_covers                  r/   
+edit_coverry    s    llOE8$[8RZ^^HVZ=[=[2\]]G[[""F
+LLf%%%HX.z:Q>BB 3/@+A+AdSSSYYZ^__#O#O<N#O#O#OPP )		$E	2	2	2 ?hW\\(,<==
+*d## 	:zU\\^^,,,U%6%=%=%?%??@@@U###/6688999		: 	: 	: 	: 	: 	: 	: 	: 	: 	: 	: 	: 	: 	: 	: [t,,,"r((j\)\CHHW$5$55666g&&
+			*d## 	?z"))00	0BBHHJJI.I>>I	? 	? 	? 	? 	? 	? 	? 	? 	? 	? 	? 	? 	? 	? 	?? ? ? ? ? ? ? ? ? ? ? ? ? ? ?& E-...y  !! LMMM	8$$$
+KK'(((((s]   1K6BGKG	KG	BK3AK;KK	KK	KK"%K"c                  V   t                      } d }| dk    rt                      S | dk    rt          j                    }t          j        d| d          }|                    d          }|s/t                              d|           t          j	        d           t          j        |          }|d         d	         }	 t          |          }t          | d
+          }n$# t          $ r t          j	        d           Y nw xY wt                              d||           | dk    rt!                      \  }}|d         d	         }	 t          |          }t          | d          }n$# t          $ r t          j	        d           Y nw xY wt                              d||           |S )Nr   r  r  r  r  z-CRITICAL: Could not find tracking info for %sr4   r   r   r   z series_start: %s, commitcount=%sr  z..HEAD~1)r   r  r   r   r  r   r   rH   rI   rJ   rA   r   r   r   r"   r    r   )	r   r   r   r   r   r   r   r   r   s	            r/   get_series_startr{    s   !##HI8 """''',..%&@(&@&@&@AA88M** 	OOKXVVVHQKKK
+8$$8_]3
+	*:66I'9(8(8(899KK 	 	 	HQKKKKK	7KPPP<$,,xh'6
+	*:66I'9(>(>(>??KK 	 	 	HQKKKKK	7KPPPs$   ?!C! !DD!E) )F
+	F
+c                    t           j        s5| j        s.t                              d           t          j        d           t          j                    }d|vsd|vr.t                              d           t          j        d           d }t                      rt                      }d}t          d          \  }}|d	                             d
+          }| j        r| j        }n|d	                             d          }t                      }	|	dv rt                      }
+|
+r|
+h}n	| j        s| j        r| j        r| j        | _        t          j        |           }d }|d         }dddd| d| j        dg}t          j        d |          }|s/t                              d|           t          j        d           d x}x}}|D ]2}|                                \  }}||}||}"||}||k    r n|}|}3||}| d}n.t                              d           t          j        d           	 t          j        d |||          }nF# t*          $ r9}t                              d|           t          j        d           Y d }~nd }~ww xY wt                              d           t/                      }t/                      }t/                      }t/                      }|D ]\  }}|s|||<   t           j                            |          \  }}t           j                            |          }t          j        |                    d                    }|||j        <   |||<   t;                      }|rJt           j        r>t                              d|           d| d}t          j        |d          } | || z  }|s| j        ro|r|| _        	 t          j        |           \  }}!nF# t@          $ r9}t                              d|           t          j        d           Y d }~nd }~ww xY w|!||!z  }|rt          j!                    }"|D ]}#|""                    |#           |"#                    | j$                  }$t;          |$j%                  }%|$j&        dd          D ]}&t;                      }'|&j'        r|'t;          |&j'                  z  }'|$j(        r4|$j&        d          j'        r"|'t;          |$j&        d          j'                  z  }'|'s!t          )                    d!|&j                   d }|&j        |v r||&j                 }n0t           j                            |&j*                  }||v r||         }|s!t          )                    d"|&j+                   t           j                            ||                   \  }(})t           j        ,                    |(          }*|'D ]<}+|+|*d#         vr0||vrt;                      ||<   ||         -                    |+           =| j$        st|%rrt;          |%          D ]b},t          j.        |,d          |,d         $          |*d#         v r6t          )                    d%|,d                     |%/                    |,           cta          |%          rt                              d&           t                              d'           |$j%        D ]?\  }-}.}/}0t                              d(|-|.           t                              d)|/|0           @t                              d*           |st                              d+           d S t                              d&           tc                      }1|2                                D ]\  }}2t          j        ||                   }3t                              d,|3j                   ta          |2          r|2|3_'        |33                                 |14                    ||3j5                   t                              d&           tl          j7        8                    d-d.d/| d0g          }4| d0g|4_9        tm          j:        |4|1j;        1          }5t                              d2           |5<                                 t                              d3           d S )4NzCCRITICAL: To work in offline mode you have to pass a local mailbox.r4   r   r   z2CRITICAL: Please set your user.name and user.emailr   Tr  r   r   r   >   r   r  r=  r#  z--no-mergesz--committer=z--sincez--format=%H %Pz7CRITICAL: could not find any commits where committer=%s~1zBCRITICAL: Please specify -F msgid to look up trailers from remote.ignore_commits0CRITICAL: Failed to convert range to patches: %sz=Calculating patch-ids from commits, this may take a moment...r   zChecking change-id "%s"z"change-id: ")nocacheCRITICAL: %s)sloppytrailersr   z'No new follow-up trailers to add to: %szNo match for %sr   r   valuez$Removing already-applied mismatch %sr;   z9NOTE: some trailers ignored due to from/email mismatches:z    ! Trailer: %s: %sz     Msg From: %s <%s>z(NOTE: Rerun with -S to apply them anywayzNo trailer updates found.  %sr$  r%  r&  r   r'  z,Invoking git-filter-repo to update trailers.zTrailers updated.)=r   can_network	localmboxr   rH   rI   rJ   r#   r;  r{  r   r   trailers_fromr   r  r   r   sincer   r   git_range_to_patchesr"   rS   r  LoreMessageget_payloadget_patch_idLoreSubjectr   r   get_pi_search_resultsretrieve_messagesLookupErrorr   r   r   r  trailer_mismatchesr   followup_trailersr   r    r   full_subjectget_body_partsr   LoreTrailerr   r   r)  itemsfix_trailersr*  rq   r+  r,  r-  r.  r/  r0  r1  )6rf   r)   r  startendr   r   r  r   r   r  r*   r   r   
+prevparent
+prevcommitr   r   parentr   r[   
+commit_map
+by_patchid
+by_subjectupdatesro   r   rm   patchidlsr   querysmsgstmsgsbboxlist_msgr   
+mismatcheslmsgaddtrailersmbodymcharsetpartsfltrmismatchtnametvaluefnamefemailr3  newtrailersr{   r   r4  s6                                                         r/   update_trailersr    s	   > '"3 ]^^^ ""GWw 6 6LMMMN 3 ""$D999xH%))+66  	:)EEX&**=99E%''///,..L 0".	 #'/ #  	2#1GMW%%'" $/Gg/G/GT[Tacst(w77 	OOUW^___HQKKK(,,
+,Z# 	  	 D!ZZ\\NFF{!#
+!#
+V##JJJJ!!!\]]])$s>ZZZ   JBOOO KKOPPPJJJffG % % 	 
+622377g.--d33^CGGI..//!'
+2:$
+7I BN -x888*x***(===I 	! 	 	"!GM	/88LE55 	 	 	OONB///HQKKKKKKKK	 I /H~! 	' 	'HX&&&&g.DEE$122
+L$  	4  	4D&&K% <tD$:;;;~ G$,q/"C GtDLO$EFFF FUUUF|z))#DL1.55di@@j(('0F .0ABBB n88F9KLLOE8N11%88E# 1 1uQx''W,,*.&&FO**4000) 4j 4 $Z 0 0 4 4H~8A;hqkJJJeTUhVV%KXVW[YYY"))(333z?? 	HOOE"""OOWXXX040G I I,vuf 7GGG 8%HHHHOOFGGG /000
+KK ""D&}} ' '~j011FDL))){ 	1%0D"&&&&
+KK))9ie<<<*XYYDDI
+-dm
+<
+<
+<C
+KK>???GGIII
+KK#$$$$$s0   4I 
+J/JJO1 1
+P4;/P//P4msgbytesc                 B   | st                      S t          j                    }t          j        | ||          \  }}}|dk    rt                              dd                    |                      t                              |                                           t          dd                    |           z            |	                                                                }|st                      S t          j        |                    d                    S )N)r   rundirr   zCRITICAL: Running %s failed:r_  zRunning command failed: %srk   )r   r   r   _run_commandr   rH   r   rL   r"   r   r   getaddressesr   )rf   r  r(   r]   r^   r_   addrss          r/   get_addresses_from_cmdr    s     vv ""FogXfMMMOE3qyy68I8IJJJ
+
+%%%7#((7:K:KKLLLIIKK  E vvekk$//000r1   start_commitc                    | st                      } t                      }|dk    r%d|  dg}t          j        d |          }|d         }n| }|dk    r&t	                      }t          j        | d          }nt          j        d          }d|  d| g}t          j        d |          \  }}d	d
+|  d| g}t          j        d |          \  }}	dd|  d| g}t          j        d |          \  }}
+|
+                                                                }
+|| ||
+|                                |	                                fS )Nr   r   r~  r   r  r   shortlogr   diffz--statr=  z	--oneline)	r{  r   r   r   r  git_revparse_objr   rstrip
+splitlines)r  r   r   r   r   r  endranger]   r  diffstatonelines              r/   get_series_detailsr    sq    *'))!##H8< 3 3 34(w77Ah"<(**&,':':':;;&v..l88h889G(w77OE8xL!>!>H!>!>?G(w77OE8kl#@#@h#@#@AG'g66NE7nn))++Gh9J9JHOOL]L]]]r1   r  hdrnamec                 \   t          |           dk     rd S t                              d|t          j        | d         g                     t          |           dk    rL| dd          D ]C}t                              ddt          |          z  t          j        |g                     Bd S d S )Nr4   z%s: %sr   z%s  %sr_  )r   r   rS   r   format_addrs)r  r  addrs      r/   print_pretty_addrsr    s    
+5zzA~~
+KK'2?E!H:#>#>???
+5zzA~~!""I 	O 	ODKK#G"4botf6M6MNNNN ~	O 	Or1   tagnamec                    dd| g}t          j        d |          \  }}|dk    rt          d| z            |                    dd          \  }}t	          j        d|t          j        t          j        z  	          }|st          d
+| z            |                                d         }t	          j        d|t          j        t          j        z  	          }|st          d| z            |                                d         }|||fS )Nzcat-filez-pr   zNo such tag: %sr  r4   r   z^base-commit:\s*(.*)$r   z(Tag %s does not contain base-commit infoz^change-id:\s*(.*)$z&Tag %s does not contain change-id info)	r   r   r"   r   r   r   Ir   groups)	r  r   r]   tagmsgr  r   matchesr   r   s	            r/   get_base_changeid_from_tagr    s   4)G&tW55ME6qyy,w6777,,v,22KD%i0%rtbd{KKKG QEOPPP..""1%Ki.RTBD[IIIG OCgMNNN  #I+y((r1   r   r   domainc           	      *   |sCt          j                    }|                    d          }|rt          j        dd|          }nd}|                     dd          }|d         }|                    dd          }t          |          d	k    rUt          |d                   d
+k    r<t          j	        
+                                                    d          d|d         }t          j                    j        d d         }d| d| d| d| d	}|S )Nr   z^[^@]*@r   r   r   r4   r   r   r      r   r   <r   z-%s-@r   )r   r#   r   r   r   rsplitr   r   r   r   r   r   r   r   r   )	r   r   r  r)   r*   r   
+stablepart
+randompart	msgid_tpts	            r/   make_msgid_tptr    s%    $&&++g&& 	VJG44FF FcA..FJcA..F
+6{{aCq	NNa// ( 3 3 5 5 > >x H H H H&QR))T
+ !#2#&JFJFF(FF
+FFVFFFIr1   cbodyc                    t           j                            |           \  }}}}}t                      }t                      }t          |          D ]w}|j        dk    r0|                    |j                   |                    |           =|j        dk    r/|                    |j                   |                    |           xt           j                            |||||          } ||| fS )Ntocc)	r   r  r  r   lnamer   r  r   rebuild_message)	r  htrsr{   mtrsbasementsigtosccsmtrs	            r/   get_cover_destsr    s    &(n&C&CE&J&J#D$h
+&&C
+&&CDzz  9JJsx   KKY$JJsx   KKN**4tXsKKEU?r1   csubjectr  r   datetsthreadc                    |d         d         }t           j                                        }|                    d|d                    t	          j        |d                   }|j        | _        d| _        |j        | _        |                    d| 	                    |
+                                                     |                    dt           j                            |d                     |                    d	|t          d          z             |                    |d
+           |                    d
+           |                    dd|f           |rt#          |           d S d S )Nr   r4   rh   ri   )	eprefixesDateT)	localtimez
+Message-Idrj   rl   r   )r   rq   rr   rs   r   r  expectedcounterr   get_rebuilt_subjectget_extra_prefixesr   
+formatdaterM  ru   rt   insertrethread)	r  r  r   r  r  r  fpr{   fplss	            r/   	add_coverr   !  sM   	AB=%%''DOOFBvJ'''>"Y-((DHHHOOIx;;dF]F]F_F_;``aaaOOFEK226T2JJKKKOOL)c!ff"4555UG,,,WNN1r4j!!!  r1   c                 ^   |d         d         }t           j                            |          \  }}t           j                            |          \  }}}}}	t           j                            |           \  }
+}}}}t	                      }|                    d          dz   }t	          |          D ]$}||v s	|j        dv r|                    |           %|r&|r|dz  }|D ]}||                                dz   z  }t          |
+                                          r|                    |           d }t          j        d|t          j                  D ]~}t          j        t           j        |          r"t          j        d|t          j        t          j        z            r|}S|                    |
+                    d          dz              |                    |                    d          d	z              |r|                    |           d
+                    |          }t           j                            |||||          }|                    |d           |                    d          dk    r,|                                s|                    dd           d S d S d S )Nr   r4   z
+rk   )r  r  r   r   z^change-id: r  ---
+rj   rl   zContent-Transfer-Encoding8bit)r   r  r  r  r   r  r  r   	as_stringr   r   r   r   r   r   r   r   r  r   r  ru   r   isasciireplace_header)r  r   ro   pbodypcharsetpheaderspmessage	ptrailers	pbasement
+psignaturecheaderscmessage	ctrailers	cbasement
+csignaturenbpartsnmessagectrutilityr   newbasements                        r/   mixin_coverr  7  s   
+!*Q-Cn0055OE8;=>;X;XY^;_;_8Hh	9j;=>;X;XY^;_;_8Hh	9jffGv&&-HI " " )syL88S!!! / 	H 	/ 	/C$..HH
+8>> !x    G8Iy=== 5 59R^W-- 	9_gRTBD[AAA 	Gw}}V,,t34444NN9##F++f4555  w,,w''KN**8Xy+WabbEOOE7O+++
+ww*++v55emmoo56????? 6555r1   r   c                    |                                  }t          |          dk     sNt          |d                                                   s't          |d                                                   sd}|                                 }n7|d         }d                    |dd                                                    }t	          j        |          }||fS )Nr   r4   r   z(no cover subject)rk   )r  r   r   r   r   r  )r   clinesr  r  r   s        r/   get_cover_subject_bodyr  f  s    F
+6{{Q#fQioo//00F1IOO<M<M8N8N'!9		&*%%++--~h''HU?r1   c                     | d         d                              d          }| dd          D ]1\  }}|                    d|           |                    d|           2d S )Nr   r4   z
+message-id
+ReferenceszIn-Reply-To)r   rs   )r   reftor   ro   s       r/   r  r  s  sm    QZ]|,,Eqrr{ - -|U+++}e,,,,- -r1   c                     t          j                    } |                     d          }|rt          j                            |          S t          j                    }|                    d          |                    d          fS )Nfromr   r   )r   get_sendemail_configr   r   r   	parseaddrr#   )sconfigfromaddrr)   s      r/   get_mailfromr%  z  sp    %''G{{6""H /{$$X... ""G;;vG 4 444r1   movefromaddtrackingc                    t          d          \  }}|d                             dt                                }t                      }|d                             d          }|d                             d          }t	          ||          }	t          t          j                              }
+d }| rt                      }t                      }d }|dv rt                      }|r|h}t          |          \  }}|                    |          D ]}|                    |           t          j        d |d	|||	|
+||
+	  	        }t          |          \  }}}}}}t          j                    }t"          }|                    d          ra	 t          j        |d                   }nE# t&          $ r8 t(                              d|d                    t-          j        d           Y nw xY w|||||t          j                    d}t3          |                                                              |          }t9          j        t=          t?          j         |          d                    }tC          j"        |          #                                }tI          j%        d|z   dd          }d&                    |          '                    dd          } tQ          |          \  }!}"}tS          |          dk    rtU          ||           ntW          ||	|||
+|           |r"|d         d         ,                    d|            |j-        }#|rdd&                    |          z   d|# z   }#|# d| }$|!|"|$|fS )NTr}  r   r   r   r   >   r   r  excluder   )r   r   r  seriestsmailfromr  )r  zprep-cover-templatez@ERROR: prep-cover-template says to use %s, but it does not existr   )r   r  r  r   r   	signaturerj   zX-B4-Tracking: v=1; b=r_  K   )subsequent_indentwidthr   zX-B4-Tracking: r4   )r  r   zX-B4-Tracking[r   ] r  ).r   r   r   r{  r  inttimer%  r   r  r  r  r   r   r  r  r   DEFAULT_COVER_TEMPLATEread_templateFileNotFoundErrorr   rH   rI   rJ   get_email_signaturer   lstripsafe_substituter   compressbytesrA   r	  rP   rQ   rL   textwrapwrapr   r  r  r   r  r   rs   r  )%r&  r  r'  r   r   r   r  r   r   r  r+  r,  r   r  r  r  r  cprefixr   r   stcendcr  r  r  r&   cover_templatetptvalscover_letterr   r   wrappedthdataalltosallccsheadertag_msgs%                                        r/   get_prep_branch_as_patchesrK    s    555OE8!%%j$&&99H#%%L"&&{33I!%%j11Hy(33I49;;HH ">>!##HN+++(** 	,*^N,U33OHe..x.@@ ! !    %dL&/7/709/7/75CE E EG ;MZf:g:g:g7KdGXx!!F+Nzz'(( 	-f5J.KLLNN  	 	 	OO^"#89; ; ;HQKKKKK	 "+-- G N113344DDWMML eDJx$8$8'BBCCI"9--4466Km4{BVYacdddGWWW%%&7<<F+L99FFE
+7||qE7####(IwxOOOO :
+1  &999"F ;tyy***]&]]:++\++G67G++s   F( (?G*)G*c           
+      D   t          |           \  }}}t          |          \  }}|                                dz   t          j                    z   }dg|                    dg          z   }t          |t          |                    }t          t          j	                              }	t                      }
+t          j        d || ||||	|
+          }t          |          \  }}}t          |          dk    rt          ||           nt          |||||	           |||fS )N
+-- 
+RESENDr)  )r   r   r  r+  r,  r4   )r  r  r   r   r8  r  r  rM  r3  r4  r%  r  r  r   r  r   )r  r   r   r   r   r  r  r   r  r+  r,  r   rG  rH  s                 r/   get_sent_tag_as_patchesrO    s    $>w$G$G!E;	,U33OHeKKMMI%(>(@(@@EzH77
+7KKKHy#h--88I49;;H~~H%dK/7/709/7/79 9 9G ,E22FFE
+7||qE7####(Iwx@@@67""r1   
+output_dirc                 ~   	 t          ddd          \  }}}}nF# t          $ r9}t                              d|           t	          j        d           Y d }~nd }~ww xY wt                              dt          |          |            t          j	        |           
+                    dd           |D ]\  }}|s	t          j                            dd	          |_        |                    d
+d          }t          j        |          }	d|	                    d          z  }
+t%          t&          j                            | |
+          d          5 }|                    |                    dt          j                             t                              d|
+           d d d            n# 1 swxY w Y   	d S )NF)r  r&  r'  r  r4   zWriting %s messages into %sTparentsexist_okr  )utf8cte_typeri   r   z%s.patchr   )sepwb)unixfromrn   r  )rK  r"   r   rH   rI   rJ   rS   r   pathlibr	   mkdirr   rn   EmailPolicyr   r   r  r   rg  r   r   r   rh  rv   rw   )rP  r  r  tstrr   r[   r   ro   r   r  filenfhs               r/   format_patchr`    s   "<ETYgl"m"m"mS$   JBOOO KK-s7||ZHHHL""4$"??? 	' 	' 	\--4&-II
+'')R((^G$$R[[S[111"',,z511488 	'BHHS\\4\EEFFFKK&&&	' 	' 	' 	' 	' 	' 	' 	' 	' 	' 	' 	' 	' 	' 	'	' 	's'    
+A/AAAF00F4	7F4	c                 &   | j         rt                       d S | j        rt          |            d S t          j                    }t          j                    }d }d }| j        r| j        dk    r#t                      \  }}|d         d         dz
+  }n| j        }t          |t          |          \  }}	|	/t          
+                    d|           t          j        d           	 t          ||	          \  }
+}}nF# t          $ r9}t          
+                    d|           t          j        d           Y d }~nd }~ww xY wt                              dt!          |                     nt          d	
+          \  }}t          j                    }t!          |          rHt          
+                    d           t          
+                    d           t          j        d           	 t%                      \  }
+}}}nF# t          $ r9}t          
+                    d|           t          j        d           Y d }~nd }~ww xY wdt          j                            |d         d                   v r|t          
+                    d           t                              d           t                              |           t                              d           t          j        d           t                              dt!          |                     t          j                    }|                    d          }t/                      }t/                      }t1                      }| j        rt5                      }
+t5                      }n|                    d |
+D                        |                    d |D                        |D ]\  }}|s	t          j                            |          \  }}t          j                            |          \  }}|D ]}|j        dk    r|j        d         |v r|rE||vrt5                      ||<   |j        ||         vr ||                              |j                   e|!                    |j        d                    |j"        dk    r|
+                     |j                   |                     |j                   t          j#                    }| j$        r|!                    |           t/                      }| j%        r|                    | j%                   |                    d          r(|!                    |                    d                     |r_tM          j'        t5          |                    D ]=}|d         |v r|!                    |d                    |
+                     |           >t/                      }| j(        r|                    | j(                   |                    d          r(|!                    |                    d                     |r_tM          j'        t5          |                    D ]=}|d         |v r|!                    |d                    |                     |           >t5                      }t5                      }t/                      } |
+rBt          j)        |
+|d           }|                     t/          d |D                                  |rBt          j)        ||d           }|                     t/          d |D                                  t!          |           s.t          
+                    d           t          j        d           t!          |          st5          |          }t5                      }| j*        rUd	| _+        t                              d| j*                   tY          j-        | j*                  .                    d	d	           t          j/                    }!d }"|!                    d          s|                    d d!          }"ta          j1        d"|"          st          2                    d#|"           d }"|"sqt          j3                    }#th          j5        6                    th          j5        7                    |#d$                    r!t          2                    d%           tp          }"| j+        st                              d           ts          |d&           ts          |d'           t                              d           |D ]\  }}|st                              d(ta          j:        d)d*t          j        ;                    |                    d+                                         ||v rJt5                      }$||         D ]!}|d         |vr|$                     |           "|$rts          |$d,           t                              d           t          j                    }|d         }%t                              d-           |"rZ| j<        rt                              d.|%           nt                              d/           t                              d0|"           n|!                    d1          r|!                    d1          }%| j<        rt                              d.|%           nt                              d2           t                              d3|%           |!                    dd4          }&d5|&v r"t                              d6|&           | j<        r|!                    d7          |&k    rt          
+                    d           t          
+                    d8|&           t          
+                    d9           t          
+                    d:           t          
+                    d           t          
+                    d;           t          
+                    d<           t          
+                    d=|&           t          j        d           nt                              d>|&           | j<        s!| j        st                              d?           t                              d!           | j<        rt                              d@           t                              dA           t                              dB           t                              dC|%           t                              d!           t                              dD           t                              d!           	 t{          dE           n># t|          $ r1 t                              d!           t          j        dF           Y nw xY wd	}'| j?        s*|                    dGd!          @                                dHv rdI}'t5                      }(|D ]_\  }}|s	|st          j        A                    |          }t5          |          })t5          |          }*|d&         r)|)t          j&        '                    |d&         g          z  })|d'         r)|*t          j&        '                    |d'         g          z  }*|r/||v r+||         D ]!}|d         |vr|*                     |           "ny|swt!          |          rht/          |          }+|C                                D ]D\  },}-|-D ]<}|d         |+vr0|*                     |           |+!                    |d                    =E|*r|)s|*})t5                      }*|)rot          j)        |)|d           }.|d&         r)|D                    d&t          jE        |.                     n(|F                    d&t          jE        |.                     |*rot          j)        |*|d           }/|d'         r)|D                    d't          jE        |/                     n(|F                    d't          jE        |/                     |(                     |           adJ}0|"r|'sHt          
+                    dK           t          
+                    dL           t          j        d           	 t          jG        d |(d d	| j+        | j*        |"| j<        M          }1n9# t          $ r9}t          
+                    dN|           t          j        d           Y d }~nd }~ww xY w	 t          jH        | j+        O          \  }2}%n_# t          $ rR}t          
+                    dP           t          
+                    |           t          j        d           Y d }~nd }~ww xY w	 t          jG        |2|(|%|'| j+        | j*        | j<        Q          \  }1}0nF# t          $ r9}t          
+                    dN|           t          j        d           Y d }~nd }~ww xY wt                              d           | j+        r*t                              dRt!          |(                     d S |1s.t          
+                    dS           t          j        d           | j<        r7t                              dT|1           t          2                    dU           d S t                              dV|1           | j        rt          2                    dW           d S t          ||||0X           d S )YNlatestr   r   r4   z%Could not figure out revision from %s)r   z.CRITICAL: Failed to convert tag to patches: %sz Converted the tag to %s messagesTr}  2CRITICAL: Repository contains uncommitted changes.%          Stash or commit them first.r  s   EDITMEr   z?CRITICAL: Looks like the cover letter needs to be edited first.r;   z#Converted the branch to %s messagesr   c                     g | ]
+}|d          S r4   rN  rV  xs     r/   rW  zcmd_send.<locals>.<listcomp>K      +++aQqT+++r1   c                     g | ]
+}|d          S rf  rN  rg  s     r/   rW  zcmd_send.<locals>.<listcomp>L  ri  r1   personr  send-series-tosend-series-ccc                     g | ]
+}|d          S rf  rN  rg  s     r/   rW  zcmd_send.<locals>.<listcomp>      111aQqT111r1   c                     g | ]
+}|d          S rf  rN  rg  s     r/   rW  zcmd_send.<locals>.<listcomp>  ro  r1   zOCRITICAL: Could not find any destination addresses (try: b4 prep --auto-to-cc).zWill write out messages into %srR  
+smtpserverr   r   r   z0Endpoint does not start with https, ignoring: %sr   r   ToCcr  z\s+r_  ri   z    +Ccz	Ready to:z5  - send the above messages to just %s (REFLECT MODE)z0  - send the above messages to actual recipientsz  - via web endpoint: %sr   z7  - send the above messages to actual listed recipientsz  - with envelope-from: %s	localhost/z  - via local command %szb4-really-reflect-viaz.CRITICAL: Cowardly refusing to reflect via %s.zI          There is no guarantee that this command will do the right thingz6          and will not send mail to actual addressees.zEIf you are ABSOLUTELY SURE that this command will do the right thing,z-add the following to the [sendemail] section:zb4-really-reflect-via = %sz  - via SMTP server %sz2  - tag and reroll the series to the next revisionzREFLECT MODE:zA    The To: and Cc: headers will be fully populated, but the onlyz@    address given to the mail server for actual delivery will bez    %szB    Addresses in To: and Cc: headers will NOT receive this series.z)Press Enter to proceed or Ctrl-C to abortr<   zsend-no-patatt-sign>   yyestrueFdummyzJCRITICAL: Web endpoint will be used for sending, but signing is turned offz.          Please re-enable signing or use SMTP)r$  patatt_signdryrunrP  web_endpointreflectr  )r{  z(Failed to configure the smtp connection:)r$  rz  r{  rP  r}  z#DRYRUN: Would have sent %s messagesz(CRITICAL: Was not able to send messages.zReflected %s messagesz&Not updating cover/tracking on reflectzSent %s messagesz%Not updating cover/tracking on resend)subj)Kre   rp   r   r   r   resendr   get_sent_tagnameSENT_TAG_PREFIXr   rH   rI   rJ   rO  r"   rS   r   git_get_repo_statusrK  r  get_msg_as_bytesr#   r   setr  no_trailer_to_ccr   updater  find_trailerstyper  r   r*  r  get_excluded_addrs
+not_me_toor  r   r  r  cleanup_email_addrsrP  r{  rZ  r	   r[  r!  r   r   r    r   r   r   r   r   r!   r  r   clean_headerr}  rT   rU   no_signr   get_clean_msgidr   r  r  r  rs   	send_mailget_smtprY   reroll)3rf   r   r&   rJ  cl_msgidr   r   revstrr  r   todestsccdestsr   r[   statusr)   r*   seenexcludespccsr   ro   r   rm   btrsr  btrr  pairr  alltoallccalldestsr#  r'   r(   extraccr$  rq  sign	send_msgsmytomycc_seen_commit_ccsptopccr~  sentsmtps3                                                      r/   cmd_sendr    s    
+
+
+ G(**H!!FGH~ +I>X%%(llOE8h'
+3a7FF^F,XOOOOCVLLLHQKKK	(?RZ([([([%GWgg 	 	 	OOLbQQQHQKKKKKKKK	 	6GEEEE %D999x'))v;; 	OOPQQQOOCDDDHQKKK	1K1M1M.GWgww 	 	 	OONPRSSSHQKKKKKKKK	
+ 77
+1FFFFOO]^^^KKKKKKHQKKK93w<<HHH ""Gkk'""G55DuuH66D "&&&&++7+++,,,++7+++,,," 	) 	)KFC N66s;;MD'55d;;JD$ ) )8x''8A;$&& T))'+vvVxtF|33V++CH555!%%%9$$NN38,,,sx(((()" (** 	"LL!!!
+%%Cz 
+
+7:zz"## .
+
++,,---
+ !&tCyy11 	! 	!DAw$HHT!WNN4    
+%%Cz 
+
+7:zz"## .
+
++,,---
+ !&tCyy11 	! 	!DAw$HHT!WNN4    FFEFFEuuH 4&w$??11511122333 4&w$??11511122333x== ijjju:: U L5w7IJJJW'((..td.KKK%''G H;;|$$ 
+,::1266y11 	LLKXVVVH 	,(**Fw~~bgll69==>> ,\]]]+ > DE5$'''5$'''E" 
+	; 
+	;KFC KKvsBN4O4OPSPWPWXaPbPb4c4c d deee~~&& L - -DAwd**t,,, ;&w	:::E$&&7#K    	B PSU]^^^^NOOOKK2H===={{6"" /";;v.. WSU]^^^^UVVVKK4h??? \;??Jj  6
+CCC? 	 w{{3J'K'Kz'Y'YOOE***OO$TV`aaaOO$opppOO$\]]]OOE***OO$klllOO$STTTOO$@*MMMHQKKK 4jAAA 	N7> 	NKKLMMMB? 	KK(((KK[\\\KKZ[[[KK(+++KKOOOKK\]]]KKOOO	=>>>>  	 	 	KKOOOHSMMMMM	
+ D &**%:B??EEGGK___I , , 	 	;~55c::HE{{E{{t9 	:EK,,c$i[999Dt9 	:EK,,c$i[999D  	+fnnV & &7$&&KK%%%&  	+CII 	+IIE!% + +  + +DAwe++D)))		$q'***+  	 	D66D 	;(x>>C4y ;""4)=)=>>>>tR_S%9%9::: 	;(x>>C4y ;""4)=)=>>>>tR_S%9%9:::	D  	OOhiiiOOLMMMHQKKK	<i$D'.~'BTck(/9 9 9DD  	 	 	OONB///HQKKKKKKKK		[???ND(( 	 	 	OOFGGGOOBHQKKKKKKKK	
+	dIVZ'.~'BT(/9 9 9JD$$  	 	 	OONB///HQKKKKKKKK	 KK~ 93y>>JJJ BCCC +T222=>>>
+KK"D)))~ <===
+8WhT222222s   "C8 8
+D;/D66D;&G: :
+H=/H88H=v. .8w)(w)C!+AD D
+AED/AEEAEEAE3 E3
+AGE=AAG
+G
+AGG-AH H
+AIH/AH?H?AI	tagprefixr  c                    d }	 t          |          }n# t          $ r t          j        d|          }|sXt          j        d|          }|r't          |                                d                   }|                    dd          |fcY S t          |                                d                   }Y nw xY w|                     d          r| | dd           d| |fS | |  d| |fS )	Nz^v(\d+)$zv(\d+)$r   
+refs/tags/r   r   r   r   )r3  
+ValueErrorr   r   r  r  r   )r   r  r  r   r  s        r/   r  r  W  s   H
+,v;; , , ,)K00 	>i
+F33G 4w~~//233>>,33X====w~~''*++,  @5VABBZ55855x??---8--x77s    A7B7'B76B7r   rJ  r   r~  c                 
+   |                     d          }t          |          dk    r|d         dz   }t          d          \  }}|d         d         }t          d	|            t	          | ||          \  }	}t
+                              d
+|	           dd|	 g}
+t          j        d |
+          \  }}|dk    r	 t                      }|dk    r"ddg}
+t          j        d |
+          \  }}|
+                                }t                      }d| dg}
+t          j        d |
+          \  }}|dk    rt          d          d| d| g}
+t          j        d |
+          \  }}|dk    rt          d          ddg}
+t          j        d |
+          \  }}|dk    rt          d          |
+                                }d| g}
+t          j        d |
+          \  }}|dk    rt          d| z            n|dk    rt                      }| d}nd}t
+                              d|	           dddd|	|g}
+t          j        d |
+|                                          \  }}|dk    r6t
+                              d||	           t
+                              |           nM# t          $ r%}t
+                              d|           Y d }~n#d }~ww xY wt
+                              d |	           t
+                              d!           t          d"          \  }}d#| }d$|d         vrt!                      |d         d$<   ||d         d$         vrt#                      |d         d$         |<   |d         d$         |                             |           |d         d         }|dz   }||d         d<   |                    d%          }d#| }d$|d         v rT||d         d$         v rDt          j                    }|                    d&          |d         d$         |         d'         z  }nd(}|||d)}t          d*                    ||                     t/          t0                                                                        |          }d"}t#                      }|D ]`}t7          j        d+|t6          j        t6          j        z  ,          r|                    ||z              d}K|                    |           a|rd%                    |          }n|d-z   |z   }t
+                              d.|           t
+                              d/           tA          ||           d S )0NrM  r4   r   rk   Tr}  r   r   zDEBUG: mybranch=zchecking if we already have %sr   r  r   r   r   r~  z#Could not switch to a detached headr   r   z*Could not cherry-pick the cover-less rangez3Could not find the HEAD commit of the detached headzCould not switch back to %sr  z
+Tagging %stagr6   r#  r   )r   zCould not tag %s as %s:zError tagging the revision: %szNOTE: Tagname %s already existsz4Recording series message-id in cover letter trackingFvhistoryr  linkmaskr   zEDITME (not found in tracking))oldrevnewrevoldrev_linkz Markdown Link:
+[96m[{}]({})[0mz^changes in v\d+r   z
+
+---
+zCreated new revision v%sz7Updating cover letter with templated changelog entries.)!r  r   r   printr  r   r    r   r   r   r   r  r"   rS   rO   rH   r  r   r   r   r   r   formatr   DEFAULT_CHANGELOG_TEMPLATEr9  r:  r   r   r  r   r   r   )r   rJ  r   r  r~  r   r   r   r   r  r   r]   r^   r   
+end_commitr  	tagcommitr[   vrevr  r  sectionsr&   r  rC  prependr>  new_sectionsr   rx  s                                 r/   r  r  j  s   ^^I&&F
+6{{Q)d" 555OE8!*-H	
+H
+
+   (9hGGGX
+LL17;;;2223G#D'22JE3qyy,	B)++H8##&//g>>
+s YY[[
+022%,':':':;/g>>
+s199&'LMMM(\*I*IZ*I*IJ/g>>
+s199&'STTT&//g>>
+s199&'\]]]IIKK	%x0/g>>
+s199&'Dx'OPPP \))022+///		"	KKg...dD#w	BG+D'AQAQRRRJE3qyy5y'JJJC    	B 	B 	BOO<bAAAAAAAA	B 	5w???
+KKFGGG 666OE8x>>D***(,9%8H%i000.2ff9%d+Xy!$'..u555h
++FaZF%+HXz"{{7##Hv<<DHX&&&48H3Ei3P+P+P#%%jj,,x/A)/LT/RSU/VV6" G
+ 
+
+3
+:
+:4
+M
+MNNN188::;;KKGTTGE66L ) )9('EEE 	)' 1222EE(((( 2LL..		K''1	
+KK*F333
+KKIJJJ	8$$$$$s   =GJ 
+K&KKc                      t           sJt                              d           t                              d           t          j        d           d S d S )Nz=ERROR: b4 submit requires git-filter-repo. You should be ablez<       to install it from your distro packages, or from pip.r4   )can_gfrr   rH   rI   rJ   rN  r1   r/   check_can_gfrr    sK     WXXXVWWW r1   c                     t          d           t                      \  } }|d         }t                              d|                    d                     d|v rwt          j                    }t                              d           |d                                         D ]1\  }}|D ]'}t                              d||d	         |z             (0d S d S )
+NTr8  r   zv%sr   r  r;   z  %s: %sr  )r;  r   r   rS   r   r   r   r  )r   r   tsr&   rnlinkslinks          r/   show_revisionr    s    $ llOE8	(	B
+KKrvvj))***B#%%EI,,.. 	G 	GIB G GJF:,>,EFFFFG	 	G 	Gr1   c                  &   t          d           t          j        d           } t          d| z             t	                      \  }}t          |          \  }}t          d|j        z             |d         }|                    d          r8t          dd                    |                    d                    z             t          d	|                    d
+          z             |                    d          }t          d|z             t                      }t          d|z             |                    d          rt          d|d         z             t                      \  }}	}
+}}}t          d|z             t          d|	z             t          d|
+z             |D ]0}|                    d          \  }}t          d|d|           1d|v rt          |d                                                   D ]\  }}t          | t          |          \  }}	 t!          |          \  }}}t          d|d|d d         d|d|d                    \# t"          $ r t$                              d|           Y w xY wd S d S )NTr  z
+branch: %szcover-subject: %sr   r   zprefixes: %sr_  zchange-id: %sr   r   zrevision: %szcover-strategy: %sr   zbase-branch: %szbase-commit: %szstart-commit: %szend-commit: %sr4   r   zcommit-z: r  zseries-r   r   r   zNo tag matching %s)r;  r   r   r  r   r  r  r   r   r   r  r   reversedr  r  r  r  r"   r   r    )r   r   r   r  r  r  r   r   r   r  r  r  r  r  r   shortr   r  r  r  r   s                        r/   	show_infor    s   $(..H	,
+!""" llOE8,U33OHe	
+ 5
+5666	(	B	vvj =nsxxz(:(:;;;<<<	/BFF;//
+/000vvj!!H	.8
+#$$$!##H	
+
+)***	vvm 5"]"33444I[I]I]FKz7Hh	
+k
+)***	
+|
++,,,	
+Z
+'((( 2 2Q//w01111B!"Y-"5"5"7"788 	< 	<IB 0?B O OGX<0J70S0S-{IK4D4D4DggguUVxxXYYYY < < <17;;;;;< 	< 	<s   '<I$$%JJforcetoc                     t                      \  }}| |d         d<   t                              d|            t          ||           d S )Nr   r   zForced revision to v%s)r   r   rS   r   )r  r   r   s      r/   force_revisionr    sI     llOE8%,HXz"
+KK('222x     r1   rS  rT  c                    t          j        d           }t          |t          |           \  }}d|g}t          j        d |          }|s/t
+                              d|           t          j        d           |d         }	 t          |          \  }}	}
+nS# t          $ rF}t
+                              dt          |                     t          j        d           Y d }~nd }~ww xY w|	}t                      }t                      }|dk    rt                      }| d}nd}d|g}t          j        d |          }|d         }d	d
+|dd|d|dd|dg}t
+                              dd                    |                     |st#          j        |d         |           d S t'          j        |dt&          j        t&          j                  }|                                \  }}|                    d          S )Nr   z CRITICAL: Could not rev-parse %sr4   r   r  r  r~  r   gitz
+range-diffz.12r   r^  r_  F)shellstdoutstderrrj   )r   r   r  r  r   r   rH   rI   rJ   r  r"   rM  r{  r   r  r    r   r   execvprk  rl  PIPEcommunicaterL   )rS  rT  r   r  r   r   r   prev_endr   r   r   r[   
+prev_start
+curr_startr   r  
+series_endcurr_endgrdcmdprocr  r   s                         r/   rd  rd    s   (..H(?INNGXG$G$T733E :GDDDQxH(B7(K(K%{II   B000 J!##J!##H<(**$(((
+
+
+J'G$T733EQxH\ZZZZ#J^h^h^h^hjrjrjrLstF
+LLsxx//000 
+	&)V$$$F%
+PZP_```D  ""IFA==!!!s   B 
+C%<C  C%c            	         d } d }t          j                    }t          j                            |dd          }t          j                    }|                    d          r|                    d          } n$t          j        |t          j                  r| d} |                    d          r|                    d          }n$t          j        |t          j                  r| d}t                      }t                      }| rjt          j
+        | d          }d|_        t          |          }t                              d	t          j                            |d
+                              |rjt          j
+        |d          }d|_        t          |          }t                              dt          j                            |d
+                              t                              d           t!          d          \  }}	t           j                            |          }
+t'                      }|
+d         D ]P}|j        s
+|                    |j        d                    t                              d|j        d                    Qt                      }d|                    d          fd|                    d          ffD ]\  }}|st-          j        |g          D ]}|d         |v r|                    |d                    t          j        |t          j        |g                    }t                              d|j        d                    |                    |           	 t7                      \  }}}}n+# t8          $ r t                              d           Y d S w xY wt                              d           |D ]\  }}|r|st                              d|                    d                     |                                }dt=          ||          fdt=          ||          ffD ]\  }}|D ]}|d         |vr|                    |d                    t          j        |t          j        |g                    }t                              d|                                           |                    |           |st                              d           d S t@          j!        "                                }|#                    |d           t          j        |          }|                    dd           }|$                    ||!           t                              d"           t                              d#           tK          |j&        |	           d S )$Nscriptszget_maintainer.plzsend-auto-to-cmdzD --nogit --nogit-fallback --nogit-chief-penguins --norolestats --nolzsend-auto-cc-cmdzD --nogit --nogit-fallback --nogit-chief-penguins --norolestats --nomTr\  z#Will collect To: addresses using %sr   z#Will collect Cc: addresses using %sz#Getting addresses from cover letterFr}  r   r4   zadded %s to seenrr  rl  rs  rm  r  zNo commits in branchzCollecting To/Cc addresseszCollecting from: %sr   z  => %szNo new addresses to add.rj   rl   zsend-trailer-orderzTo,Cc,*)extrasfallback_orderr;   z8You can trim/expand this list with: b4 prep --edit-cover)'r   r   r   r   r   r   r   accessX_OKr   ri  rj  r   rS   basenamer    r   r  r  r  r  r*  r   r  r  r  r   rK  r"   rv   r  r  r   rq   rr   ru   r  r   r   )tocmdstrcccmdstrr(   getmr&   tocmdcccmdrw  r   r   r  r  ltrr  r  r  r  r  r  rJ  r   r   ro   r  pairsr{   clmr  s                               r/   
+auto_to_ccr  ;  sp   HH ""F7<<	+>??D!!Fzz$%% a::011	4	!	! a```zz$%% a::011	4	!	! a```FFEFFE W[..."R927;K;KERSH;U;UVVV W[..."R927;K;KERSH;U;UVVV
+LL6777 666OE8N))%00E55DQx 6 6x 	!'!5555VVF
+
++; < <=fjjQaFbFb?cd 	 	u 	&w// 	 	DAw$HHT!W.e2?D63J3JKKKCLL+SXa[999MM#	%?%A%A"S'77   *+++ KK,--- ' ' 	& 	*CGGI,>,>???<<>>"$:5($K$KL"$:5($K$KLN 	' 	'LE5 ' '7$&&HHT!W%%%.e2?D6;R;RSSSCLLCMMOO<<<MM#&&&'	'  ./// =%%''DUG,,,
+.
+
+CZZ 4i@@NF>BBB
+KK
+KKJKKK(#####s   9N $N54N5r   c                 0   t                      \  }}|d                             dt                                }t          |           dk    r(| d                                         st                      } | |d         d<   |d         d         |k    rjt          ||           |d         d         r0t                              dd                    |                      d S t                              d           d S t                              d           d S )	Nr   r   r4   r   zUpdated extra prefixes to: %sr_  zRemoved all extra prefixes.zNo changes to extra prefixes.)	r   r   r   r   r   r   r   rS   r   )r   r   r   old_prefixess       r/   r   r     s     llOE8H%))*dff==L
+8}}(1+"3"3"5"566%-HXz"*%55E8$$$Hj) 	7KK7(9K9KLLLLLKK566666344444r1   c                     ddl m}  t          d          }|                                sLt                              d| d           t                              d           t          j        d           t                      }d}t                      }t          j        d	||t          |g          
+          }ddgd |D             z   } | |          }|j        S )z
+    Invoke ./scripts/checkpatch.pl if it is available.
+    Only consider the current working directory.
+    Return True if patch is all good, False otherwise.
+    r   )r1  z./scripts/checkpatch.plzCRITICAL: no z found.z(          Navigate to Linux source tree.r4   r   Nr  z--gitc                     g | ]
+}|d          S )r   rN  rg  s     r/   rW  zcheckpatch.<locals>.<listcomp>  s    5L5L5Lqad5L5L5Lr1   )rk  r1  r	   r   r   rH   rI   rJ   r{  r  r   r  r  
+returncode)r1  checkpath_pl_pathr  r  r  r   commandrC   s           r/   
+checkpatchr    s     677##%% B(9BBBCCCCDDDE
+C$&&L%dE3sL>GZGZ[[[G('25L5LG5L5L5LLGS\\Fr1   c                    t                       t          j                    }t          |          rHt                              d           t                              d           t          j        d           | j        r-t                      }t          
+                    d|            d S | j        r.| j        }t          j        ||hd          }t          j        d           }|r|D ]}t          j                            |          |k    rt          j        |                    d                    }t          j                            |          \  }}	|                                }
+|
+r!dd	                    |
+          d
+|j        }n|j        }|dz   |z   }t          |||          c S t                              d|           t          j        d           | j        rt-                      S | j        rt/                      S | j        rt1          | j                  S | j        rt5          | j                  S | j        r5| j        r.t                              d           t          j        d           | j        s| j        rRt;                      r5| j        s.t                              d           t          j        d           t?          |            | j         rtA          | j                    | j!        rtC          | j!                   | j"        rtE                       | j#        rtG                      S d S )Nrc  rd  r4   zcheckpatch return code: T)
+onlymsgidsr  r   r1  r_  r2  r  zCRITICAL: could not retrieve %szKCRITICAL: -n NEW_SERIES_NAME and -e [ENROLL_BASE] can not be used together.z>CRITICAL: This appears to already be a b4-prep managed branch.)$r  r   r  r   r   rH   rI   rJ   checkr  rS   r  r   r   r  r  r  r   r  r  r   r   r  r  r`  
+compare_tord  r   r   r;  r   r  r  r   r  ry  )rf   r  checkpatch_return_coder   msgsr   ro   r   r  rm   r   r   rJ  s                r/   cmd_prepr     s'   OOO#%%F
+6{{ LMMM?@@@} !+G/EGGHHH~ (E7DQQQ,T22 	< < <>11#66%??!~cggi.@.@AAH%'^%?%?%D%DNE7'::<<H 3 3/2xx/A/A/A/A8CSCS"T"*"2%.6G!(GU;;;;; @ 	95AAA  {{ 2G0111 +w)*** w6 efff "g5 " 	G$6 	OO\]]]HQKKK!!! /w-... +W)***  || r1   c                 &   t                       t          j                    }t          |          rHt                              d           t                              d           t          j        d           | j        rt          |            d S d S )Nrc  rd  r4   )
+r  r   r  r   r   rH   rI   rJ   r  r  )rf   r  s     r/   cmd_trailersr    s    OOO#%%F
+6{{ LMMM?@@@~ !     ! !r1   )r
+   N)r}   rB  )F)T)TTT)^
+__author__email.messager   r   rI   r   r   argparser   r4  r   rA   re  rk  ri  rZ  rP   r=  r   r   typingr   r   r   r   r   stringr   r	   r$   
+can_patattModuleNotFoundErrorgit_filter_repor+  r  r   r  r  r!   r5  r  rM  r0   re   	Namespacerp   r3  r   r   r  r  r  boolr   r   r   r;  r  r)  ry  r{  r  r<  r  r  r   r  r  r  r  r  rq   Messager   r  r  r  r%  rK  rO  r`  r  r  r  r  r  r  r  rd  r  r   r  r   r  rN  r1   r/   <module>r     s	   E
+     				 
+
+
+
+ 				 				                 				 / / / / / / / / / / / /                  MMMJJ   JJJ    GG   GGG 
++7    >%S#sC <= > > > >4D D D DN'+ ' ' ' ' 'T C (3- #     3 (3- 3    `ah0 `aT `a `a `a `aF	+$ +3 + + + +&# &#t &#c4i0@ &# &# &# &#RE E E E4 ED E E E EP x}     & 4 D    2
+8C= 
+ 
+ 
+ 
+? ? ? ? ? ? ? ?"() () () ()V#    Do%X/ o%D o% o% o% o%d1DI 1 14cSVhCX 1 1 1 1 ^ ^Xc] ^eCcSWX[S\^acfDf>g ^ ^ ^ ^2Od OS OT O O O O) )c3m0D ) ) ) )& c S (3- SV    03 5tS#9      7;  3 eCQVQ^QfLfFgAh "%/3   ,,@s ,@T%U]5J0J*K%L ,@QU ,@ ,@ ,@ ,@^
+# 
+%0C*D 
+ 
+ 
+ 
+-d5em&;!;<= - - - -5eCHo 5 5 5 5O, O, O,d O,X\ O,$)$c4c5=K`F`@a;b*b$cO, O, O, O,d#S #C #E$dSXY\^c^k^sYsStNuBu<v # # # #4'S 'T ' ' ' '*O3h( O3T O3 O3 O3 O3d
+8S 8S 8%S/ 8eTWYabeYfTfNg 8 8 8 8& FU`b k% k%S k%3 k%s k%s k%\_ k% k% k% k%\   
+G 
+G 
+G 
+G< < < <D!C !D ! ! ! !#" #"s #" #" #" #" #" #"LV$ V$ V$ V$r54 5D 5 5 5 5 C    2Bh( BT B B B BJ	!(, 	! 	! 	! 	! 	! 	! 	!s$   .A5 5A?>A?B
+ 
+BB
\ No newline at end of file
diff --color -Naur /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/__init__.cpython-311.pyc /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/__init__.cpython-311.pyc
--- /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/__init__.cpython-311.pyc	1970-01-01 00:00:00.000000000 +0000
+++ /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/__init__.cpython-311.pyc	2023-08-03 22:50:21.184557685 +0000
@@ -0,0 +1,809 @@
+
+    +/d"                    *   d dl Z d dlZd dlZd dlZd dlZd dlZd dlZd dlZd dlZ	d dl
+Z	d dlZ	d dlZ	d dlZ	d dlZd dlZd dlZd dlZd dlZd dlZd dlZd dlZd dlZd dlZd dlZd dlZd dlZd dlZd dlZd dlmZ d dlm Z  d dl!m"Z"m#Z#m$Z$m%Z%m&Z&m'Z'm(Z(m)Z) d dl	m*Z*  e*j+        dd           e	j,        -                    ddd	          Z. ej/        d
+          Z0	 d dl1Z1dZ2n# e3$ r dZ2Y nw xY w	 d dl4Z4dZ5n# e3$ r dZ5Y nw xY wdZ6dZ7dZ8d Z9 ej:        d          Z;e;<                    d          Z=e=>                    e9            ej/        d          Z? ej/        d          Z@ ej/        dejA        ejB        z            ZC ej/        dejA        ejB        z            ZDdZEdZFdZGdZHdZIdZJi deJdz   deJdz   d eJd!z   d"d#d$d%d&d'd(d)d*d+d,dd-d.d/d0d1dd2dd3dd4dd5dZKdaLdaMdaNdaOdaP eQ            aR G d6 d7          ZS G d8 d9          ZT G d: d;          ZU G d< d=          ZV G d> d?          ZW G d@ dA          ZX G dB dCeX          ZY G dD dEeX          ZZ	 	 ddFe%e[         dGe"e\         dHe"e[         dIe#e]e\e\f         fdJZ^ddKe%e[         dGe"e\         dIe#e]e\e\f         fdLZ_	 	 	 ddMe"e[         dKe%e[         dGe"e\         dNe`dOe`dHe"e[         dIe#e]e'e[e\f         f         fdPZadMe"e[         dQe[dRe[dSe[dIe"e[         f
+dTZbdMe"e[         dKecdIe%e[         fdUZdddMe"e[         dVe`dIe%e[         fdWZee ddX            Zfe ddY            Zge dZ             Zhdd\e"e[         d]e[d^e[d_e[fd`Zi	 	 ddae[dbe"eQ         dce"ec         dde"e[         dIeQf
+deZjdIeQfdfZkddge[dIe[fdhZlddge[dIe[fdiZmddje[dke"e[         fdlZnddje[dke"e[         dIe"e[         fdmZoddje[dke"e[         dIdfdnZpddpe[dje[dke"e[         dqe[dIdf
+drZqds Zrdt ZsdIe"e[         fduZtdFeju        dIe"e[         fdvZvddwZwddxe\dye[dze"e[         dIe%e	jx        jy                 fd{Zzdd|e[d}e`dIe"e%e	jx        jy                          fd~Z{dde\de"e[         dIe%e	jx        jy                 fdZ|dde[d}e`fdZ}	 	 dde[d}e`de"e~         dIe"ec         fdZ	 	 	 	 	 	 	 ddMe"e[         de[de[de"e%e[                  de"e]         de"e[         de"e]         de"e#e[e[f                  de"e%e#e[e[f                           de"e$e[                  dIe%e#e[e	jx        jy        f                  fdZd Zd Zdde"e[         dIe"e[         fdZddZddZddZde[dIe#e`e`e`e"e[         e"e[         f         fdZde[dIecfdZde%e	jx        jy                 de&fdZdde%e	jx        jy                 de&de`fdZdecfdZdde\de`dIe#eQe\e\f         fdZd ZdIeQfdZdde`dIe#e'ej        ej        ecdf         e[f         fdZde[de[dIe#ej        e[f         fdZde%e[         de[dIe`fdZ	 	 	 	 dde'ej        ej        df         de(e	jx        jy                 de"e[         de"e'e~ecf                  de`de`de"e[         de"e[         de`dIee"e]         e[f         fdZddMe"e[         de`dIe"e[         fdZdIe$e[         fdZde%e#e[e[f                  de$e[         dMe"e[         dIe%e#e[e[f                  fdZdIe[fdZdFeju        dIe#e"e[         e"ec         f         fdZde[dIe[fdZdS )    N)Path)contextmanager)OptionalTupleSetListBinaryIOUnionSequenceLiteralcharsetutf-8T8bit)utf8cte_typemax_line_lengthz[()<>@,:;.\"\[\]]Fz0.12.3z1.2c                 T    t           j        | _        d| _        d| j        z   | _        dS )NDEBUGzDKIM: T)loggingr   levelno	levelnamemsg)records    U/usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__init__.py_dkim_log_filterr   C   s(     ]FNFFJ&FJ4    b4dkimz'^@@ -\d+(?:,(\d+))? \+\d+(?:,(\d+))? @@z^(---|\+\+\+) (\S+)z:^(---.*\n\+\+\+|GIT binary patch|diff --git \w/\S+ \w/\S+)flagsz&^\s*\d+ file.*\d+ (insertion|deletion)vxu   [32m[0mu   [31m[0mX-Developer-Signaturezhttps://lore.kernel.orgmidmaskz/all/%slinkmaskz/r/%s
+searchmaskz/all/?x=m&t=1&q=%slistid-preferencez-*.feeds.kernel.org,*.linux.dev,*.kernel.org,*zsave-maildirsnoattestation-policysoftfailattestation-staleness-days30attestation-check-dkimyesattestation-gnupghomeattestation-checkmarksfancycache-expire10zthanks-commit-url-maskzthanks-pr-templatezthanks-am-templategpgbinsendemail-identityc                       e Zd ZU eed<   eed<   eed<   eed<   eed<   d Zd Zded	e	d
+         fdZ
+d Zdd	e	d         fdZdej        j        d	dfdZdS )LoreMailbox	msgid_mapseriescovers	followupsunknownsc                     t                      | _        t                      | _        t                      | _        t                      | _        t                      | _        t                      | _        d S N)dictr9   r:   r;   trailer_maplistr<   r=   selfs    r   __init__zLoreMailbox.__init__   sI    ffff66r   c                    t                      }| j                                        D ]'\  }}|                    t	          |                     (|                    d           | j        D ]}|                    d|j        z              |                    d           | j        D ]}|                    d|j        z              d                    |          S )Nz--- Followups ---  %sz--- Unknowns ---
+)	rB   r:   itemsappendstrr<   full_subjectr=   join)rD   outkeylserlmsgs        r   __repr__zLoreMailbox.__repr__   s    ff**,, 	" 	"ICJJs4yy!!!!
+
+&'''N 	3 	3DJJv 112222
+
+%&&&M 	3 	3DJJv 112222yy~~r   msgidreturnLoreMessagec                 2    || j         v r| j         |         S d S r?   )r9   )rD   rS   s     r   get_by_msgidzLoreMailbox.get_by_msgid   s!    DN"">%((tr   c                    |dk    s|dz
+  | j         vrd S |                     |dz
+  |          }| j         |         }d}|j        D ]}||j        |j        | j        vrt
+                              d           d} n| j        |j                 }d}	 |j        |j        k    r3|j        |j        k    r#t
+                              d|j	                   d}n)|j        |j        | j        vrn| j        |j                 }l|s6d}t
+                              d|j        |j        |j        |j                    n|st
+                              d           d S t
+          
+                    d	|j	                   t
+                              d
+           d}	|j        D ]j}|j        |	         |	dz  }	|Bt          j        |j        |	                   }|j	        |_	        |j	        |_        ||j        |	<   n|j	        |_        |	dz  }	kd |j        dd          vrJd|_        d|_        |j        d         d|_        |j        |_        t
+                              d           d S d S )N   )sloppytrailersTzPatch not sent as a reply-toFz&Found a previous matching patch in v%szLPatch not a reply to a patch with the same counter/expected (%s/%s != %s/%s)zNot a sane partial rerollz0Partial reroll detected, reconstituting from v%szReconstituting a partial rerollr   zReconstituted successfully)r:   
+get_seriespatchesin_reply_tor9   loggerdebugcounterexpectedrevisioninfocopydeepcopyreroll_from_revisioncompletepartial_reroll	has_coversubject)
+rD   rb   rZ   pserrP   sanepatchppatchfoundats
+             r   rh   zLoreMailbox.partial_reroll   s   
+ q==HqL;;Fxz.II{8$\ 	 	E} (E,=T^,S,S;<<<^E$56FE<=FN22u~7X7XLL!I6?[[[ E%-1C4>1Y1Y(:;<  k"]ENFNFO] ] ]	  	LL4555FFVVV6777\ 	 	E|B'a}t|B'788"&-.2m+#)R  -1]*!GBBt|ABB''' DM"&D|A*!%<DLLL566666 ('r   NFT
+LoreSeriesc                    |=t          | j                  sd S t          | j                                                  }n|| j                                        vrd S | j        |         }d}|j        D ]}|d} n	|r"t
+                              d|j                   d S |j        s|r| 	                    ||           || j
+        v r(|                    | j
+        |                    d|_        nP|j        D ]H}|D|j        =|                     |j                  }|!|j        r|j        s||j        d<   d|_         nI| j        D ]}	t
+                              d|	j        |	j                   t          |	j                  st
+                              d           X|	j        p|	j                            dd          }
+d }|
+                                D ]:}|                    d	          }|| j        v r||	j        k    r| j        |         } n;|nC|	j        | j        v r| j        |	j                 }n"t
+                              d
+|	j                   |	                    |          \  }}|D ]4}|j                            |j        |j         |	j!        |	j        f           5d}	 t
+                              dd|z  |j                   t
+                              dd|z             |D ]/}t
+                              dd|dz   z  |j        |j                    0|j        rm|j"        sf|j        |k    rJ|j#        rC|j#        | j$        vrtK                      | j$        |j#        <   | j$        |j#        xx         |z  cc<   |xj&        |z  c_&        nm|j"        s|xj&        |z  c_&        nU|j        rM|j        | j        v r?|dz  }|j        D ]}||_'        |(                    |           | j        |j                 }U	 |j        D ]:}||j#        |j#        | j$        v r |xj&        | j$        |j#                 z  c_&        ;|S )NTFz&All patches in series v%s are missing.r   zAnalyzing follow-up: %s (%s)z  no trailers found, skipping
+References <>z  missing message, skipping: %s)sloppyrY   z%sParent: %s z%sTrailers:z%s%s: %s))lenr:   maxkeysr\   r^   criticalrb   rg   rh   r;   	add_patchri   r]   rW   has_diffstathas_diffr<   r_   rL   	fromemailtrailersr   getsplitstripr9   rS   get_trailerstrailer_mismatchesaddnamevaluefromnamereplypwhashrA   rB   followup_trailersrQ   rJ   )rD   rb   rZ   rerollrP   emptyrQ   member	potentialfmsgrefspmsgrefrefidr   
+mismatchesltrlvlpltrs                      r   r[   zLoreMailbox.get_series   s   t{## t4;++--..HHT[--////4{8$ L 	 	D    	OODdmTTT4} 	: 	:.999 t{""NN4;x0111!DNN ,  %&*<*H $ 1 1&2D E EI ,1G,PYPb,*3Q)- N ;	 ;	DLL79JDN[[[t}%% <=== 'x||L"55::<<  CIIdOOE..5DJ3F3F#~e4<   !T^33~d&67>@PQQQ#'#4#4N#4#K#K Hj! b b'++SXsy$-QUQ_,`aaaaC^S3Y8IJJJ]C#I666# Q QCLLSCE]CHciPPPP=  }00  ; F#{$2BBB@D 0 = ,T[999XE999**h6**z **h6**# (8DN(J(J1HC $ . .$(	 ---->$*:;D L 	H 	HD|t{2{d...&&$*:4;*GG&&r   r   c                 2   t                               |          }|r&|| j        v rt                              d|           d S t          |          }t                              d|j                   |r|| j        |j        <   |j        r6t                              d           | j        	                    |           d S |j
+        dk    r?|j        r|j        r1t                              d|j                   || j        |j        <   d S |j        rQ|j        | j        vr|j        r|j        r|                     |j                  }|;|j        r4|j        s-t                              d|j                   |j        |_        nK|j
+        dk    r@|>|j        r7|j
+        dk    r,t                              d|j                   |j        |_        |j        | j        vr_t)          |j        |j                  | j        |j        <   t-          | j                  dk    r t                              d|j                   |j
+        dk    r|j        r|j        s|j        j        r|j        j        s| j        |j                 j        |j
+                 }||j        r|j        |j        k    ry|j        |j        k     rit-          | j                  dz   |_        t)          |j        |j                  | j        |j        <   t                              d	|j        |j                   t                              d
+           | j        |j                                     |           d S t                              d           | j        	                    |           d S )Nz3Already have a message with this msgid, skipping %sLooking at: %sz  adding to followupsr   z  adding as v%s cover letterz  fixed revision to v%srY   zFound new series v%szAssuming new revision: v%s (%s)z  adding as patchz  adding to unknowns) rU   get_clean_msgidr9   r^   r_   rL   rS   r   r<   rJ   r`   counters_inferredr}   rb   r;   r~   r:   revision_inferredr]   rW   rq   ra   rx   lsubjectrm   resendr\   r   daterc   r|   r=   )rD   r   rS   rQ   irtomsgs         r   add_messagezLoreMailbox.add_message^  sL   ++C00 	Udn,,LLNPUVVVF3%t'8999 	.)-DN4:&: 	LL0111N!!$'''F<1d&<@Q LL7GGG)-DK&F= !	}DK//) 5d.> 5 ++D,<==C3+;CL%>MMM(+))co#,oSVS^bcScSc%>MMM(+ }DK//-7t}-U-UDM*t{##a''LL!7GGG !!d&<! J "+/=+> "GK}G[ "{4=19$,G$)?$DNVZVdDdDd I	11$'$4$4q$8DM1;DM4=1Y1YDK.KK A4=RVRcdddLL,---K&00666F+,,,T"""""r   )NFT)__name__
+__module____qualname__r@   __annotations__rB   rE   rR   rK   r   rW   rh   r[   emailmessageMessager    r   r   r8   r8      s         OOOLLLLLLOOONNN    # (=*A    
+<7 <7 <7|m mhWcNd m m m m^=#u}4 =# =# =# =# =# =# =#r   r8   c                      e Zd ZU eed<   eed<   eed                  ed<   ed         ed<   eee	e	e	e	f                  ed<   dZ
+eed<   dZeed	<   dZeed
+<   e	ed<   dZeeee	e	f                           ed<   dZee	         ed<   dZee	         ed<   dededdfdZd Zd%dZd&dede	fdZdeddfdZd'dZ	 	 d(deej        j                 fdZd Zd)de	dee	         deeef         fdZd*de	d ee         d!edee	eef         fd"Z d# Z!d$ Z"dS )+rq   rb   ra   rU   r\   r<   r   Frg   ri   rh   rj   Nindexesbase_commit	change_idrT   c                     || _         || _        d g|dz   z  | _        t                      | _        t                      | _        d| _        d S )NrY   z
+(untitled))rb   ra   r\   rB   r<   setr   rj   )rD   rb   ra   s      r   rE   zLoreSeries.__init__  sD      v!,"%%%#r   c           	         t                      }|                    d| j        d| j                   |                    d| j        z             |                    d| j        z             |                    d| j        z             |                    d| j        z             |                    d| j        z             |                    d| j        z             |                    d	| j	        z             |                    d
+           d}| j
+        D ]S}|)|                    d|d| j        d|j                   n!|                    d|d| j        d           |dz  }Td                    |          S )Nz- Series: [v]   revision: %s  expected: %sz  complete: %sz  has_cover: %sz  base_commit: %sz  change_id: %sz  partial_reroll: %sz
+  patches:r   z    [/z	] MISSINGrY   rH   )rB   rJ   rb   rj   ra   rg   ri   r   r   rh   r\   rM   )rD   rN   rp   r   s       r   rR   zLoreSeries.__repr__  s~   ff
+
+
+4===$,,GHHH
+
+#dm3444
+
+#dm3444
+
+#dm3444
+
+$t~5666
+
+&)99:::
+
+$t~5666
+
+)D,??@@@
+
+<   l 	 	F!
+
+
+rrr4===&..QRRRR
+
+
+BBBFGGG!GBByy~~r   rQ   c                    t          | j                  |j        dz   k     r:| j                            d            t          | j                  |j        dz   k     :|j        | _        | j        |j                 W| j        |j                 }|j        s|j        r6|j        s/t                              d|j	                   || j        |j        <   n|| j        |j        <   d | j        dd          v| _
+        |j        dk    rd|j        v rTt          j        d|j        t          j        t          j        z            }|r|                                d         | _        d|j        v rTt          j        d|j        t          j        t          j        z            }|r|                                d         | _        | j        d         | j        d         j	        | _	        d S | j        d         | j        d         j	        | _	        d S d S )	NrY   z  replacing existing: %sr   z
+base-commit:z^base-commit: .*?([\da-f]+)r    z
+change-id:z^change-id:\s+(\S+))rx   r\   ra   rJ   r`   r   r   r^   r_   rj   rg   bodyresearchIMgroupsr   r   )rD   rQ   r   matchess       r   r|   zLoreSeries.add_patch  s   $,$-!"333L%%% $,$-!"333<%1<-Dz 2d4 2T=S 27FFF-1T\*)-DL&!T\!""%55<149,,)$BDIUWUY\^\`U`aaa ;'.~~'7'7':D$**)$:DIRTTVTX[YYY 9%,^^%5%5a%8DN<?&<?2DLLL\!_(<?2DLLL )(r   extendedc                    d }| j         D ]}| n|dS |j                            d          }t          j                            d |j                            dg           D                       d         }|rl|d                             d          d         }|d|d|j	        }t          j        d	d|                              d                                          }nHt          j        d	d|d                                       d                                          }|d|}| j        dk    rd
+| j        d|}|d d         S )N	undefinedz%Y%m%dc                 ,    g | ]}t          |          S r   rK   .0r#   s     r   
+<listcomp>z'LoreSeries.get_slug.<locals>.<listcomp>  s    .\.\.\!s1vv.\.\.\r   fromr   rY   @_\W+r"   d   )r\   r   strftimer   utilsgetaddressesr   get_allr   rj   r   subr   lowerrb   )	rD   r   rQ   prefix
+authorlinelocalunsafeslugauthors	            r   get_slugzLoreSeries.get_slug  sc   L 	 	D   <;##H--[--.\.\tx?O?OPVXZ?[?[.\.\.\]]^_`
+ 	.qM'',,Q/E#)66555$,,?F6&#v..44S99??AADDVFCA77==cBBHHJJF$ffff-D=A#}}}dd3DDSDzr   r   c                 P    | j         dd          D ]}||xj        |z  c_        d S NrY   )r\   r   )rD   r   rQ   s      r   add_extra_trailerszLoreSeries.add_extra_trailers   sE    L$ 	/ 	/D|""h."""	/ 	/r   c                     | j         d         r9| j         d         j        r)|                     | j         d         j                   d S d S d S )Nr   )r\   r   r   rC   s    r   add_cover_trailerszLoreSeries.add_cover_trailers  s]    <? 	Gt|A@ 	G##DLO$EFFFFF	G 	G 	G 	Gr   c	                 	   t                      }	t                      }
+|r$d|	vsd|	vrt                              d           d}|
+d         }	 t	          |
+d                   }n,# t
+          $ r t                              d           d}Y nw xY wd }d	}d }d}|d
+k    rt                              d           | j        dd          D ]f}|d} n_|                    ||          \  }}}||}|})t          |          t          |          k    rJd}t          
+                    d            |r|                                  d}t                      }t                              d           | j        dd          D ]^}|]||vr'|dz  }t          
+                    d|| j                   0|0t                              d|| j                   t          d          |t                      }|rG||
+                    d          }||j        z  }t#          d|          }|                    |           |rb|s`|r0t                              d||                                           nt                              d|                                           n|                    ||          \  }}}|r/t                              d||                                           n-t                              d|                                           |D ]}t                              d|           |rHdd l}t                              d           t                              d            |j        d           d	}|rd}|                    |||||          }|                    |           n!t                              d|| j                   |dz  }`|d
+k    r|S |r<|r:t                              d           |D ]}t                              d|           t0          rt2          s\t                              d           t0          st                              d           t2          st                              d           |S )Nr   r   zRWARNING: Unable to add your Signed-off-by: git returned no user.name or user.emailFr*   r,   z2WARNING: attestation-staleness-days must be an intr   Toffz:Checking attestation on all messages, may take a moment...rY   z Attestation info is not the same---z&  skipped: [%s/%s] (not in cherrypick)z/CRITICAL: [%s/%s] is missing, cannot cherrypickzCherrypick not in seriesr&   Linkr   r   z  %s %srG   z    %s+Exiting due to attestation-policy: hardfail   )add_trailersextrascopyccsaddmysoballowbadcharsz  ERROR: missing [%s/%s]!z  ---z6  NOTE: install dkimpy for DKIM signature verificationz<  NOTE: install patatt for end-to-end signature verification)get_user_configget_main_configr^   r{   int
+ValueErrorrc   r\   get_attestation_trailersr   r_   r   rB   ra   KeyErrorr   rS   LoreTrailerrJ   get_am_subjectsysexitget_am_messageerrorcan_dkim
+can_patatt)rD   noaddtrailerscovertrailersr   addlinkr&   
+cherrypickr   r   usercfgconfig	attpolicymaxdaysattrefattsameattmarkattcritrQ   	checkmarkr   rp   msgsr   linkvallltrr{   trailerr   r   r   s                                 r   get_am_readyzLoreSeries.get_am_ready
+  s    "## "" 	!W$$w(>(> tuuu /0		&!=>??GG 	 	 	KKLMMMGGG	 KKTUUUQRR(  <#GE/3/L/LYX_/`/`,	8W>%F'Gx==CKK//?@@@ 	&##%%%vvEL$ 1	 1	D%Z''!GBLL!I2t}]]]<OO$UWY[_[hiii"#=>>> ('#)::j#9#9&3G&F'BBBDMM$''' &7 & CIw8K8K8M8MNNNNFD,?,?,A,ABBBB 594Q4QR[]d4e4e1Ix  CIy$:M:M:O:OPPPPFD,?,?,A,ABBB#+ 7 7Hg6666 &"
+
+
+...(UVVV #  )#(L))|F\c3;= * Z ZC    8"dmLLL!GBBK 	-v 	-KK   ! - -FG,,,, 	\Z 	\KK    VTUUU \Z[[[s   A" "&B
+Bc                 2   t                      | _        t                      }| j        dd          D ]e}||j        |j        D ]Q\  }}}||v r|                    |           t          |          dhk    r5| j                            ||f           Rfd S )NrY   0)rB   r   r   r\   blob_indexesr   rJ   )rD   	seenfilesrQ   ofnobhnfns         r   populate_indexeszLoreSeries.populate_indexes~  s    vvEE	L$ 	0 	0D|t08!%!2 	0 	0S#)## c"""s88u$$##S#J////	0	0 	0r   gitdirrp   c                 <   | j         |                                  t                      }|d}| j         D ]\  }}t          |d||g          \  }}|dk    r~t	          |          ro|                                }|d                             |          rt                              d|           {t                              d||d         |           nt                              d||           |	                    ||f           t	          | j                   |fS )NHEADzls-treer      z%s hash: matchedz%s hash: %s (expected: %s)zCould not look up %s:%s)
+r   r  rB   git_run_commandrx   r   
+startswithr^   r_   rJ   )	rD   r  rp   r   fnbhecoderN   chunkss	            r   check_applies_cleanzLoreSeries.check_applies_clean  s   <!!###VV
+:Bl 	( 	(FB()R1DEEJE3zzc#hhz!9''++ RLL!3R888LL!=r6!9bQQQQ 6B???r2h''''4<  *,,r      branchesr   c           	      N   t           j                                         }| j        D ]}||j        } |                    d          }|r|}ndg}ddd|dg|z   }t          ||          }	|	st          |	d                                         d         }
+|                     ||
+          \  }}t          |          }|dk    r~|t          j
+        |          z
+  }|                    d          }t                              d	||           |
+}|D ].\  }}t                              d
+|||           ddd|d|d|g|z   }t          ||          }	|	st                              d|           ^|	D ]}|                                d         }
+t                              d|
+           |
+|
+ dfD ]~}|                     ||          \  }}t          |          |k     rHt          |          |k    r5t          |          }|}t                              d||           |dk    r n	|dk    r n|dk    r n|dk    r n0n|
+}|t          | j                  k    rt          t          |dd|g          }	t          |	          r|	d         t          | j                  |fS t          )Nz%Y-%m-%dz--alllogz--pretty=onelinez--untilz--max-count=1r   daysz$Starting --find-object from %s to %sz!Finding tree matching %s=%s in %sz--sincez--find-objectz$Could not find object %s in the treez	commit=%sz~1zfewest=%s, best=%sdescribe)datetimenowr\   r   r   git_get_command_lines
+IndexErrorr   r  rx   	timedeltar^   r_   r   )rD   r  r  r   pdaterQ   guntilwheregitargslinescommitcheckedr   fewestsincegsincebestr  bilinetcscsms                          r   	find_basezLoreSeries.find_base  s   !%%''L 	 	D|IE 
+++ 	EEIE,iQTYY%fg66 	q!!!$"66vvFFZA::H.G<<<<E^^J//FLL?PPPD$  B@"b%PPP "4iTZ*B0278-fg>> LL!GLLL!  D!ZZ\\!_FLLf555  &&}}}5 	" 	"!%!9!9&"!E!EBr77V++B2%(WWF#%D"LL)=vtLLL%{{ %!Q;;!E '{{ #Q;;E  DS&&&&%fz7D.IJJu:: 	78S..66r   c           
+         d x}}d }| j         D ]}|	|j        } n|t                              d           dS t	          |d          }|r| j        sd}|                                                                }t          |          dk    r|\  }}nd}|^|\t          |dd	|g          \  }	}
+|	d
+k    rd}n=t          |dd	|g          \  }	}
+|	d
+k    rd}nt          
+                    d           ||fS |r7t          
+                    d| j        | j                   t          |d           t                              d| j        | j                   t          |          5  d}t!          j        |          }t%                      }| j         dd          D ]}|.t                              d| j                    d d d            dS t          
+                    d|j                   |j        sBt                              d           t                              d            d d d            dS |j        D ]\  }}}||v r|                    |           t%          |          dhk    rt          
+                    d|           Q||k    s1t          
+                    d||           |                    |           t          |d|g          \  }	}
+|	d
+k    ryt                              d||           t                              d           t                              d           t                              d             d d d            dS t          
+                    d|           |
+                                }dddd | d!| g}t          d |          \  }	}
+|	d
+k    r+t                              d"||             d d d            dS |                    |j                            t0          #                              d$                     |                                 t          d d%g          \  }	}
+|	d
+k    r(t                              d&           	 d d d            dS |
+                                }d'|d(z   d)d*g}t          d |d+                    d$          ,          \  }	}
+|	d
+k    r(t                              d-           	 d d d            dS |
+                                }t          d d.d/|g           t          d d0|g          \  }	}
+|	d
+k    r.t                              d1| j                   	 d d d            dS t          d dd2g          \  }	}
+|
+                                }t                              d3||           d d d            n# 1 swxY w Y   t          
+                    d4           t          
+                    d5||           t7          | d6| d7|d           ||fS )8Nz!Cannot operate on an empty seriesNNfakeamsuffixFr  Tcat-file-er   z Using previously generated rangezStale cache for [v%s] %szPreparing fake-am for v%s: %sz.__git-am__rY   z>ERROR: v%s series incomplete; unable to create a fake-am rangezLooking at %sz'ERROR: some patches do not have indexesz'       unable to create a fake-am ranger  z  New file: %sz  Renamed file: %s -> %s	rev-parsez1  ERROR: Could not find matching blob for %s (%s)z:         If you know on which tree this patchset is based,z;         add it as a remote and perform "git remote update"z/         in order to fetch the missing objects.z  Found matching blob for: %szupdate-indexz--addz--cacheinfoz0644,,z/  ERROR: Could not run update-index for %s (%s)policyr   z
+write-treez#ERROR: Could not write fake-am treezcommit-treez^{tree}z-F-zInitial fake commitstdinzERROR: Could not commit-treeresetz--hardamz#ERROR: Could not fake-am version %sr  z  range: %.12s..%.12szSaving into cache:z
+    %s..%srw   rH   )r\   rS   r^   r{   	get_cacherh   r   r   rx   r  r_   rb   rj   clear_cacherc   git_temp_worktreemailboxmboxr   rL   r  r   r   	as_string	emlpolicyencodeclose
+save_cache)rD   r  start_commit
+end_commitrS   rQ   	cachedata
+stalecacher  r  rN   mbxfmbxr  r  ofir  fullrefr-  treeids                       r   make_fake_am_rangezLoreSeries.make_fake_am_range  s   $((zL 	 	D
+   =OO?@@@:eH555	 	4T0 	4J__&&,,..F6{{a+1(jj!
+'J,B,Vj$5UVV
+s199!%JJ!0*dJ9W!X!XJE3qyy%)
+
+%GHHH+Z77 47UUUE(33333T]DLQQQv&& A	K A	K D,t$$CIQRR( %N %N<OO$dfjfsttt%A	K A	K A	K A	K A	K A	K A	K A	K _d.?@@@( &OO$MNNNOO$MNNN%A	K A	K A	K A	K A	K A	K A	K A	K &*%6 * *MCci'' MM#&&&3xxC5((%5s;;; #::%?cJJJ!c***!0+s9K!L!LJE3qyy([]`befff(deee(efff(YZZZ)zGA	K A	K A	K A	K A	K A	K A	K A	KH LL!@#FFF!iikkG-wG^wG^G^Y\G^G^_G!0w!?!?JE3qyy(Y[^`ghhh)zUA	K A	K A	K A	K A	K A	K A	K A	KP ! **)*<<CCGLLMMMMIIKKK(~>>JE3qyy EFFF!cA	K A	K A	K A	K A	K A	K A	K A	Kd YY[[F$fy&8$DG(w>S>Z>Z[b>c>cdddJE3qyy >???!qA	K A	K A	K A	K A	K A	K A	K A	Kr 99;;LD7Hl"CDDD(d|<<JE3qyy Et}UUU!}A	K A	K A	K A	K A	K A	K A	K A	K~ )V/DEEJE3JKK/zJJJCA	K A	K A	K A	K A	K A	K A	K A	K A	K A	K A	K A	K A	K A	K A	KF 	)***\<<<<l33Z333U8LLLLZ''sD   %AV+AV+5DV+A2V+BV+7A&V+*A#V+AV++V/2V/c                 ,   | j         d                             d          }t          |d          5 }|                    t                              |d                     d d d            n# 1 swxY w Y   t                              d|           d S )Nr   F)r   wbdecodeheadersz	Cover: %s)r\   r   openwriterU   get_msg_as_bytesr^   r{   )rD   outfile	cover_msgfhs       r   
+save_coverzLoreSeries.save_coverW  s    LO222FF	'4   	PBHH[11)X1NNOOO	P 	P 	P 	P 	P 	P 	P 	P 	P 	P 	P 	P 	P 	P 	PW-----s   0A..A25A2)rQ   rU   rT   NFrT   N)FFFFNNFFr?   )Nr  )#r   r   r   r   r   r   r   r   r   rK   rg   boolri   rh   r   r   r   rE   rR   r|   r   tupler   r   r   r   r   r
+  r  rB   r  rx   r:  r^  rj  r   r   r   rq   rq     s        MMMMMM(=)****M""""E#sC"456666HdIt ND   LLL/3GXd5c?+,333!%K#%%%#Ix}###$ $ $ $ $ $ $  *3 3 3 3<  #    2/5 /T / / / /G G G G ^cRWr r\`afanav\wr r r rh0 0 0"- -# -8C= -ERUW[R[L\ - - - -.A A Ax~ As A\abegjlobo\p A A A AFl( l( l(\. . . . .r   rq   c            
+       :   e Zd ZU eed<   eed<   eed<   eed<   dZee         ed<   dZeeeef                  ed<   dZ	h dZ
+ee         ed	<   	 	 ddee         dee         dee         d
+eej        j                 fdZddedefdZddededefdZd Zd Zd ZdS )r   typer   lnamer   Nextinfoaddr>   
+message-idlinkfixesclosesbuglink	change-idbase-commitobsoleted-by_utilityr   c                 &   |Kd| _         t                      }|d         d|d         d| _        d| _        |d         |d         f| _        n|| _         || _        |                                | j        v sd|v rd| _        nbt          j        d	|          rFd| _        t          j
+                            |          | _        t          | j        g          | _        nd
+| _        | j                                         | _        || _        || _        d S )NzSigned-off-byr    <r   >person://utility\S+@\S+\.\S+unknown)r   r   r   rp  rs  r   r|  r   r   r   r   	parseaddrformat_addrsrq  rr  r   )rD   r   r   rr  r   ucfgs         r   rE   zLoreTrailer.__init__j  s    <'DI"$$D&*6lllDMMMBDJ DIftG}5DIIDIDJzz||t},,%		?E22 &$	!K11%88	)49+66
+
+%	Y__&&
+r   Fomit_extinforT   c                     | j          d| j         }| j        r|r|S | j                                        d         dk    r|| j        z  }n|d| j         z  }|S )N: r   #rH   )r   r   rr  lstrip)rD   r  rets      r   rP  zLoreTrailer.as_string  su    **dj**| 	| 	J<  #s**4<CC&&&&C
+r   T	cmp_emailfuzzyc                 f   | j         sdS | j         d                                         }|                                }||k    rdS |sdS d|vsd|vrdS t          j        dd|          }t          j        dd|          }||k    rdS |                    dd          \  }}|                    dd          \  }}||k    rdS t          |                    d          |                    d          z
+            dk    r2|                    d|           s|                    d|           rdS dS )NFrY   Tr   z\+[^@]+@maxsplit.)rs  r   r   r   r   abscountendswith)	rD   r  r  ourtheirolocalodomaintlocaltdomains	            r   email_eqzLoreTrailer.email_eq  sV   y 	5il  ""!!%<<4 	5c>>S--5 f[#s++{C//%<<4 ))C!)44++cA+66V5c""7==#5#5566!;;%%m'mm44 <8?8H8HW8W8W <4ur   c                     | j         |j         k    o3| j                                        |j                                        k    S r?   )rq  r   r   )rD   others     r   __eq__zLoreTrailer.__eq__  s7    zU[(VTZ-=-=-?-?5;CTCTCVCV-VVr   c                 >    t          | j         d| j                   S )Nr  )hashrq  r   rC   s    r   __hash__zLoreTrailer.__hash__  s"    tz11TZ11222r   c                 0   t                      }|                    d| j        z             |                    d| j        z             |                    d| j        z             |                    d| j        z             d                    |          S )Nz
+  type: %sz
+  name: %sz  value: %sz  extinfo: %srH   )rB   rJ   rp  r   r   rr  rM   rD   rN   s     r   rR   zLoreTrailer.__repr__  s    ff
+
+<$)+,,,
+
+<$)+,,,
+
+=4:-...
+
+?T\1222yy~~r   )NNNNrk  T)r   r   r   rK   r   rr  r   rs  r   rQ   r|  r   r   r   r   rE   rm  rP  r  r  r  rR   r   r   r   r   r   _  se        
+III
+IIIJJJJJJ!GXc]!!!&*D(5c?
+#***DyyyHc#hyyyim8< Xc] (3- YabeYf u}45   0
+ 
+d 
+s 
+ 
+ 
+ 
+ # d d    BW W W3 3 3    r   r   c                      e Zd Zd Zd;dedeee         ee         f         fdZ	e
+d             Zd<dZd<d	Zd<d
+Zd=dededeeeef         fdZd Zedej        j        deeef         fd            Zed             Ze	 	 d>dededed         defd            Ze	 	 d?dej        j        deded         defd            Zededefd            Zed@dej        j        defd             Z ed!ej        j        d"ej        j        dej        j        fd#            Z!ed$ede"e         fd%            Z#ed$edefd&            Z$ed$edee%         fd'            Z&ed;d(ed)edeee         ee         f         fd*            Z'edee         d+ed,ee         d-ed.edefd/            Z(ed(edeee         eee         eef         fd0            Z)	 	 	 	 dAd2e"ee                  d3ed4ed5ed6e"ee                  ddfd7Z*dBd9Z+dCd:Z,dS )DrU   c                 	   || _         d | _        d | _        d | _        d | _        d| _        d| _        d | _        d| _        d| _	        d| _
+        d| _        d | _        d | _        d | _        d | _        d | _        d | _        d| _        d| _        d| _        t+                      | _        t+                      | _        d | _        d | _        d | _        d | _        d | _        d | _        d | _        t>                               | j                   | _        tC          |d                   | _        | j        j        | _        | j        j        | _        | j        j        | _        | j        j        | _        | j        j        | _        | j        j	        | _	        | j        j
+        | _
+        | j        j        | _        d | _"        | j        | j	        k    r| j        | _	        t>                               | j         d          | _        	 tF          j$        %                    d | j         &                    d	g           D                       d
+         }|d
+         | _        |d         | _        tO          | j        (                                          s| j        | _        n# tR          $ r Y nw xY w| j         *                    d          }|r2tF          j$        +                    tY          |                    | _        n#tZ          j-        .                                | _        | j        j/        /| j        0                    tZ          j1        j2                  | _        t>          3                    | j                   \  | _        | _        | j        <th          5                    d           th          6                    d| j                   d S tn          8                    | j                  rd| _        tr          8                    | j                  rOd| _        t>          :                    | j                  | _        t>          ;                    | j                  | _        t>          <                    | j        d          \  }}|r/| j        r(| j        s!th          5                    d           d| _        | j        r,|D ]+}h d}|j=        |vr| j        >                    |           *d S d S )NFrY   Tr   SubjectIn-Reply-To)headerc                 \    g | ])}t                               t          |                    *S r   )rU   clean_headerrK   r   s     r   r   z(LoreMessage.__init__.<locals>.<listcomp>  sB     1X 1X 1X56 2=1I1I#a&&1Q1Q 1X 1X 1Xr   r   r   Datetzinfoz*  No plain or patch parts found in messagez  Not plaintext: %s)followupzEA follow-up missing a Re: but containing a trailer with no patch diff>   cctor   r   r   rj   	subscribeunsubscribe)?r   rS   r   rL   rj   r   rb   rf   r`   ra   r   r   r]   r   r   r   r   r   r   r~   r}   rB   r   r   pr_base_commitpr_repopr_refpr_tip_commitpr_remote_tip_commitr   r  rU   r   LoreSubject
+_attestorsr   r   r   r   rx   r   r(  r   parsedate_to_datetimerK   r%  r&  r  replacetimezoneutcget_payloadr^   r_   rc   DIFFSTAT_REr   DIFF_REget_patchwork_hashget_indexesfind_trailersrq  rJ   )rD   r   fromdatamsgdater   othersr	  badtrailerss           r   rE   zLoreMessage.__init__  sq   
+  
+$(!!%!%  	 	!!% #!$(!   00::
+#C	N33 M6},](
+.},.!%!@!%!@  <$-'' LDM&66tx6VV	{// 1X 1X:>(:J:J6SU:V:V1X 1X 1X Y YYZ\H$QKDM%a[DNt}**,,-- / $ 	 	 	D	 (,,v&& 	099#g,,GGDII !)--//DI9#	))1B1F)GGDI #."9"9$("C"C	4<9LLEFFFKK-t/@AAAFdi(( 	% $D>>$)$$ 	C DM%88CCDK + 7 7	 B BD&44TY4NN& 	( 	 	LL`aaaDJ: 	2# 2 2; ; ;=33M((111	2 	22 2s   ;BJ 
+JJFrv   rT   c                    t                      }t                      }| j        D ]}| |_        |s|j        dk    r|                    |           -|                    | j                  r0t          	                    d           |                    |           wd}|j
+        d                                         }| j                                        }||k    rt          	                    d           d}nb|                    d          dk    rId}|                    d          D ]1}|                    |                                          dk     rd} n2|r1t          	                    d           |                    |           it          	                    d	|j        |j                   |                    |           ||fS )
+Nr  z  trailer email matchFr   z  trailer exact name matchTrC  z  trailer fuzzy name matchztrailer did not match: %s: %s)rB   r   r   rQ   rp  rJ   r  r   r^   r_   rs  r   r   findr   r   r   r   r   )	rD   rv   r   r   r   nmatchtlnamehlnamenchunks	            r   r   zLoreMessage.get_trailers2  s   66UU
+= !	  !	 CCH X--$$$||DN++ 4555$$$ FXa[&&((F]((**F9::: S!!A%%$ll3//  F{{6<<>>22Q66!& 7  9:::$$$LL8#(CINNNNN3##r   c                    | j         | j         S t                      | _         t                      }|d         dk    r| j         S t                              d| j                   | j                            t                    r| 	                                 | j                            d          r |d         dk    r| 
+                                 t                              dt          | j                              | j         S )Nr*   r   zLoading attestation: %sdkim-signaturer.   r/   zAttestors: %s)r  rB   r   r^   r_   rL   r   r   
+DEVSIG_HDR_load_patatt_attestors_load_dkim_attestorsrx   rD   r   s     r   	attestorszLoreMessage.attestors[  s    ?&?"&& ""&'500?".0ABBB8<<
+## 	*'')))8<<()) 	(f5M.NRW.W.W%%'''_c$/&:&:;;;r   Nc                    t           st                              d           d S t          st                              d           d S t	                      }t	          | j        j                  D ]T}|d                                         dk    r4|                    |           | j        j        	                    |           U|
+                                 t	                      }|D ]\  }}d|v rIt          t          j                            t          j                            |                              }t	                      }t                               |          }t                              d|d         |d                    |                    d	          }|s|                    d          }|                    d
+          }	d }
+|	rt&                              |	          }
+nE|                    d          }d|                                                    d          v r| j        }
+| j        j                            ||f           	 t/          j        | j                            t4                    t6                    }t                              d||           nV# t8          $ rI}t                              d|           |                    t          |                     d}Y d }~nd }~ww xY wt;          |||
+|          }|                    | j                  r| j                             |            d S | j        j        !                    d           |                    |           | xj         |z  c_         d S )Nz3Message has DKIM signatures, but can_network is offz0Message has DKIM signatures, but can_dkim is offr   r  z?q?z'Loading DKIM attestation for d=%s, s=%sdsithr   :rD  )r^   zDKIM verify results: %s=%szDKIM attestation failed: %sF)"can_networkr^   r_   r   rB   r   _headersr   rJ   removereverserK   r   r  make_headerdecode_headerrU   get_parts_from_headerr   LoreAttestorparse_tsr   r   r   verifyas_bytesrQ  
+dkimlogger	ExceptionLoreAttestorDKIMcheck_identityr   r  pop)rD   dkhdrsr  seenattshnhvalerrorshdataidentitytssigntimeshresexattestors                  r   r  z LoreMessage._load_dkim_attestorso  s/    	LLNOOOF 	LLKLLLF 48,-- 	1 	1Fay  $444f%%%!((00066 (	& (	&HB }}5<33EL4N4Nt4T4TUUVVVVF55d;;ELLBE#JPUVYPZ[[[yy~~H * 99S>>3BH )'0044 YYs^^RXXZZ--c2222#yHH$$b$Z000k$("3"39"3"E"EjYYY98SIIII    :B???c"gg&&& (XxHHH&&t~66 &&x000H!!"%%%OOH%%%% 	8#s   AJ''
+K:1?K55K:c           	      ^   | j                             d          }|sd S t          j        d|          }|sd S t	          |                                d                   }t          | j                             t                    d          \  }}}d}t          j	        dd||z             
+                    d	          D ]}|t          j	        dd|          d
+z   z  }t          |          |k    r8|d |                                         | _        t                      }	|                    d          | j        k    r+|	                    d|                    d          z              |                    d          | j        k    s|                    d          | j        k    rN|	                    dt'          |                    d          |                    d          fg          z              t          |	          r)d                    |	          dz   | j        z   | _        d S d S d S )Nr$   z
+\s+l=(\d+)r   rD  Fscissorsr      [\r\n]*$   
+   
+r  z	Subject: EmailAuthorFrom: rH   
+
+)r   r   r   r   r   r   get_mailinfor  rQ  r   r   rx   ra  r   rB   rj   rJ   r   r   r  rM   )
+rD   xdshr   blr  mpbbr6  ibhs
+             r   
+_trim_bodyzLoreMessage._trim_body  s   x||344 	F)M400 	F!!!$%%tx00	0BBUSSS1aF<a!e44::5AA 	< 	<D"&sD11G;;BBr77R<<3B3((DI &&CuuY4<//
+
+;y)9)99:::uuW~~//155??dm3S3S
+
+8lQUU8__aeeGnn4U3V&W&WWXXX3xx @ IIcNNV3di?			 <@ @r   c           	         t           s"t                              dt                     d S t	                      }t
+          j                            |d          }t                      }|	                    d          }|s2t          j        ddg          }|	                    d          }|sg d}||vr|                    |           t          t          _        |d         t          _        t                              dt          |                     d	}d	}	 t          j        | j                            t$                    ||          }|D ]}	|	d         t          j        k    rd
+} n|r|r|                                  n|s|rnd
+}u|D ]\  }
+}}}}}|r|                    d          r~|                    dd          d         }t/          |          }d	}|D ]}|                    |          dk    rd
+} n |s-t2          j                            |d                   }|d         }|rt8                              |          }nd }t=          |
+|||||          }| j                            |           d S )Nz-Message has %s headers, but can_patatt is offkeyring
+keyringsrcz
+patatt\..*)	multivals)zref:::.keyszref:::.local-keyszref::refs/meta/keyring:r5   z+Loading patatt attestations with sources=%sFTrD  )	trim_bodyr   z(default keyring)/r   rY   ) r   r^   r_   r  get_data_dirospathrM   r   r   patattget_config_from_gitrJ   GPGBINrK   validate_messager   r  rQ  	RES_VALIDr  r  r   get_gpg_uidsr  r   r   r  r  r  LoreAttestorPatattr  )rD   ddirpdirr   sourcespatatt_configsuccessr  attestationsattestationresultr  r  keysrckeyalgor  fpruidsidmatchuidpartssigndtr  s                          r   r  z"LoreMessage._load_patatt_attestors  s    	LLH*UUUF ~~w||D),, ""**\** 	Z"6}Q]P^___M#''55G ZYYYwNN4    x(BCLLQQQ		!2483D3DI3D3V3VX_ktuuuL+  q>V%555"GE 6   & OO%%% y I!	$ DP 	- 	-?FHh (&++,@AA (ll3**1-#C((  Cxx))Q.."& /  (!K11$q'::E$QxH %..x88)&(FFGU[\\HO""8,,,,'	- 	-r   r   r   r   c           	      B   t                      }d }d}| j        D ]}|j        r>|r<|                    | j        |          s!t
+                              d           d|_        |j        s|j        dk    r]|j        r,|	                    |j
+        d|j                   |j
+        }n[|dv r%|	                    |j
+        d|j                   n1|dv r-|s|j
+        }|	                    |j
+        d|j                   |dk    rd}d}|s|j
+        }|                    | j                  rd}n| j                            d	          }|rt
+                              d
+           t           j                            |g          d         }	|                    |	d                   rd}|	d         | _        |	d         | _        t          | j        j                  D ]d}
+|
+d                                         dk    rD|
+d                             |	d                   dk    r| j        j                            |
+           e|r&|	                    |j
+        d|j                   S|	                    |j
+        d|j        d| j        d           |||fS )NFz2The time drift is too much, marking as non-passingr  z	 BADSIG: )r+   hardfailz	 No key: r/  TzX-Original-Fromz(Using X-Original-From for identity checkr   rY   zreply-toz	 Signed: z (From: ))rB   r  passingcheck_time_driftr   r^   r_   levelhave_keyrJ   r  r	  r  r   r   r   r   r   r   r   r  r   r  r  )rD   r   r   r   r  r{   r  r1  xofhxpairr  s              r   r   z$LoreMessage.get_attestation_trailers	  s   66	 /	S /	SH )G )H4M4MdiY`4a4a )QRRR#( # +S>X--( ! 8;M;M;MxO_O_(`aaa$,$6		"&>>> 8;M;M;MxO_O_(`aaa  ? ":::$ 7$,$6	OOx7I7I7I8K[K[$\]]]
+**#H  3 ( 2I**4>:: E"GG  8<<(9::D E%OPPP % 8 8$ @ @ C#2258<< E&*G,1!HDM-21XDN*.tx/@*A*A E E#)!9??#4#4
+#B#Bvay~~V[\]V^G_G_bcGcGc$(H$5$<$<V$D$D$D SOOx7I7I7I8K[K[$\]]]]OO(BTBTBTV^VfVfVfBF...%R S S S S (H,,r   c                    t                      }|                    d| j        z             |                    t          | j                             |                    d| j        z             |                    d| j        z             |                    dt          | j                  z             |                    d| j        z             |                    d           | j	        
+                    d          D ]}|                    d|z             |                    d	           |                    d
+| j        z             |                    d| j        z             |                    d           | j        D ]'}|                    dt          |          z             (|                    d           | j        D ]'}|                    dt          |          z             (|                    d           |                    d           | j        D ]'}|                    dt          |          z             (|                    d           d                    |          S )Nz	msgid: %sz  fromname: %sz  fromemail: %sz
+  date: %sz  in_reply_to: %sz  --- begin body ---rH   z  |%sz  --- end body ---z  has_diff: %sz  has_diffstat: %sz  --- begin my trailers ---z!  --- begin followup trailers ---z  --- end trailers ---z  --- begin attestors ---z  --- end attestors ---)rB   rJ   rS   rK   r   r   r   r   r]   r   r   r~   r}   r   r   r  rM   )rD   rN   r6  r	  r  s        r   rR   zLoreMessage.__repr__@  sF   ff
+
+;+,,,
+
+3t}%%&&&
+
+#dm3444
+
+$t~5666
+
+<#di..0111
+
+&)99::: 	
+
+)***IOOD)) 	' 	'DJJw~&&&&
+
+'((( 	
+
+#dm3444
+
+'$*;;<<<
+
+0111} 	/ 	/GJJwW-....
+
+6777- 	/ 	/GJJwW-....
+
++,,,
+
+./// 	0 	0HJJwX.////
+
+,---yy~~r   r   c                 R   |                                  }|sd}d }|                                 D ]}|                                }|                    d          dk     r|                    d          dk     rI|                    d          }|b|                                 }|s|}	 |                    |d          }|}n?# t          $ r2 |                    dd          }|                    d	d           d}Y nw xY w||}t          	                    |          r|}||fS )
+Nr   z/plainr   z/x-patchTra  r  r  r   )
+get_content_charsetwalkget_content_typer  r  ra  LookupError	set_paramr  r   )r   mcharsetmbodypartctepayloadpcharsets          r   r  zLoreMessage.get_payloada  s`    **,, 	HHHJJ 	  	 D''))Cxx!!A%%#((:*>*>*B*B&&d&33G//11H $##!..).DD# # # # "...CCy'222"# } ~~g&&  hs   *C9D ?D c                 
+   | dS |                      d          dk    rt          j        d| t          j        t          j        z            rt                      }t          j                            | g          D ]}|d                              d          dk    r(t          
+                    |d                   |d         f}t          j        d|d                   r)|                    d|d          d	|d          d
+           |                    t          j                            |                     d                    |          S d}t          j                            |           D ]e\  }}|d}	 ||                    |d          z  }%# t"          $ r ||                    dd          z  }Y Kt$          t&          f$ r ||z  }Y bw xY wn| }t          j        dd|          }|                                S )Nrt   =?r   z	<\S+@\S+>r    rY   z[^\w\s]"" <r  , r   r  r:  z\n?\s+rw   )r  r   r   r   r   rB   r   r   r   rU   r  rJ   
+formataddrrM   r  r  ra  r>  UnicodeDecodeErrorAttributeErrorr   r   )hdrvalnewaddrsrs  decodedhstrhcs
+new_hdrvals          r   r  zLoreMessage.clean_header  s   >2;;t!!yvRTBD[AAA +66!K44fX>> F FDAw||D))Q.. + 8 8a A A47KyT!W55 F (BDG(B(BQ(B(B(BCCCC (>(>t(D(DEEEEyy***G"\77?? 	$ 	$	c;!C$t{{3y{AAAGG" F F Ft{{79{EEEGGG*N; $ $ $tOGGG$	$ GVIsG44
+!!!s   <F$G=GGK   rH   preservewidthnl	transform)rR  ra  rU  c                    | \  }}|                                 dv r;| dg}d}t          j                            |g          D ]}|dk    rn|d                                         sTt          j                            |d                                         d          |d         f}t          |gd	
+          }	n+|dk    rt          |gd
+          }	nt          |gd	
+          }	|r|dxx         |	z  cc<   d	}t          |d         dz   |	z             |k    r&|dxx         dz  cc<   |
+                    |	           |dxx         d|	z   z  cc<   n|dk    r:|                    d          dk    r!| dt                              |          z   }
+n| d| }
+|dk    s|                                rt          |
+          |k    r|
+                                S |
+                    ddd          }
+t          j        |
+d	d	d|          }|                    |                              ddd                                          S | dt          j                            |                                d          z   }	t          |	          |k    r|	                                S t%                      }t          |	          |k    r||dz
+  }t          |          r|dz  }d|	|dz
+  |         v r|dz  }d|	|dz
+  |         v |
+                    |	d |         dz              d|	|d          z   }	t          |	          |k    ||
+                    |	           | d                    |                                          S )N)r  r  r   zx-original-fromr  TrR  r   r   r   rY   F)cleanra  r  rJ  z?=z:_rw   )break_long_wordsbreak_on_hyphenssubsequent_indentrV  r  =z
+=?utf-8?q?)r   r   r   r   isascii
+quoprimimeheader_encoderR  r  rx   rJ   r  rU   r  r  textwrapwraprM   rB   )hdrrV  rW  rX  hnamer  _partsfirstrs  qpr  wrappedwrapats                r   wrap_headerzLoreMessage.wrap_header  s    t;;==CCClll_FE00$88 ( (((a1B1B(!,::47>>;K;KU\:]]_cde_fgD%tfE:::BB(**%tfD999BB%tfE:::B 2JJJ"$JJJ!EvbzD(2-..662JJJ$&JJJMM"%%%r
+
+
+dRi'
+
+
+
+#(& H$$4A)=)= {'?'?'E'EE **D**H$$$u::&& <<>>) dD!44"-X]:=UL L Lwww''//dA>>EEGGG 0 > >t{{}}V] > ^ ^^B2ww%yy{{"VVFb''E//v;;  aKFRq000aKF Rq000b&kD0111"R[0 b''E// MM"xxx}}V$$++---r   rc  c                    d}|                                  D ]I\  }}|t                              |t          |          f||          |                                z   z  }J||                                z  }|                     d          }|                    d          D ]0}|t          j        dd|          |                                z   z  }1|S )Nr   )rW  rX  Tr9  r  r   )	rI   rU   rk  rK   rR  r  r   r   r   )r   rW  rc  bdatare  r  rD  blines           r   rf  zLoreMessage.get_msg_as_bytes  s     99;; 	i 	iKE4[,,eSYY-?BRY,ZZ]_]f]f]h]hhhEE///..]]5)) 	D 	DERVL#u55		CCEEr   rQ  c                     t          j        dd|           } t                      }|                     d          D ]=}|                    dd          }t	          |          dk     r,|d         ||d         <   >|S )Nz\s*rt   ;r^  rY   r  r   )r   r   r@   r   rx   )rQ  r  chunkr,  s       r   r  z!LoreMessage.get_parts_from_header  st    vfb$''ZZ__ 	' 	'EKKQ''E5zzA~~#AhE%(OOr   
+Message-Idc                     d }|                      |          }|rIt          j        dt                              |                    }|r|                                d         }|S )Nz	<([^>]+)>r   )r   r   r   rU   r  r   )r   r  rS   rawr   s        r   r   zLoreMessage.get_clean_msgid  s^    ggfoo 	,ik.F.Fs.K.KLLG ,((+r   msg1msg2c                 &   t                      }t                              | d          }|r*d}|d         D ]}t          j        ||          r n|dz  }n|d                             d          }t                              |d          }|r*d}|d         D ]}t          j        ||          r n|dz  }n|d                             d          }||k    rt
+                              d|           | S t
+                              d|           |S )Nzlist-idr   r(   rY   *z*Picked duplicate from preferred source: %s)r   rU   r   fnmatchindexr^   r_   )ru  rv  r   listid1prefidx1listgloblistid2prefidx2s           r   get_preferred_duplicatez#LoreMessage.get_preferred_duplicate  s6    ""--dI>> 	>H"#67  ?7H55 EA1288==H--dI>> 	>H"#67  ?7H55 EA1288==HxLLEwOOOKA7KKKr   diffc                     ddg}t          d ||                                           \  }}|dk    s!t          |                                          sd S |                    d          d         S )Nzpatch-idz--stablerG  r   rY   r  )r  rR  rx   r   r   )r  r-  r  rN   s       r   get_patch_idzLoreMessage.get_patch_id$  sg    z*$T7$++--HHH
+s199C		,,94yy!y$$Q''r   c                    g d}t          j                    }|                     d          D ]L}t          |          dk    rt                              |          }t                              |          }|r|                    d          dk    rd}nd}|d                    |                    d	                              d          dd
+                   z  }|                    d          dz   |z   }nT|rEd }t          t          ||                                                    }dt          |          z  }n|d         |v rn!|                    |dz                       d                     N|                                S )z<Generate a hash from a diff. Lifted verbatim from patchwork.)rF  +rw   rH   r   rY   r   za/zb/r   r  Nrw   c                 (    | sdS t          |           S r   )r   r#   s    r   r  z*LoreMessage.get_patchwork_hash.<locals>.fnE  s     ! qq66Mr   z@@ -%d +%d @@r   )hashlibsha1r   rx   HUNK_REmatchFILENAME_REgrouprM   rB   mapr   rn  updaterR  	hexdigest)	r  prefixeshashedr6  
+hunk_matchfilename_matchfilenamer  line_noss	            r   r  zLoreMessage.get_patchwork_hash,  s    #??JJt$$  	9  	9D4yyA~~ t,,J(..t44N !''**e33#HH#HCHH^%9%9!%<%<%B%B3%G%G%KLLL%++A..4x? " " "
+  B
+(9(9(;(; < <==&x8aH$$ MM4$;..w778888!!!r   c                    t                      }d }d }|                     d          D ]}|                    d          dk    r|                    d          dk    r5t          j        d|          }|r5|                                d         }|                                d         }t          j        d|          }|r4|2|0|                    ||                                d         |f           |S )NrH   diff r   zindex z"^diff\s+--git\s+\w/(.*)\s+\w/(.*)$rY   z"^index\s+([\da-f]+)\.\.[\da-f]+.*$)r   r   r  r   r   r   r   )r  r   oldfilenewfiler6  r   s         r   r  zLoreMessage.get_indexesW  s    %%JJt$$ 
+	E 
+	EDyy!!Q&&499X+>+>!+C+Ci EtLLG !..**1-!..**1-i EtLLG E7.73FWgnn&6&6q&97CDDDr   r   r  c                    ddh}h d}h d}|h dz  }|                      dd          d                                         d	z   } t          j        d
+d| t          j                  } t          j        dd| t          j                  } t                      }t                      }d}d}	|                      d	          D ]E}
+|	dz  }	|
+                    d          }
+t          j        d|
+t          j                  }|rt          |                                          \  }}|	                                }||v rt                              d|	|
+           t          |          r!||v rt                              d|	|
+           |r|                                st                              d|	|           t          j        d|          }|s"||vrt                              d|	|
+           6t          j        d|          }|r"||vrt                              d|	|
+           od }t          j        d|          }|r@t                              d|	|
+           |                                }|d         }|d         }d}t          |||          }|                    |           t          |
+          dk    r(|r&t          j        d|
+          r|
+|d         _        d}.d}|                    |
+           G||fS )Nphoner   >   r   r   rj   >   ru  rw  rx  >   r   rv  rj   ry  rz  r{  
+-- 
+rY   r   rH   z(^(\S+:\s+[\da-f]+\s+\([^)]+)\n([^\n]+\))\1 \2r    z^(\S+:\s+[^<]+)\n(<[^>]+>)$Fz^\s*(\w\S+):\s+(\S.*)z#Ignoring %d: %s (known non-trailer)z,Ignoring %d: %s (header after other content)z3Ignoring %d: %s (known non-ascii follow-up trailer)r  z5Ignoring %d: %s (not a recognized non-person trailer)z	https?://z/Ignoring %d: %s (not a recognized link trailer)z(.*\S+)(\s+#[^#]+)$z(Trailer contains hashtag extinfo: %d: %sT)r   r   rr  r  z^\s*\[[^]]+]\s*$r  )r   r   r   r   r   rB   r   r   r   r   r^   r_   rx   r_  r   rJ   rr  )r   r  ignoresrc  links	nonpersonr   r  was_trailerrp   r6  r   onameovaluerq  mpersonmlinkrr  mextinfoegrltrailers                        r   r  zLoreMessage.find_trailersi  s%   G$------dddd	zz)Q''*0022T9 vA8TY[Y]^^^ v4hBDQQQ 66JJt$$ 0	  0	 D!GB::d##Di 8$bdKKKG # $W^^%5%5 6 6vG##LL!FDQQQv;; 5G#3#3LL!OQSUYZZZ ! ==?? !%Z\^`efff  i@@G" !uI'='=%\^`bfggg IlF;;E !e!3!3%VXZ\`aaa 9%;VDD %LL!KRQUVVV"//++C VF!!fG"&EQQQ))) 4yy1}}};NPT1U1U}'+$#KMM$r   r   r   basement	signaturec                    d}| r&| D ]}||                     d          dz   z  }|dz  }t          |          r/||                    d          dz   z  }t          |          r|dz  }|D ]}||                                 dz   z  }t          |          r4t          |          s|dz  }|dz  }||                    d          dz   z  }t          |          r |dz  }||                    d          dz   z  }|S )Nrt   Tr  rH   
+---
+z-- 
+)rP  rx   rstrip)rc  r   r   r  r  r   r   s          r   rebuild_messagezLoreMessage.rebuild_message  s4     	 @ @4884??DLDw<< 	GNN6**T11D8}}  	+ 	+CCMMOOd**DDx== 	3x== GODHOOF++d22Dy>> 	4GODI$$V,,t33Dr   c                 b   |                      dd          } |                     d          } t                      }d}d}d}|                     dd          }t	          |          dk    r#|d         }|d                             d          } t          j        d| dt          j                  }t	          |          d	k    r|d                             d          }nk| 	                    d
+          dk    rR|                     d
+d          }t	          |          d	k    rd|d         z   |d<   |d                             d          }|d                             d          }|                    d          }t                      }	t                              |d                   \  }
+}t	          |          r|	                    |d                    n|
+}t                              |d                   \  }}t	          |          dk    r2||k    rt                      }|rd                    |          }|||||fS t	          |          d	k    r|	|dd         z  }	t	          |          r(|	                    d                    |                     d                    |	          }|||||fS )Nr  rt   rH   r  rY   r   z^---
+)r  r!   r  z
+diff r  r  r  )r  r   rB   rsplitrx   r  r   r   r   r  rU   r  rJ   rM   )r   
+githeadersr   r  r  spartsr,  rA  bparampartsr  or   nliness                 r   get_body_partszLoreMessage.get_body_parts  sx    ||D"%%zz$VV
+	Y**v;;??q	I!9##D))D4!24@@@u::??Qxt,,HHYYy!!Q&&JJy!,,E5zzQ"U1X-aQxt,,Hat$$ F## ((q221q66 	MM%(####J '44U2Y??&u::??X%%!VV
+ ,))F++w(IEE u::>>eAbDk!Fv;; 	-MM$))F++,,,++f%%7Hh	AAr   rx  r   r   r   fallback_orderomit_trailersc                 F   t                      }t                              | j                  \  }}}	}
+}t	                      }d}||	v rd}|	                    |           | j        }|r||z  }||v r|                    |           d}|r3t          j        	                    d | j
+                            dg           D                       }|t          j        	                    d | j
+                            dg           D                       z  }|                    d            |D ]}d}|	|z   D ]!}|                    |d	                   rd} n"|set          |d
+                   r$t	          d|d
+          d|d	          d          }nt	          d|d	                   }|                    |           |                    d|          }|r|dk    rt#          |	          D ]:}|j        dk    r n,|	                    |           |                    d
+|           ;t)                      }d |                    d          D             D ]i}t          |          s nWt)          |          D ]F}t-          j        |j        |          r*|                    |           |                    |           Gjt          |          r||z  }|}|d         }|	}|                    d          }|r+d t          j        	                    |g          D             }nt)                      }t/                      }|D ]}||v s||v r|j        rf|j        d	                                         |v rEt4                              d|                    d                     |                    |           y|                    |           d}|j        |j        j        D ]}|j         rd|j!        d|j"        d}|dv rad|j!        d|j"        d}|dk    rHd
+d l#} t4          $                    d           t4          $                    d             | j%        d	           t4                              d!|                    d          |           X|4||v r0t4                              d!|                    d          |           |s|rF|                    |           |s/t4                              d"|                    d                     |r%|r#|D ] }|j        |v r|                    |           !| j&        d#z   | _'        t          |          rE| xj'        |(                    d$          d%z   z  c_'        t          |          r| xj'        d%z  c_'        t          |          r*|D ]'}| xj'        |                                d%z   z  c_'        (tS          j        d&|
+tR          j*        '          }!t)          |!          D ]K}"tV          ,                    |"          stZ          ,                    |"          r|!                    |"           L|!r&| xj'        d(d(.                    |!          z   z  c_'        t          /                    ||||
+|          | _        d S ))NFTc                 ,    g | ]}t          |          S r   r   r   s     r   r   z,LoreMessage.fix_trailers.<locals>.<listcomp>-  s    0\0\0\AQ0\0\0\r   r  c                 ,    g | ]}t          |          S r   r   r   s     r   r   z,LoreMessage.fix_trailers.<locals>.<listcomp>.  s    1]1]1]Q#a&&1]1]1]r   r  c                     | d                              d          dk    rC| d                             d          d         | d                             d          d         z   p| d         S )NrY   r   r   )r  r   r  s    r   <lambda>z*LoreMessage.fix_trailers.<locals>.<lambda>0  s^    !		#(:(fqtzz#q?QTUVWTXT^T^_bTcTcdeTf?f(njklmjn r   )rO   rY   r   Ccr~  r  r   ztrailer-orderrx  zsigned-off-byc                 Z    g | ](}|                                                                 )S r   )r   r   r   s     r   r   z,LoreMessage.fix_trailers.<locals>.<listcomp>K  s*    FFFq**FFFr   rC  r*   ztrailers-ignore-fromc                 B    g | ]}|d                                           S rY   )r   r   s     r   r   z,LoreMessage.fix_trailers.<locals>.<listcomp>]  s$    UUUqtzz||UUUr   z    x %sr  rt   z (rw   r0  )r/  r+   r/  r   r   z
+    + %s%sz    + %sr  r  rH   z^---\nr    r  )0r   rU   r  r   r   r  r   r   r   r   r   r   sortr  rx   rJ   r   reversedrq  insertrB   r   ry  r   rs  r   r^   rc   rP  r   rQ   r  r1  r  r	  r   r{   r   rj   r   r  r   r   r  r   r  rM   r  )#rD   r   r   r   r  r  r   bheadersr   	btrailersr  r  sobtrhasmysobnew_trailersalldestspairro   fltraltrtorderbltrordered_trailersglobr   r   fixtrailersignore_fromr  ignoredextrar  r   bpartsbparts#                                      r   fix_trailerszLoreMessage.fix_trailers  s8   
+ !""<G<V<VW[W`<a<a9'9h	IHU###- 	#F"LL  &&&H 	.{//0\0\AQAQRVXZA[A[0\0\0\]]H001]1]$(BRBRSWY[B\B\1]1]1]^^^HMMnnMooo  . .%4  D}}T!W--  $
+  .47|| E*tAw<T<T$q'<T<T<TUUU*DGDDD ''---O^<< 	,fmm !++ - -:00E  &&&##At,,,,#vvFFFLL4E4EFFF 1 1<(( E-- 1 1Csy$77 1(//444$++C0001 <   1 L0 +L/0	 jj!788 	UUU[-E-E{m-T-TUUUGGffG%% 	S 	SCk!!SG^^x CHQK--//7::J4(H(HIIIC   s###Ex# # 2 	( 	(H' ( (.6.@.@.@(BRBRBR S"&>>>>.6.@.@.@(BRBRBR S$
+22&JJJ"OOE222"OO,YZZZ$CHQKKKL#--T-*J*JERRRR#vL#--T-*J*JERRR 	Lx 	Lu%%% LJT(J(JKKK 	,[ 	," , ,9--&&s+++ |f,w<< 	%LLGNN622T99LL; %${ 	7" 7 7$ 66 )XRT:::&\\ 	% 	%E~~e$$ %(:(:5(A(A %e$$$ 	;LLGgll6&:&:::LL//';PXZcdd			r   Tc           	         dg}| j         j        r|                    d           | j        r|rw| j        | j        k    r%|                    d| j        | j        fz             n|                    ddt          t          | j                            z  | j        fz             nB|                    d| j        z             n$| j        s|                    d| j        z             | j         j        s.|                    d| j         j	        | j         j
+        fz             |s| j         j        }dd                    |          d	|S )
+NPATCHRFCzv%d->v%dz %s  v%drw   zv%dz%d/%d[r   )r   rfcrJ   rf   rb   rx   rK   r   r   r`   ra   rj   rM   )rD   indicate_rerolluse_subjectr,  s       r   r   zLoreMessage.get_am_subject  sL   	= 	 LL$ 		0 4,==LLt/H$-.X!XYYYYLLsST=V9W9W5X5X/XZ^Zg.h!hiiiiUT]23333' 	0LL.///}. 	TLLDM$94=;Q#RRSSS 	0-/KHHUOOOO[[99r   c                 $	   |s | j                             dd          | j                                         k    rdd lt                              d           | j                             d          D ]}|                                |                    dd          k    r1fd|                    d          D             }d	|v rWd
+|vrRd}|                    d          D ]9}	                    |	          d	k    rt                              d           t                              d           t                              d| j	                   t                              d|                    d                     t                              dd|z             t                              d
+                    |	          t          t          |	                               t                              d           t          j        d           |dz  };t          j                                        }
+t$                              | j        d                   |
+d<   t$                              | j        d                   |
+d<   t$                              | j        d                   |
+d<   |
+                    | j         d           |
+                    d           t/          j                    }t3          |
+g|d           t5          |                                d          \  }}}|                                |                                z   | _         |r|                     |||           t          j                                        }t=          |                    dd          |                    d          fg          }|                     d| !                    d |                    d          !                     |                     d|           |                     d|                    d                     |                     d"d#| j"         d$           |                    | j         d           |S )%Nasciir  r:  r   zBBody contains non-ascii characters. Running Unicode Cf char tests.rH   c                 :    h | ]}                     |          S r   )category)r   chunicodedatas     r   	<setcomp>z-LoreMessage.get_am_message.<locals>.<setcomp>  s'    NNNb--b11NNNr   r  CfLor   z@WARNING: Message contains suspicious unicode control characters!z         Subject: %sz            Line: %sz            ------%s^rF  z            Char: %s (%s)zH         If you are sure about this, rerun with the right flag to allow.rY   Fromr  r  r   r   T)mangle_fromr  )r   r   r   r  rt   r  F)r  r  rr  <r  )#r   rR  r  r^   r_   r   r  r  r{   rL   r   hexordr   r   r   r   EmailMessagerU   r  r   set_payloadset_charsetioBytesIOsave_mboxrd_mboxr  getvaluera  r  r  r   
+add_headerr   rS   )rD   r   r   r   r   r   r6  ucatsrp   cmi_msgifhr  r
+  r  am_msghfromr  s                    @r   r   zLoreMessage.get_am_message  s     	 !1!1')!1!L!LPTPYP`P`PbPb!b!bLL]^^^	--    ;;==DKK	K$J$JJJNNNNDKK<M<MNNN 5==T%6%6B![[.. 
+  
+ &//22d::"OOE222"OO,nooo"OO,BDDUVVV"OO,BDKKPTDUDUVVV"OO,CSVLLL"OO,GIYIYZ[I\I\^abefgbhbh^i^ijjj"OO,vwwwHQKKKa ++--$11$(62BCCv$11$(62BCCv'44TXi5HIIy49g6667###jll&3D9999s||~~===1aHHJJ+	 	QgPPP++--quuXr22AEE'NNCDEE)T%8%8\]\a\abk\l\l%8%m%mnnn&%(((&!%%--000,(9DJ(9(9(9:::49g666r   rk  rl  )r   )rT  rH   rU  )rH   rU  )rr  )NFFrx  N)TN)TFNFF)-r   r   r   rE   rm  r   r   r   r   r   propertyr  r  r  r  rK   r   rB   r   rR   staticmethodr   r   r   r  r  r   bytesrk  rf  r@   r  r   r  r   r  r  rn  r  r  r  r  r  r   r   r   r   r   rU   rU     s        o2 o2 o2b'$ '$4 '$E${:KSQ\M]:]4^ '$ '$ '$ '$R   X&=$ =$ =$ =$~@ @ @ @2@- @- @- @-D5- 5-# 5- 5-ERUW[]aRaLb 5- 5- 5- 5-n  B ". "5c? " " " \"H "" "" \""H 48IS8. 8. 8.c 8.&'EF8.X]8. 8. 8. \8.t >BLV	 	em3 	 	")*H"I	[`	 	 	 \	 C D    \  U]2 C    \ em&; 5=CX ]b]j]r    \8 (3 (8C= ( ( ( \( (" (" (" (" (" \("T # #e*    \" I  I C I 4 I E${BSUYZ]U^B^<_ I  I  I  \I V k!2 S DQ\L] "%25:=   \: =BS =BU4+<c4CTVY[^+^%_ =B =B =B \=B~ BF=B+.:>Je Je8D,=#> Je"Je6:Je%(Je %-T#Y$7Je DHJe Je Je JeX: : : :.2 2 2 2 2 2r   rU   c                       e Zd Zd Zddeee                  dee         fdZddeee                  fdZdd
+e	fdZ
+d ZdS )r  c                    d | _         d | _        d| _        d| _        d| _        d| _        d| _        d| _        d| _        d| _	        d| _
+        t                      | _        t          j        ddt                              |                                                    }|| _         t          j        d|t          j                  st          j        d|          rd| _        || _        d S 	 |}t          j        dd	|          }t          j        d
+d	|          }||k    rn6|                    d          dk    r!t          j        d|          }|sn|                                d                                         }t          j        dd|t          j                  }|                                D ]t}|                    d          }t          j        d|          rQ|                    d          }t/          |d                   | _        t/          |d                   | _        d| _
+        nt          j        d|t          j                  r$t/          |dd                    | _        d| _	        n|                                                    d          dk    rd| _        ne|                                                    d          dk    rd| _        n2|                                                    d          dk    rd| _        | j                            |           vt          j        dd|          }|                    d          dk    !|| _        d S )NFrY   Tz\s+rw   z^(Re|Aw|Fwd):z^\w{2,3}:\s*\[z\[([^]]*)\[([^\[\]]*)]z[\1\2]z\[([^]]*)]([^\[\]]*)]r  r   z^\[([^]]*)]z(patch)(v\d+)r  r    z,;z^\d{1,4}/\d{1,4}$r   z^v\d+$r  r   rm   z^\s*\[[^]]*]\s*rt   )rL   rj   r   r   rm   r  rb   r`   ra   r   r   rB   r  r   r   rU   r  r   r   r   r  r   r   r   
+IGNORECASEr   rJ   )rD   rj   oldsubjr   	bracketedrq  counterss          r   rE   zLoreSubject.__init__  s    
+
+!%!%&k&>&>w&G&GHHNNPP# 9%w55 	CTV]9^9^ 	DJ"DLF	Gf6	7KKGf5y'JJG'!!	 ll31$$i88G ((+1133I/9BDQQQI"** , ,D))91599 &${{3//H#&x{#3#3DL$'$4$4DM-2D**Yy%?? &$'abb	NNDM-2D**[[]]''..!33#DHH[[]]''11Q66"&DKK[[]]''00A55!%DJ$$U++++f/W==G7 ll31$$8 r   NexcluderT   c                    t                      }| j        D ]o}|r||v r	|                                dk    r"t          j        d|t          j                  rDt          j        d|          rZ|                    |           p|S )Nrm   zv\d+r    z\d+/\d+)rB   r  r   r   r   r   rJ   )rD   r
+  r  _prfs       r   get_extra_prefixeszLoreSubject.get_extra_prefixes,  s    ffM 		 		D 47??zz||w&&7D555 :t,, JJt
+r   	eprefixesc           	         |                                  }|r|D ]}||vr|                    |           | j        dk    r|                    d| j                    | j        dk    rc|                    t	          | j                                      t          t	          | j                                      d| j                   t          |          r#dd                    |          z   dz   | j	        z   S d| j	         S )NrY   r"   r   z[PATCH rw   r   z[PATCH] )
+r  rJ   rb   ra   rK   r`   zfillrx   rM   rj   )rD   r  _pfx_epfxs       r   get_rebuilt_subjectzLoreSubject.get_rebuilt_subject;  s   &&(( 	'" ' '$$KK&&&=1KK+DM++,,,=1KK3t|#4#4#:#:3s4=?Q?Q;R;R#S#S#S#SUYUbUbcdddt99 	-sxx~~-4t|CC,dl,,,r   r   Twith_counterc                     | j         }|rd| j        ||fz  }t          j        d||                              |                                          S )Nz%04d%s%sr   )rj   r`   r   r   r   r   )rD   sepr  r   s       r   r   zLoreSubject.get_slugK  sR     	>4<f"==Fvfc6**0055;;===r   c                 &   t                      }|                    d| j        z             |                    d| j        z             |                    d| j        z             |                    d| j        z             |                    d| j        z             |                    d| j        z             |                    d| j        z             |                    d| j	        z             |                    d	| j
+        z             |                    d
+| j        z             |                    d| j        z             |                    dd                    | j                  z             d                    |          S )Nz  full_subject: %sz  subject: %sz  reply: %sz  resend: %sz  patch: %sz	  rfc: %sr   z  revision_inferred: %sz  counter: %sr   z  counters_inferred: %sz  prefixes: %srJ  rH   )rB   rJ   rL   rj   r   r   rm   r  rb   r   r`   ra   r   rM   r  r  s     r   rR   zLoreSubject.__repr__Q  s\   ff
+
+'$*;;<<<
+
+?T\1222
+
+=4:-...
+
+>DK/000
+
+=4:-...
+
+;)***
+
+#dm3444
+
+,t/EEFFF
+
+?T\1222
+
+#dm3444
+
+,t/EEFFF
+
+#dii&>&>>???yy~~r   r?   )r   T)r   r   r   rE   r   r   rK   r  r  rm  r   rR   r   r   r   r  r    s        > > >@ (49*= c    - -Xd3i-@ - - - - > >d > > > >    r   r  c                   <   e Zd ZU ee         ed<   ee         ed<   ee         ed<   ee         ed<   ee         ed<   ee         ed<   eed<   eed<   eed	<   ddZ	e
+d
+efd            Ze
+d             Zdded
+efdZded
+efdZedee         fd            Zd ZdS )r  moder3  r  r  r&  r'  r1  r4  r  rT   Nc                     d | _         d | _        d | _        d | _        d | _        d | _        d| _        d| _        t                      | _	        d S NF)
+r  r3  r  r  r&  r'  r1  r4  rB   r  rC   s    r   rE   zLoreAttestor.__init__n  sI    	
+ffr   c                     t                      }|d         dk    r| j        rt          S t          S | j        rt          S t
+          S )Nr1   r2   )r   r1  ATT_PASS_FANCYATT_FAIL_FANCYATT_PASS_SIMPLEATT_FAIL_SIMPLEr  s     r   r  zLoreAttestor.checkmarky  sJ     ""*+w66| &%%!!< 	#""r   c                 j    | j         r| j         }n| j        }|d| j                                        S )Nr   )r'  r  r  r   )rD   r  s     r   r	  zLoreAttestor.trailer  s<    < 	<DD9D$$ 3 3 5 5 566r   r  r   c                     | j         r| j        dS t          j        |          }| j        |z
+  }||k    r| j                            d|z             dS t                              d|           dS )NFr"  z,Time drift between Date and t too great (%s)z)PASS : time drift between Date and t (%s)T)r1  r  r%  r)  r  rJ   r^   r_   )rD   emldater   maxdriftsdrifts        r   r2  zLoreAttestor.check_time_drift  s~    | 	t}45%7333(HKMPVVWWW5@&IIItr   emlfromc                 6   | j         r|sdS | j        dk    r|                                                    d| j                                        z             r#t
+                              d| j        |           dS | j                            d| j        d|           dS |                                | j                                        k    r#t
+                              d| j        |           dS | j                            d	| j        d|           dS )
+NFdomainr   z-PASS : sig domain %s matches from identity %sTzsigning domain z does not match From: z/PASS : sig identity %s matches from identity %szsigning identity )	r1  r3  r   r  r  r^   r_   r  rJ   )rD   r&  s     r   r  zLoreAttestor.check_identity  s   | 	7 	5:!!}}''dm.A.A.C.C(CDD Ldm]deeetKdmmm]d]defff5==??dm113333LLJDM[bccc4DMMM[b[bcdddur   r  c                     	 t           j                             t          |                                         t           j        j                  S #  t                              d|            Y nxY wd S )Nr  zFailed parsing t=%s)r%  utcfromtimestampr   r  r  r  r^   r_   )r  s    r   r  zLoreAttestor.parse_ts  sd    	4$55c"gg>>FFhN_NcFddd	4LL.33333ts   AA A0c                 x   t                      }|                    d| j        z             |                    d| j        z             |                    d| j        z             |                    d| j        z             |                    d| j        z             |                    d| j        z             |                    d| j        z             |                    d| j	        z             |                    d	d
+
+                    | j                  z             d
+                    |          S )Nz    mode: %sz   level: %szidentity: %szsigntime: %sz  keysrc: %sz keyalgo: %sz passing: %szhave_key: %sz  errors: %srC  rH   )rB   rJ   r  r3  r  r  r&  r'  r1  r4  rM   r  r  s     r   rR   zLoreAttestor.__repr__  s   ff
+
+>DI-...
+
+>DJ.///
+
+>DM1222
+
+>DM1222
+
+>DK/000
+
+>DL0111
+
+>DL0111
+
+>DM1222
+
+>CHHT[$9$99:::yy~~r   rl  )r  )r   r   r   r   rK   r   anyrm  rB   rE   r  r  r	  r   r2  r  r  r  rR   r   r   r   r  r  c  sj        
+3-C=smsmSMc]MMMNNNLLL	 	 	 	 3    X 7 7 X7  d    c d    " Xc]    \    r   r  c            
+       @     e Zd Zdededee         deddf
+ fdZ xZ	S )r  r1  r  r  r  rT   Nc                     t                                                       d| _        d| _        d| _        || _        || _        || _        |                    d          dk    r"|	                    d          d         | _
+        d S || _
+        d S )NDKIMr(  DNSr   r   rY   )superrE   r  r3  r&  r  r1  r  r  r   r  )rD   r1  r  r  r  	__class__s        r   rE   zLoreAttestorDKIM.__init__  s    	
+ ==""$NN3//2DMMM$DMMMr   
+r   r   r   rm  rK   r   r,  rB   rE   __classcell__r2  s   @r   r  r    sf        % % %x} %VZ %_c % % % % % % % % % %r   r  c                   H     e Zd Zdededee         dedededdf fd	Z xZ	S )
+r  r%  r  r  r&  r'  r  rT   Nc                    t                                                       d| _        d| _        || _        || _        || _        || _        || _        |t          j
+        k    rd| _        d| _        d S |t          j        k    r	d| _        d S d S )Nr  r  T)r1  rE   r  r3  r  r  r&  r'  r  r  r  r1  r4  
+RES_BADSIG)rD   r%  r  r  r&  r'  r  r2  s          r   rE   zLoreAttestorPatatt.__init__  s    	
+  V%%%DL DMMMv((( DMMM )(r   r3  r5  s   @r   r  r    sv        !t !s !hsm !UX !cf !!"&! ! ! ! ! ! ! ! ! !r   r  cmdargsrH  rundirrT   c                    |rCt                               d|           t          j                    }t          j        |           nd }t                               dd                    |           z             t          j        | t          j        t          j        t          j                  }|	                    |          \  }}|r/t                               d|           t          j        |           |j
+        ||fS )NzChanging dir to %sz
+Running %srw   )stdoutrH  stderr)inputzChanging back into %s)r^   r_   r  getcwdchdirrM   
+subprocessPopenPIPEcommunicate
+returncode)r9  rH  r:  curdirspoutputr   s          r   _run_commandrI    s     )6222
+
+LL 1 11222		'*/YcYh	i	i	iBnn5n11OVU ,f555
+=&%''r   argsc                     t                      }|d         dddg}|d         |d|d         gz  }|| z  }t          ||          S )Nr5   z--batchz--no-auto-key-retrievez--no-auto-check-trustdbr0   z	--homedirrG  )r   rI  )rJ  rH  r   r9  s       r   gpg_run_commandrL    s_    Fh,DF_`G%&2K(?!@AAtOGu----r   r  	logstderrra  c                 >   ddg}| rdt           j                            t           j                            | d                    r t           j                            | d          } |d| gz  }|d         dk    r|                    dd           ||z  }t          |||	          \  }}}	|r|                    d
+          }|rYt          |	                                          r8|r|	                    d
+          }	t          
+                    d|	           ||	z  }||fS )Ngitz
+--no-pager.gitz	--git-dirr   r!  rY   z--no-abbrev-commit)rH  r:  r  r:  z
+Stderr: %s)r  r  existsrM   r  rI  ra  rx   r   r^   r_   )
+r  rJ  rH  rM  ra  r:  r9  r  rN   errs
+             r   r  r   	  s%    l#G )7>>"',,vv6677 	2W\\&&11FK(( Aw%A+,,,tOG"7%GGGOE3 +jj	j** S%%  	/**I*..C\3'''s
+#:r   protocolhostusernamec                    d| d| d| d                                 }t          | ddg|          \  }}|dk    rM|                                D ]8}|                    d	          s|                    d
+d          }|d         c S d S )Nz	protocol=z
+host=z
+
+username=rH   
+credentialfill)rJ  rH  r   z	password=r^  rY   r  )rR  r  
+splitlinesr  r   )	r  rS  rT  rU  rH  r  rN   r6  r  s	            r   git_credential_fillrZ  	  s    FFFFF(FFFMMOOE |V.DERRRJE3zzNN$$ 	 	D??;// ZZaZ00F!94r   c                     t          | |          \  }}t                      }|r4|                    d          D ]}|dk    r	|                    |           |S )NrH   rt   )r  rB   r   rJ   )r  rJ  r  rN   r.  r6  s         r   r'  r'  )	  se     ..JE3FFE
+ IIdOO 	 	DrzzLLLr   	untrackedc                 X    ddg}|s|                     d           t          | |          S )Nstatusz--porcelain=v1z--untracked-files=no)rJ   r'  )r  r\  rJ  s      r   git_get_repo_statusr_  5	  s8    &'D ,*+++ ...r   c           	   #     K   d}	 t          j                    5 }dddd|g}|r|                    |           t          | |           t	          |          5  |V  ddd           n# 1 swxY w Y   ddd           n# 1 swxY w Y   |t          | ddd|g           dS dS # |t          | ddd|g           w w xY w)zContext manager that creates a temporary work tree and chdirs into it. The
+    worktree is deleted when the contex manager is closed. Taken from gj_tools.Nworktreer   z--detachz--no-checkoutr  z--force)tempfileTemporaryDirectoryrJ   r  in_directory)r  	commitishdfnr-  s       r   rM  rM  <	  sp      C
+L(** 	c!5*osKG *y)))FG,,,c""  			              	 	 	 	 	 	 	 	 	 	 	 	 	 	 	 ?FZ9c$JKKKKK ?3?FZ9c$JKKKK sR   B$ >A?A(A?(A,	,A?/A,	0A?3B$ ?BB$ BB$ $B=c              #     K   | mt                      }|r]t          j                            t          j                            |d                    r t          j                            |d          } | st
+                              d           dS t          j                    5 }ddd| |g}t          d|           |V  ddd           dS # 1 swxY w Y   dS )z6Context manager that creates a temporary shared clone.NrP  z6Current directory is not a git checkout. Try using -g.clonez--mirrorz--shared)
+git_get_toplevelr  r  isdirrM   r^   r{   rb  rc  r  )r  topdirrf  r-  s       r   git_temp_clonerl  N	  s      ~!## 	2bgmmBGLL$@$@AA 	2W\\&&11F PQQQt		$	&	& #J
+FC@g&&&			                 s   #CCCc              #      K   t          j                    }	 t          j        |            dV  t          j        |           dS # t          j        |           w xY w)zvContext manager that chdirs into a directory and restores the original
+    directory when closed. Taken from gj_tools.TN)r  r?  r@  )dirnamecdirs     r   rd  rd  `	  sT       9;;D
+
+
+
+
+s   A A--replace-allfullpathparamr   	operationc                 8    d|||g}t          | |          \  }}|S )Nr   r  )rq  rr  r   rs  rJ  r  rN   s          r   git_set_configrv  l	  s(    i.D 400JE3Lr   regexpdefaultsr  sourcec                 2   |t                      }dg}|r|d|gz  }|dd| gz  }t          d |          \  }}|}|st                      }|s|S |                    d          D ]}|s|                    dd          \  }	}
+	 |	                    d          }|d	                                         }||v r1||vrt                      ||<   ||                             |
+           n|
+||<   # t          $ r t                              d
+|           Y w xY w|S )Nr   z--filez-zz--get-regexp rH   rY   r  r  zIgnoring git config entry %s)	rB   r  r@   r   r   rJ   r   r^   r_   )rw  rx  r  ry  rJ  r  rN   	gitconfigr6  rO   r   r  cfgkeys                r   r  r  r	  sf   FF	:D #6""T>6**D t,,JE3I FF	 		&!! ? ? 	ZZa((
+U
+	?YYs^^FBZ%%''F""**(,If%&!((////$)	&! 	? 	? 	?LL7>>>>>	? s   A)C,,%DDc                     t           t          j        t                    } t	                      }g d}|r/t
+          j                            |d          }t          j        |t
+          j	                  rt                              d|           t          d|          }t                              d|           |                                D ]\  }}|                    d          r=t
+          j                            t
+          j                            ||                    }|D ]:}t!          j        ||          r#t                              d||           || |<    n;t          d| d	g
+          }|d                             d          |d<   |d                             d           |d                             d           |d         t          dddi          }	|	d         |d<   |a t           S )N)zsend-*z*maskz
+*template*ztrailer*zpw-*z
+.b4-configz Loading worktree configs from %szb4\..*)ry  zwtcfg=%sz./zwtcfg: %s=%sr  )rx  r  r(   rC  rx  r5   zgpg\..*programgpg)MAIN_CONFIGrd   re   DEFAULT_CONFIGri  r  r  rM   accessR_OKr^   r_   r  rI   r  abspathry  r   r  rJ   )
+defcfgrk  wtglobswtcfgwtconfigrO   valwtglobr   gpgcfgs
+             r   r   r   	  s   ~.. "##GGG 	"GLL66Ey(( "?GGG.yGGGZ222 ( 0 0 " "HC~~d++ I goobgll63.G.GHH") " ""?377 ""LLcBBB*-F3K!E" %YL>ZZZ&,-@&A&G&G&L&L"#"#**3///"#**3///(#(i5GHHF%i0F8r   appnamec                 n   dt           j        v rt           j        d         }nJt           j                            t	          t
+          j                                                  dd          }t           j                            ||           }t          j        |                              dd           |S )NXDG_DATA_HOMEz.localshareTparentsexist_ok)	r  environr  rM   rK   pathlibr   homemkdir)r  datahomedatadirs      r   r  r  	  s    "*$$:o.7<<GL$5$5$7$7 8 8(GLLgll8W--GLt<<<Nr   c                    dt           j        v rt           j        d         }nIt           j                            t	          t
+          j                                                  d          }t           j                            ||           }t          j        |                              dd           t          r|S t                      }	 t          |d                   dz  }n3# t          $ r& t                              d|d                    d}Y nw xY wt          j                    |z
+  }t          j        |          D ]}|                    d	          d
+k    r3|                    d          d
+k    r|                    d          d
+k    rOt           j                            ||          }t          j        |          }|j        |k     rt                              d|           t           j                            |          rt-          j        |           t          j        t           j                            ||                     da	|S )NXDG_CACHE_HOMEz.cacheTr  r3   <   z4ERROR: cache-expire must be an integer (minutes): %siX  z.mbxr   z.lookupz.msgszCleaning up cache: %s)r  r  r  rM   rK   r  r   r  r  _CACHE_CLEANEDr   r   r   r^   r{   timelistdirr  statst_mtimer_   rj  shutilrmtreeunlink)	r  	cachehomecachedirr   expminexpageentryrq  sts	            r   get_cache_dirr  	  s   2:%%J/0		GLLW\%6%6%8%8!9!98DD	w||Iw//HL   ===  FVN+,,r1   NPVWePfggg Y[[6!FH%% 
+9 
+9::f""uzz)'<'<'A'AejjQXFYFY]^F^F^7<<%00WX;LL0%888w}}X&& 9h''''	"',,x77888NOs   C% %-DD
+identifierr?  c                     t                      }t          j        |                                                                           }|r| d| }t
+          j                            ||          S )Nr  )r  r  r  rR  r  r  r  rM   )r  r?  r  	cachefiles       r   get_cache_filer  	  sc    HZ..0011;;==I , ++6++	7<<),,,r   c                 0   t          | |          }	 t          |          5 }t                              d||            |                                cd d d            S # 1 swxY w Y   n+# t
+          $ r t                              d|            Y nw xY wd S )Nr>  zUsing cache %s for %szCache miss for %s)r  rd  r^   r_   readFileNotFoundError)r  r?  rq  ri  s       r   rK  rK  	  s    j888H6(^^ 	rLL0(JGGG7799	 	 	 	 	 	 	 	 	 	 	 	 	 	 	 	 	  6 6 6(*5555564s4   A+ 0AA+ A##A+ &A#'A+ +%BBc                     t          | |          }t          j                            |          r2t          j        |           t
+                              d||            d S d S )Nr>  zRemoved cache %s for %s)r  r  r  rQ  r  r^   r_   )r  r?  rq  s      r   rL  rL  	  sd    j888H	w~~h F
+	(.*EEEEEF Fr   wcontentsr  c                 8   t          ||          }	 t          ||          5 }|                    |            t                              d||           d d d            d S # 1 swxY w Y   d S # t
+          $ r  t                              d||           Y d S w xY w)Nr>  zSaved cache %s for %szCould not write cache %s for %s)r  rd  re  r^   r_   r  )r  r  r?  r  rq  ri  s         r   rT  rT  	  s   j888HN(D!! 	HRHHXLL0(JGGG	H 	H 	H 	H 	H 	H 	H 	H 	H 	H 	H 	H 	H 	H 	H 	H 	H 	H  N N N6*MMMMMMNs4   A/ 2A"A/ "A&&A/ )A&*A/ /&BBc                      t           Lt          d          a dt           vr4t          j        t	          j                              } | j        t           d<   t           S )Nzuser\..*r   )USER_CONFIGr  pwdgetpwuidr  getuidpw_gecos)udatas    r   r   r   
+  sG    )+66$$L--E"'.Kr   c                      t           <t          j                    a t           j                            ddt
+          z  i           t           S )N
+User-Agentb4/%s)
+REQSESSIONrequestssessionrc  r  __VERSION__r   r   r   get_requests_sessionr  
+  s=    %''
+!!<;1F"GHHHr   c                      t           j                                        s\ddlm}   |                                 t           j        j                                        d          }|                    dd           S d S )Nr   )BytesParserT)headersonly
+Message-ID)	r   rH  isattyemail.parserr  
+parsebytesbufferr  r   )r  r   s     r   get_msgid_from_stdinr  
+  sy    9 /,,,,,,+--**I!!## + 7 7{{<...4r   c                    | j         s0| j        s)t                              d           t	                      }n| j         }|d S |                    d          }t          j        d|t          j                  }|rUt                              d           |	                                }t          j                            |d                   }|S t          j        d|t          j                  }|r|	                                }t                      }t          j                            |d                   }t          j                            |          }|j        |j        k    r8t                              d           |j         d	|j         d
+|d          d|d<   t          j                            |d                   }|                    d          dk    rt          j        dd|          }|S )NzGetting Message-ID from stdinru   z+^https?://.*/project/.*/patch/([^/]+@[^/]+)zLooks like a patchwork URLr   z%^https?://[^/]+/([^/]+)/([^/]+@[^/]+)r%   z-Overriding midmask with passed url parametersr  r   z/%srY   zid:z^\w*id:rt   )rS   no_stdinr^   r_   r  r   r   r   r  r   urllibparseunquoter   urlparsenetlocschemer  r   )r9  rS   r   r  r   mylocwantlocs          r   	get_msgidr  #
+  s   = !1 4555$&&}tKKE iFr}]]G 1222!!$$VAY// i@%WWG 0!! ""%%fY&788,''..<7>))LLHIII#*> U Ugn U Uvay U U UF9$$VAY//zz%Az2u--Lr   c           	         |h}t                      }t                      }t                      }t                      }t                      }	 | D ]}	t                              |	          }
+|
+|v r"|                    |
+           |
+|v r<t                              d|
+           t                      }t                      }|	                    dd           r@|t          j
+                            d |	                    dg           D                       z  }|	                    dd           r@|t          j
+                            d |	                    dg           D                       z  }|rH||
+k    rBt                              d	|           t          d
+ |D                       }t                      }t          d |D                       D ]}||v r||v s||v r|                    |
+           %t          |          re|                    |           |
+|vrL||vrt                      ||<   t                              d||
+           ||                             |
+           |
+|v r|                    |	           |                    |
+           |                    |           |                    |
+           t                              d|
+           |
+|v r0|                    ||
+                    |                    |
+           |D ]6}||v r0|                    ||                    |                    |           7t          |          D ]}
+|
+|vs|
+|v r|                    |
+            t          |          snAt          |          sd S t          |           t          |          k    r6t                              dt          |           t          |                     |S )NTr   r  c                 ,    g | ]}t          |          S r   r   r   s     r   r   z%get_strict_thread.<locals>.<listcomp>]
+  s    4d4d4dSVV4d4d4dr   zin-reply-tors   c                 ,    g | ]}t          |          S r   r   r   s     r   r   z%get_strict_thread.<locals>.<listcomp>_
+  s    4c4c4cSVV4c4c4cr   
+referencesz'Breaking thread to remove parents of %sc                     g | ]
+}|d          S r  r   r   s     r   r   z%get_strict_thread.<locals>.<listcomp>d
+  s    444qad444r   c                     g | ]
+}|d          S r  r   r   s     r   r   z%get_strict_thread.<locals>.<listcomp>g
+  s    222QAaD222r   zGoing into maybe: %s->%szKept in thread: %sz1Reduced thread to requested matches only (%s->%s))r   r@   rB   rU   r   r   r^   r_   r   r   r   r   r   rc   rx   rJ   r  discardr  r  )r  rS   noparentwantignoregotseenmaybestrictr   c_msgidr   msgrefsr   s                 r   get_strict_threadr  I
+  s   7DUUF
+%%C55DFFEVVF9 1	' 1	'C!11#66G&  HHW#~~LL)733355DffGww}d++ f5;334d4dS[[Q^`bEcEc4d4d4deeeww|T** e5;334c4cS[[Q]_aEbEb4c4c4cddd  !EW,,EuMMM44G44455&&22'22233 0 0&==#::HHW%%%%XX 0HHSMMMd**e++),E#J%?gNNNc
+w///$c"""   D!!!W%%%17;;;e##KKg///IIg&&& ' 'Ce||E#J///		# 4yy 	% 	%Gd""gnnG$$$4yy 	s9v v;; t
+4yy3v;;H#d))UXY_U`U`aaaMr   bmboxoutdirpipesepc                 b   t                      }|rt                              d|           d|v r,dd l}|                    |                                d          }|                     |                                          D ]D}|                                r.|                    t          j
+        |t                               E|S t                              d|           ddd	|z  g}t          d || 
+          \  }}|dk    rt                              d           |S t          j        |          D ]v}	t!          t          j                            ||	          d          5 }
+|                    t          j        |
+t                               d d d            n# 1 swxY w Y   w|S )NzMailsplitting using pipesep=%s\r   unicode_escaperD  zMailsplitting the mbox into %s	mailsplitz--mboxrdz-o%srG  z-Unable to parse mbox received from the serverrb)rB   r^   r_   codecsra  rR  r   r   rJ   r   message_from_bytesrQ  r  r{   r  r  rd  r  rM   message_from_binary_file)r  r  r  r  r  rq  rJ  r  rN   r   ri  s              r   mailsplit_bytesr  
+  s   66D 5w???7??MMMmmGNN$4$46FGGG[[!1!122 	O 	OE{{}} OE4U9MMMNNN
+LL16:::Vf_5D t5999JE3qyyGHHHz&!! N N"',,vs++T22 	NbKK6r)LLLMMM	N 	N 	N 	N 	N 	N 	N 	N 	N 	N 	N 	N 	N 	N 	NKs   (/F##F'	*F'	querynocachec                    t                      }|                    d          }|st                              d           d S t	                      }t
+          j                            |           } || z  }t          |d          }t          j
+                            |          r|st                              d|           t          j        |          D ]z}t          t          j
+                            ||          d          5 }|                    t#          j        |t&                               |cd d d            c S # 1 swxY w Y   {t
+          j                            |          }	t                              d|	j                   t/                      }
+|
+                    |d	          }|j        d
+k    rt                              d           d S |j        dk    r"t                              d|j                   d S t5          j        |j                  }|                                 t=          |          st                              d           d S t?          ||          S )Nr'   zb4.searchmask is not definedpi.msgsUsing cached copy: %sr  rD  zGrabbing search results from %srt   )data  zNothing matching that query.   Server returned an error: %s No messages found for that queryr  ) r   r   r^   r{   rB   r  r  
+quote_plusr  r  r  rQ  r_   r  rd  rM   rJ   r   r  rQ  r  rc   r  r  poststatus_codegzip
+decompresscontentrS  rx   split_and_dedupe_pi_results)r  r  r   r'   r  	query_urlr  r   ri  locr  respt_mboxs                r   get_pi_search_resultsr  
+  sa   FL))J 6777t66DL##E**EU"Ii33H	w~~h  ,h777:h'' 	 	Cbgll8S11488 BE:2iPPPQQQ                   ,
+
+	
+*
+*C
+KK13:>>>"$$G<<	<++D32333t32D4DEEEt_T\**FJJLLLv;; :;;;t&vAAAAs   0EE	
+E	r  r  c                 L   t          j        d          5 }t          | |          }d d d            n# 1 swxY w Y   t                      }|D ]J}t                              |          }||v r%t                              ||         |          ||<   E|||<   Kt          |                                          }|rt          j
+                            |          rt          j        |           t          j        |                              dd           t#          |          D ]|\  }}t%          t          j
+                            |d|z            d          5 }|                    |                    t,                               d d d            n# 1 swxY w Y   }|S )Nz
+-mailsplitr>  Tr  z%04dr`  rD  )rb  rc  r  r@   rU   r   r  rB   valuesr  r  rQ  r  r  r  r   r  	enumeraterd  rM   re  r  rQ  )	r  r  tfdr  dedupedr   rS   rp   ri  s	            r   r  r  
+  s   		$L	9	9	9 ,Svs++, , , , , , , , , , , , , , , ffG  ++C00G(@@QTUUGEN  !!D 97>>(## 	$M(###X$$TD$AAA  	9 	9GBbgll8Vb[994@@ 9BY778889 9 9 9 9 9 9 9 9 9 9 9 9 9 9 Ks   377/FF	F		t_mbx_urlc                    t                      }t          | d          }t          j                            |          r|st
+                              d|           t          j        |          D ]v}t          t          j        	                    ||          d          5 }|
+                    t          j        |t                               d d d            n# 1 swxY w Y   w|S t
+                              d|                     d          d                    t!                      }|                    |           }|j        dk    rt
+                              d	           d S |j        d
+k    r"t
+                              d|j                   d S t'          j        |j                  }|                                 t/          |          st
+                              d           d S t1          ||          S )Nr  r  r  rD  zGrabbing thread from %sr  rY   r  That message-id is not known.r  r  r   r  )rB   r  r  r  rQ  r^   r_   r  rd  rM   rJ   r   r  rQ  r{   r   r  r   r  r  r  r  rS  rx   r  )	r  r  r  r  r   ri  r  r  r  s	            r   get_pi_thread_by_urlr  
+  s   66Di33H	w~~h  ,h777:h'' 	R 	RCbgll8S11488 RBE:2iPPPQQQR R R R R R R R R R R R R R R
+OO-yu/E/Ea/HIII"$$G;;y!!D37888t368HIIIt_T\**FJJLLLv;; :;;;t&vAAAAs   /CC	!C	rS   
+onlymsgidsc                 r   t           j                            | d          }t                      }t           j                            |d                   }|j                            d          r|j        d|j        d}n|d         |z  }t          
+                    d|           t                      }|                    |          }	|	j        dk     s|	j        d	k    rt                              d
+           d S |	j        d                             d                              d          }
+d                    |
+d d                   }|	                                 |d|d}t                              d|           t+          ||          }|sd S |rt-                      }|D ]z}t.                              |          |v r|                    |           |D ]D}|                    dd                              |          dk    r|                    |           E{nt9          ||           }|S )Nr   )safer%   z/all/r  z/allzLooking up %si,  i  r  Locationr   r  z
+/t.mbox.gzzt_mbx_url=%s)r  r  rt   r   )r  r  r  r   r  r  r  r  r  r^   rc   r  headr  r{   rc  r  r   rM   rS  r_   r  rB   rU   r   rJ   r   r  r  )rS   r  r  qmsgidr   r
+  projurlr%   r  r  r  r  r  r  r   	onlymsgids                   r   get_pi_thread_by_msgidr    s.   \$$U$55FF
+,
+
+y 1
+2
+2C
+ x7## #&:::szzz: #f,OW---&((||G$$c!!T%5%;%;OO;<<<4j)0055;;C@@((6#2#;''
+
+%,WWfff5I
+LL+++	7;;;D t 
+0 	' 	'C**3//:==c"""' ' '	77<,,11)<<AAMM#&&&'		' #4//Mr   rY   startendr  rb   	msgid_tptseriestsmailfrom	extrahdrsignore_commitsc
+           	         t          | dd| d| g          }
+|
+st          d| d|           |	t                      }	t                      }|
+D ]}||	v rt                              d|           "t          | dddd	|gd
+          \  }}|dk    rt          d|           t          j        |t                    }|
+                    ||f           t          |          }|dk    rt          d| d|           t          d dg          }t          |          dk    r!|d                                         d         }nd }t          |          }t          |          D ]\  }\  }}|                    d           t                              |                    d                    }t%          |                    d                    }|dz   |_        ||_        ||_        |                    |          }t                              d|           |                    d|           t                      }|}|rYt          j                            |          }|d         |d         k    r(t5          |g          }|
+                    d|            |                    d|           |r||z   dz   }|                    d          }|r6|                    dt          j                            |d                     n5|                    dt          j                            |d                     |                    d          }t=          |t>                    rl|                                 }|rd!                    |          dz   |z   }|r"|"                    d          dk    s	|d| dz  }|#                    |d           |t                      }|D ]B\  }}	 |                    ||           # tH          $ r |                    ||           Y ?w xY w|r+|                    d|tK          |j                  z             |S ) Nzrev-listz	--reversez..zCould not run rev-list zIgnoring commit %sshowz--format=emailz--patch-with-statz--encoding=utf-8Fr9  r   zCould not get a patch out of rD  z	--versionrY   r  r   r  r  )r  rG   r  r  T)	localtimerH   r  r  r   rr  )&r'  RuntimeErrorr   rB   r^   r_   r  r   r  rQ  rJ   rx   r   r  r  rU   r  r   r  r`   ra   rb   r  replace_headerr   r  r  
+formatdater  r  
+isinstancer  ra  rM   r  r  r   rK   ) r  r   r!  r  rb   r"  r#  r$  r%  r&  commitsr\   r/  r  rN   r   	fullcountvlinesgitverra   r`   origfromr   rj   
+inbodyhdrssetfromorigpairpatchtsorigdaterD  hdrnamerN  s                                    r   git_range_to_patchesr9  6  s    $FZFWFWRUFWFW,XYYG ECUCCcCCDDD ffG 	& 	&^##LL-v666$Vf6FH[]o.4.6>CE E E
+s199GvGGHHH&s9===}%%%%GIA~~CUCCcCCDDD"4+77F
+6{{a""2&7||H"+G"4"4 1L 1L&#   ++CGGFOO<<swwy1122"Q;$$...BBVW%%%9g...VV
+ 	7{,,X66H{hqk))&z22!!"58"5"566667+++ 	X(1,GwwvH X""65;+A+A'UY+A+Z+Z[[[[vu{'='=gQU'='V'VWWW///..gu%% 	6nn&&G C))J//&87B 0gll95599/V////OOGWO555I( 	0 	0OGV0""7F3333 0 0 0w/////0  	LNN<S9I5J5J)JKKKNs   .P P('P(c                 >    dd|g}t          | |          \  }}|dk    S )Nr@  rA  r   ru  )r  	commit_idr-  r  rN   s        r   git_commit_existsr<    s+    4+G 11JE3A:r   c                 2    ddd|g}t          | |          }|S )Nbranchz--format=%(refname:short)z
+--contains)r'  )r  r;  r-  r.  s       r   git_branch_containsr?    s%    4lING!&'22ELr   r  c                 h    d }ddg}t          | |          }t          |          dk    r|d         }|S )NrB  z--show-toplevelrY   r   )r'  rx   )r  rk  r-  r.  s       r   ri  ri    s>    F-.G!$00E
+5zzQqMr   c                    t                      }| D ]+}|d         |d         k    r|                    |d                    1|r(t                              |d                   |d         f}|d                             d          s|d                             d          sht
+                              |d                   rHt          j        	                    |d                   }|                    d| d|d          d           |                    t          j        
+                    |                     -d                    |          S )Nr   rY   rG  rH  rI  r  rJ  )rB   rJ   rU   r  r  	qspecialsr   r   r   quoterK  rM   )pairsrZ  addrsr  quoteds        r   r  r    s;   FFE 3 37d1gLLa!!! 	@,,T!W55tAw?DAw!!$'' 	Q0B0B30G0G 	IL\L\]abc]dLeLe 	[&&tAw//FLL2V22Q222333U[++D11222299Ur      c                 &   t                               |           \  }}}}}t          |          sdS t          j        dd|t          j                  }t                      }d}|                    d          D ]}	||k    rMt          |	                                          s,|	                    d           |	                    d            n0|	                    d	|	
+                                z             |d
+z  }d                    |          S )Nz> 
+z!^(hi|hello|greetings|dear)\W.*\n+rt   r    r   rH   z> z> [...]z> %srY   )rU   r  rx   r   r   r   rB   r   r   rJ   r  rM   )
+r   maxlinesrc  r   r   r  r  
+quotelinesqcountr6  s
+             r   
+make_quoterL    s   6A6P6PQU6V6V3GWh)w<< vf92wbdSSSGJFd##  HS%6%6d###i(((E&4;;==0111!99Z   r   c           	   #     K   t          j        dd|           } |                     d          D ]}|                                rt	          |          V  )|                    d          dk    r[t          |          dk    rH|dd                                          r,t          dt	          |dd                              E d {V  |                    d          dk    r|                    d          }|d                                         r[|d                                         rAt          t	          |d                   t	          |d                   dz             E d {V  @t          |d                   sH|d                                         r.|r,t          t	          |d                   |dz             E d {V  t          	                    d|           d S )	Nz\srt   rC  r  r   rY   rF  z!Unknown range value specified: %s)
+r   r   r   isdigitr   r  rx   ranger^   r{   )intrangeuppernnrs       r   parse_int_rangerT    s     veR**H^^C   D D99;; 	Da&&LLLLVVC[[A#a&&1**122*QAabbE
+
+++++++++++VVC[[1__B!u}} 62a5==?? 6 RUSAZZ\::::::::::AZZ 6BqEMMOO 6 6 RUU1W555555555OO?CCCCD Dr   r^  c                    d}d}d}d }d }t          j        d| t           j                  }|r!|                                d         }|||||fS t          j        d| t           j                  }|rd}|                                d         }t          j        d| t           j                  }|rd}|                                d         }t          j        d	| t           j                  }	|	rd}|||||fS )
+NFz$^\[GNUPG:] BADSIG ([\dA-F]+)\s+(.*)$r    r   z%^\[GNUPG:] GOODSIG ([\dA-F]+)\s+(.*)$Tz8^\[GNUPG:] VALIDSIG ([\dA-F]+) (\d{4}-\d{2}-\d{2}) (\d+)r  z!^\[GNUPG:] TRUST_(FULLY|ULTIMATE))r   r   r   r   )
+r^  goodvalidtrustedkeyidr  
+bs_matches
+gs_matches
+vs_matches
+ts_matchess
+             r   check_gpg_statusr^    s   DEGEH BFRTRVWWWJ 5!!##A&UGUH44CVSUSWXXXJ '!!##A&VX^fhfjkkkJ *$$&&q)?rtTTTJ 00r   rY  c                 n   dd| g}t          |          \  }}}|dk    rt          d| z            |                                }t                      }|                    d          D ]L}|d d         dk    r|                    d          }|d	         d
+v r1|                    |d                    M|S )Nz--with-colonsz--list-keysr   z'Unable to get UIDs list matching key %srH      zuid:r  rY   )r	   )rL  r   ra  rB   r   rJ   )	rY  gpgargsr  rN   rR  keyinfor)  r6  r  s	            r   r  r    s    u5G%g..OE3qyy@5HIIIjjllG66Dd##  8vC!9F1IKr   r  destc                     | D ]F}|                     d           |                     t                              |d                     Gd S )Ns$   From git@z Thu Jan  1 00:00:00 1970
+ra  rb  )re  rU   rf  )r  re  r   s      r   save_git_am_mboxrg    s\      H H
+
+;<<<
+
+;//X/FFGGGGH Hr   r  c                     t           j                            ||t                    }| D ],}|                    d           |                    |           -d S )N)mangle_from_rE  s'   From mboxrd@z Thu Jan  1 00:00:00 1970
+)r   	generatorBytesGeneratorrQ  re  flatten)r  re  r  genr   s        r   r  r    s`    
+/
+(
+(KPY
+(
+Z
+ZC  
+
+>???C r   c           	      <   t           j                            |d          }t          j        |                              d           t           j                            |d          }t          j        |                              d           t           j                            |d          }t          j        |                              d           | D ]?}t          |                    dd                    }d|j        t          j
+        d	d
+|j                                      d
+                                          fz  }t          t           j                            || d          d          5 }|                    t                               |d                     d d d            n# 1 swxY w Y   t          j        t           j                            || d          t           j                            || d                     Ad S )NnewT)r  curtmprj   rt   z%04d_%sr   r   z.emlr`  ra  rb  )r  r  rM   r  r   r  r  r   r`   r   r   rj   r   r   rd  re  rU   rf  rename)	r  re  d_newd_curd_tmpr   lsubjr   mfhs	            r   save_maildirrx  "  s   GLLu%%ELd+++GLLu%%ELd+++GLLu%%ELd+++ Z ZCGGIr2233EM26&#u}+M+M+S+STW+X+X+^+^+`+`aa"',,ummm44d;; 	KsIIk2232IIJJJ	K 	K 	K 	K 	K 	K 	K 	K 	K 	K 	K 	K 	K 	K 	K
+	"',,ummm44bgll5T---6X6XYYYYZ Zs   <0F88F<	?F<	bmsgr  c                 r   t          j                    5 }t          j                            |d          }t          j                            |d          }|rddd||g}nddd||g}t          d ||           \  }}t          |                                          st          d          t                      }d}	d}
+|
+                    d	          D ]}|                                }|s|
+                    d
+d          }|d                                         ||d         <   t          |d          5 }|                                }	d d d            n# 1 swxY w Y   t          |d          5 }|                                }
+d d d            n# 1 swxY w Y   	 d d d            n# 1 swxY w Y   ||	|
+fS )Nr
+  r  mailinfoz--encoding=UTF-8z
+--scissorsz--no-scissorszCould not get mailinfor   rH   r  rY   r   r  )rb  rc  r  r  rM   r  rx   r   r   r@   r   rd  r  )ry  r  r  m_outp_outr9  r  rc   r  r
+  r  r6  r  rw  pfhs                  r   r  r  2  s[   		$	&	& #S#&&S#&& 	V!#5|UERGG!#5uUG%dGT::t4::<<   	75666FFJJt$$ 
+	 
+	D::<<D ZZa((F!!9??,,AfQiLeT"" cHHJJ              eT"" cHHJJ              
+	              4 a7NsZ   DF)3EF)EF)EF)/FF)FF)FF))F-0F-c                    d}|                      d          dk    rt          j                            |           } |                      d          dk    rt          j                            |           } t          | dd          5 }|D ]#}t          |          r|d         dk    r||z  }$	 d d d            n# 1 swxY w Y   |S )	Nrt   ~r   $ra  r   encodingr  )r  r  r  
+expanduser
+expandvarsrd  rx   )tptfiletptri  r6  s       r   read_templater  P  s	   
+C||CA'$$W--||CA'$$W--	gsW	-	-	-  	 	D4yy T!W^^4KCC	              
+ Js   'B99B= B=c                  J   t           t                      } |                     d          }t          d          }|rAt          d| d|          }d| }t	          |          st          j        d|z            n|}d}t                              d	|           |a t           S )
+Nr6   zsendemail\.[^.]+$zsendemail\.z\..*)rx  z
+sendemail.z7Unable to find %s settings in any applicable git config	sendemailzUsing values from %s)	SENDEMAIL_CONFIGr   r   r  rx   smtplibSMTPExceptionr^   r_   )r   r  _basecfgsconfigsectnames        r   get_sendemail_configr  _  s     ""::233&';<< 	#)*G*G*G*GRZ[[[G.H..Hw<< r+,ehp,pqqqr G"H+X666"r   dryrunc                    t                      }|                    d          }t          d|           |s)t          d|d           t                      }|d         }|                    dd          }|                    dd          }	 t	          |          }n"# t
+          $ r t          j        d	          w xY wd
+|v rt          j	        
+                    t          j	                            |                    }t          j        |d          }d|_        t          |          }d|vr|                    d           |                    d          }|r|dk    r t           j                            |          }	nt           j                            |          }	|	dk    r|dgz  }||fS |                    d          }
+| rd |fS t&                              d||           |
+r|
+dv rRt          j        ||          }|                                 |                                 |                                 n1|
+dv rt          j        ||          }nt          j        d|
+z            |                    d          }|                    d          }|r8|s6|r| d| }n|}t3          d d||          }|st          j        d|          |r|r|                    ||           nt          j        ||          }||fS )Nr   z	fromaddr=z 2r   
+smtpserver	localhostsmtpserverportr   z Invalid smtpport entry in configr   T)posixz-ienvelopesenderauto)rt   rt   fsmtpencryptionzConnecting to %s:%s)tlsstarttls)sslsmtpsz)Unclear what to do with smtpencryption=%ssmtpusersmtppassr  smtp)rS  rT  rU  z*No password specified for connecting to %s)r  r   printr   r   r   r  r  r  r  r  r  shlexwhitespace_splitrB   rJ   r   r   r  r^   rc   SMTPehlor  SMTP_SSLrZ  login)r  r  fromaddrr   serverportrG  r  
+env_senderenvpair
+encryptionauserapassgchosts                 r   get_smtpr  u  sJ   "$$G{{6""H	.X.. $!##7#[[{33F;;'++DH4yy H H H#$FGGGH f}}##BG$6$6v$>$>??[t,,,"BxxtKK [[!122
+ 	8Z611k++H55GGk++J77G hSEMDX~-..J X~
+KK%vt444 !*,,,<--DIIKKKMMOOOIIKKKK+++#FD11DD'(SV`(`aaa J''J'' 	b 	b  "++T++'vFUZ[[[E b+,XZ`aaa 	%U 	%JJue$$$ |FD))>s   B B=pwkeypwurlc                    t          j                    }|j                            dt          z  d|  d           d                    |                    d          dt          f          }t          	                    d|           ||fS )Nr  zToken )r  Authorizationr   apiz	pw url=%s)
+r  r  rc  r  r  rM   r  PW_REST_API_VERSIONr^   r_   )r  r  r  urls       r   get_patchwork_sessionr    s      GO+)%))     ((ELL%%u.AB
+C
+CC
+LLc"""C<r   msgidsstatec                 r   t                      }|                    d          }|                    d          }|                    d          }|r|r|st                              d           dS t	          ||          \  }}d                    |df          }t                      }	t                      }
+| D ]}||
+v rd|fd	d
+|fg}	 t                              d|           |                    ||d          }|                                 |	                                }|D ]s}|                    d          }|rZ|                    d          }|                    d          |k    r,|
+
+                    |           |	                    ||f           t# t          j        j        $ r&}t                              d|           Y d }~d }~ww xY w|	rYt                              d           t           j                            |          }t                              d|j        |           |	D ]\  }}d                    |t)          |          df          }t                              d|           d|fg}	 |                    ||d          }|                                 |	                                }|                    d          |k    rt                              d||           # t          j        j        $ r%}t                              d|           Y d }~d }~ww xY wd S d S )Nzpw-keyzpw-urlz
+pw-projectzAPatchwork support requires pw-key, pw-url and pw-project settingsFr   r\   project)archivedfalserS   zlooking up patch_id of msgid=%s)paramsstreamidr   r  zPatchwork REST error: %sr   z!Patchwork: setting state on %s/%srt   zpatchid_url=%s)r  r  z -> %s : %s)r   r   r^   r_   r  rM   rB   r   raise_for_statusjsonr   rJ   r  
+exceptionsRequestExceptionrc   r  r  r  r  rK   rm   )r  r  r   r  r  pwprojpsesr  patches_urltochanger  rS   r  rsppdatar  patch_idtitler  r
+  patchid_urlr  newdatas                          r   patchwork_set_stater    sZ   FJJx  EJJx  EZZ%%F e  XYYYu%eU33ID#((C+,,KvvH55D 9 9D== !e
+
+	9LL:EBBB((;ve(DDC  """HHJJE ; ; 99T?? ;!IIf--Eyy))U22 5(9:::; "3 	9 	9 	9LL3R88888888	9  =El##E**7VLLL' 	= 	=OHe((KX#CDDKLL);777% D=jj4jFF$$&&&((**;;w''500KKue<<<&7 = = =7<<<<<<<<=!= =	= 	=s2   
+CFG0GGA5K99L2L--L2r  r  	destaddrspatatt_sign
+output_dirweb_endpointreflectc	           	         t                      }	|d}|D ]}
+|
+                    d          s|
+                    ddt                      |
+                    d           |s|rd}nd}t
+                              |
+|d          }|
+                    d	d
+          }t          |          }|rdd l}	  |j	        |          }n# |j
+        $ ro}t                              d           t                              d           t                              d           t          t          |                    d }~w|j        $ r$}t          dt          |          z            d }~ww xY w|r |rd|                    d          z  }t                              d|           t$          j                            ||          }t+          |d          5 }|                    |           d d d            n# 1 swxY w Y   t                              d           t                              d|                                                                                    dd          z              t                              d           y|st4          j                            d |
+                    dg           D                       }|t4          j                            d |
+                    dg           D                       z  }d |D             }n|}|	                    |||f           !t?          |	          sdS t                              d           |r0|rt                              d |           d!}nt                              d"|           d#}|d$ |	D             d%}tA                      }|!                    ||&          }	 |"                                }|                    d'          d(k    rt?          |	          S n8# tF          $ r+}t                              d)|j$                   Y d }~dS d }~ww xY w|                    d'          d*k    r0t                              d+|                    d,                     dS d}t4          j        %                    |          }d
+}tM          | t                     r%|r/t                              d-d.                    |                      n.t                              d/d.                    |                      |	D ]\  }}}t                              d|j'                   |j'        }|rt          |           |d0         gz   }nt          |           t          |          z   }tQ          ||1          \  } }!}"| dk    r:t          d2d.                    |           d3|"                                          |d0z  }n| r|	D ]\  }}}tS          j*        d4d5|          }t                              d|j'                   |j'        }|r| +                    ||d0         g|           n| +                    |||           |d0z  }||fS )6NTzX-Mailerzb4 r   rH   r  rR  )rW  rc  r  rt   r   z*CRITICAL: Error signing: no key configuredzG          Run "patatt genkey" or configure "user.signingKey" to use PGPz0          As a last resort, rerun with --no-signz!Failure trying to patatt-sign: %sz%s.emlrF  )r  rG   r`  z#    --- DRYRUN: message follows ---z    | z
+    | z     --- DRYRUN: message ends ---c                 ,    g | ]}t          |          S r   r   r   s     r   r   zsend_mail.<locals>.<listcomp>@  s    0W0W0WAQ0W0W0Wr   r  c                 ,    g | ]}t          |          S r   r   r   s     r   r   zsend_mail.<locals>.<listcomp>A  s    1X1X1XQ#a&&1X1X1Xr   r  c                     h | ]
+}|d          S r  r   r   s     r   r  zsend_mail.<locals>.<setcomp>B  s    ...qt...r   )r   r   r   zReflecting via web endpoint %sr  zSending via web endpoint %sreceivec                 B    g | ]}|d                                           S r  r9  r   s     r   r   zsend_mail.<locals>.<listcomp>U  s$    77711777r   )actionmessages)r  r%  r"  z"Odd response from the endpoint: %sr   zError from endpoint: %sr   zReflecting via "%s"rw   zSending via "%s"rY   rG  zError running r  s   \r\n|\n|\r(?!\n)r  ),rB   r   r  r  r  rU   rf  r  r  rfc2822_sign
+NoKeyErrorr^   r{   r*  rK   SigningErrorr   rc   r  r  rM   rd  re  ra  r  r  r   r   r   r   rJ   rx   r  r  r  r  textr  r-  rL   rI  r   r   sendmail)#r  r  r  r  r  r  r  r  r  tosendr   rW  rm  rj   lsr  r  filenwrite_tori  r  myaddrswpactionreqsesr  rdatasentr  subjr   r9  r  rN   rR  s#                                      r   	send_mailr    s    VVF -, -,wwz"" 	<NN:':[':':;;;    	\ 	BBB,,SR,JJ'')R((!! 	RMMMR++E22$ , , , LMMM ijjj RSSS"3r77+++& R R R"#FR#PQQQR 	  2;;3;#7#77FE***7<<
+E::(D)) $RHHUOOO$ $ $ $ $ $ $ $ $ $ $ $ $ $ $KK=>>>KK5<<>>#8#8#:#:#B#B4#T#TTUUUKK:;;; 	 {//0W0WTSUAVAV0W0W0WXXH001X1X#++dTVBWBW1X1X1XYYYH..X...GGGwr*++++v;; t
+KK  	!KK8,GGG HHKK5|DDD H77777
+ 
+ #$$hh|#h..	HHJJEyy""i//6{{" 0 	 	 	OO@#(KKK11111	 99X'))OO5uyy7K7KLLL4Dk##H--GD$  	<KK-sxx~~>>>>KK*CHHTNN;;;*0 
+	 
+	&IuhKK 5666(D 7t**
+|3t**tI6*7%@@@OE3qyy"lSXXd^^^^SZZ\\\#Z[[[AIDD
+	 
+ 
+*0 		 		&IuhF/%@@EKK 5666(D :he<<<<h	5999AIDD:sO   2C
+E(A*D77E(E##E(G66G:	=G:	;P 
+Q QQshortc                     g d}t          | |          \  }}|dk    rt                              d           d S |                                }|rt	          j        dd|          S |S )N)zsymbolic-refz-qr  r   z6Not able to get current branch (git symbolic-ref HEAD)z^refs/heads/rt   )r  r^   r{   r   r   r   )r  r  r-  r  rN   mybranchs         r   git_get_current_branchr    so    ,,,G 11JE3qyyPQQQtyy{{H 5vor8444Or   c                      t                      } t                      }|                     d          }|r?|                    d          D ])}|                    |                                           *|S )Nzemail-excluderC  )r   r   r   r   r   r   )r   excludes
+c_excludesr  s       r   get_excluded_addrsr    sn    FuuHO,,J (%%c** 	( 	(ELL''''Or   	addressesr  c                    t          |           D ]F}t          |d                                                   r
+d|d         vr|                     |           Jd}|D ]X}t	          j        |d         |          r;t
+                              d|d         |           |                     |           d} nY|r|d         t          v rPt          |d                  r;|                     |           |                     t          |d                             	t
+                              d|d                    dd|d          d	g}t          ||          \  }}|d
+k    rd t          |d         <   ct          j                            |                                g          }	t          |	          dk    r|d         |	d
+         d         k    rd t          |d         <   t
+                              d|d         |	d
+         d                    |	d
+         t          |d         <   |                     |           |                     |	d
+                    H| S )NrY   r   FzRemoved %s due to matching %sTz"Checking if %s is mailmap-replacedzcheck-mailmapr  r  r   z#Replaced %s with mailmap-updated %s)rB   rx   r   r  ry  r^   r_   MAILMAP_INFOrJ   r  r   r   r   )
+r  r  r  r  removedr
+  rJ  r  rN   replacements
+             r   cleanup_email_addrsr    sI    i #- #-58>>##$$ 	58(;(;U### 	 	GuQx11 <eAhPPP  '''	
+  	8|##E!H% 9  '''  eAh!7888958DDDU1X1$VT22
+sA::%)Lq"k..		}=={q  Qx;q>!,,,)-U1X&LL>a+VW.YZJ[\\\%0^Lq"U###[^,,,r   c                     t                      } t          j                            t	          t          j                              d          }t          j                            |          r?t          |dd          5 }|	                                }d d d            n# 1 swxY w Y   n| d         d| d         d}|S )	Nz
+.signaturera  r   r  r   r~  r   r  )
+r   r  r  rM   rK   r   r  rQ  rd  r  )r   sigfileri  r  s       r   get_email_signaturer    s    Ggll3ty{{++\::G	w~~g D'3111 	"R		I	" 	" 	" 	" 	" 	" 	" 	" 	" 	" 	" 	" 	" 	" 	" ")''2B2B2BC	s   >BB#&B#c                 t   d }| j         sut          st          d          t          |           }|st          d          t	                      }d| v r| j        dk    r|h}t          || j        |          }|sd |fS n`| j         dk    rt          j	                    5 }t          t          j        j                                        || j                  }d d d            n# 1 swxY w Y   t!          |          st          d          nt"          j                            | j                   rt          |           }t"          j                            | j                   rt+          j        | j                   }nt+          j        | j                   }|r-t1          ||          }|st          d	|d
+| j                   n|}nt          d| j         z            |rd| v r| j        rt1          ||d          }|s6|r4|D ]1}|                    dd           }|r|                    d          } n2||fS )Nz3Cannot retrieve threads from remote in offline modez)Pipe a message or pass msgid as parameterr   r   )r  r  rF  )r  z"Stdin did not contain any messageszCould not find z in zMailbox %s does not existr  T)r  r  ru   )	localmboxr  r>  r  r   r   r  r  rb  rc  r  r   rH  r  r  stdin_pipe_seprx   r  r  rQ  rj  rN  MaildirrO  r  r  r   r   )r9  rS   pickingsr  r  in_mbxr   s          r   retrieve_messagesr	    s   E $O 	USTTT'"" 	KIJJJ557""w'9S'@'@wH%eW_QYZZZ 	:	 ##,.. e#&sy'7'<'<'>'>WMcddde e e e e e e e e e e e e e et99 H!"FGGGH W^^G-.. 	Og&&Ew}}W.// 9 ):;; g&788 (77 ^%+555'J[J[&\]]]^ 9G<MMNNN =w&&7+;& ut<<< T  	 	CGGL$//E D)) $;s   9C""C&)C&gitobjc                     t          d d| g          \  }}|dk    rt          d| z            |                                S )NrB  r   zNo such object: %s)r  r*  r   )r
+  r  rN   s      r   git_revparse_objr    sE     V'<==JE3qyy/&899999;;r   r<  r?   )NFTNr  )rp  )NNN)r   )Nr  rk  )FN)NrY   NNNNNr  )rG  )NFFNNF)NT)rA  r   r  r   r   r  r  ry  email.utilsr   email.policyemail.headeremail.generatoremail.quoprimimerb  r  argparser  r  rb  urllib.parser  r%  r  rd   r  rN  r  r  r  r   
+contextlibr   typingr   r   r   r   r	   r
+   r   r   r   add_charsetrE  EmailPolicyrQ  compilerB  r   r   ModuleNotFoundErrorr  r   r  r  r  r   	getLoggerr^   getChildr  	addFilterr  r  r   r   r  r  r  r   r  r  r  LOREADDRr  r  r  r  r  r  r@   r  r8   rq   r   rU   r  r  r  r  rK   r  r   rI  rL  rm  r  rZ  rB   r'  r_  rM  rl  rd  rv  r  r   r  r  r  rK  rL  rT  r   r  r  	Namespacer  r  r   r   r  r  r  r  r   r  r9  r<  r?  ri  r  rL  rT  r^  r  rg  r  rx  r  r  r  r  r  r  Sessionr  r  rn  r  r  r  r  r  r	  r  r   r   r   <module>r      s         				 
+
+
+
+  				                                     
+
+
+
+ 				        % % % % % % Q Q Q Q Q Q Q Q Q Q Q Q Q Q Q Q Q Q Q Q        GT " " "L$$$QU$VV	 BJ+,,	KKKHH   HHHMMMJJ   JJJ     
+	4	 	 __V$$
+ 
+  % & & &
+"*?
+@
+@bj/00
+"*RZ\Z^acaeZe
+f
+f
+fbjB"$QSQU+VVV(($
+$!x)#!7"! (11! H	!
+ T! *! !$! e!  T!!$ g%!( D)!, d-!0 $1!4 $5!< d=!@ $A!H   
+tvvK# K# K# K# K# K# K# K#\~. ~. ~. ~. ~. ~. ~. ~.B^ ^ ^ ^ ^ ^ ^ ^Bh h h h h h h hV!u u u u u u u up\ \ \ \ \ \ \ \~% % % % %| % % %! ! ! ! ! ! ! !$ ?C)-( ($s) (HUO (!#(27UE8I2J( ( ( (&. .$s) .HUO .uSRWY^M^G_ . . . . VZ<@,0 HSM c 8E? #59$SM5:3c5j@Q;Q5R   :	 	 	C 	SV 	[cdg[h 	 	 	 		(3- 	t 	S	 	 	 	 	/ / / /RVWZR[ / / / / L L L L"    "    Xc] 3 s s     AERV  x~ #+D>BJ3-[_   D! ! ! ! !H #      3 #    D- -s -HSM - - - - # x}     F FC F# F$ F F F FN N N# Nx} NSV Nae N N N N    hsm    #x) #hsm # # # #LH H H HV 5 #  QUV[VcVkQl    2"B "B "Bt "BemNcId@e "B "B "B "BJ  # RVW\WdWlRm    4B BC B$ B B B B8 8=7;+ +# + +'/}+@H+ + + +^ :>344837?CFJ>BY Y# Ys Y Y#+DI#6Y#+C=Y %-SMY $,C=	Y
+ $,E#s(O#<Y %-T%S/-B$CY *2#c();Y HLERUW\WdWlRlLmGnY Y Y Yx     8C= HSM       $! ! ! !(D D D D$1S 1U4tXc]HUXM+Y%Z 1 1 1 18     (H4 56 Hh H H H H 4 56 h UY    Zt Z Z Z Z  u  tUE?Q9R    <  d    ,S ST SeE',@PRVX\2\,]_b,b&c S S S Sl S U8;KS;P5Q    6=S	 6=# 6=$ 6= 6= 6= 6=t PT8=NR#	v vE',(8$>? vxPUP]PeGf v v2:5d;K2Lvv15v #3-v ?Gsmv 	v ).hsmS.@(A	v v v vr	 	8C= 	 	PXY\P] 	 	 	 	CH    (4c3h#8 (CH ( ((26uS#X2G( ( ( (V
+S 
+ 
+ 
+ 
+2x1 2eHSM8TX><Y6Z 2 2 2 2hS S      s$   C C'&C'+C2 2C<;C<
\ No newline at end of file
diff --color -Naur /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/kr.cpython-311.pyc /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/kr.cpython-311.pyc
--- /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/kr.cpython-311.pyc	1970-01-01 00:00:00.000000000 +0000
+++ /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/kr.cpython-311.pyc	2023-07-17 20:22:03.208602124 +0000
@@ -0,0 +1,33 @@
+
+    d                     N    d Z ddlZddlZddlZddlZddlZddlZej        Zd ZdS )z5Konstantin Ryabitsev <konstantin@linuxfoundation.org>    Nc           
+      	   | j         rt          j        |           \  }}t                              d           	 dd l}n># t          $ r1 t                              d           t          j        d           Y nw xY wt                      }|D ]}|
+                    d          }|
+                    d          }|r|s2t          j                            |          }t          j                            |          }	|
+                    d          }
+|
+                    d          }|	
+                    d	d
+          }|
+dk    r|
+                    d          }n9|
+dk    r|
+                    d          }nt                              d|
+           |                    ||
+||f            |s.t                              d           t          j        d           t          j                            t          j                    d          }d}d}|D ]\  }}
+}}|                    |
+||          }t          j                            ||          }t          j                            |          rd}n?d}|
+dk    r7	 t          j        |          }t-          |          rd}n# t.          $ r Y nw xY wt1          j        t          j                            |                                        dd           t                              d||           t                              d|
+           |
+dk    rgd}t                              d|dd                     t                              dd                    t9          j        d|                               nd}t                              d|           t                              d |           t                              d!|           t                              d           |rNt                              d"           t                              d#           t                              d$           |r4t                              d%           t                              d&           t          j        d           t                              d'           d S )(Nz---r   z'--show-keys requires the patatt library   zx-developer-keyzx-developer-signatureaisdefaultopenpgpfpred25519pkzUnknown key type: %szNo keys found in the thread.keyringFknownunknownzin default keyringT)parentsexist_okz%s: (%s)z    keytype: %sz      keyid: %siz        fpr: %s:z.{4}z     pubkey: %sz     krpath: %sz   fullpath: %szFor openpgp keys:z    gpg --recv-key [keyid]z(    gpg -a --export [keyid] > [fullpath]zFor ed25519 keys:z    echo [pubkey] > [fullpath]z6This command is experimental. Try --show-keys [msgid].)showkeysb4retrieve_messagesloggerinfopatattModuleNotFoundErrorsysexitsetgetLoreMessageget_parts_from_headerdebugaddospathjoinget_data_dirmake_pkey_pathexistsget_gpg_uidslenKeyErrorpathlibPathdirnamemkdirrefindall)cmdargsmsgidmsgsr   keydatamsgxdkxdskdatasdataalgoidentityselectorkeyinfokrpathpgpecckeypathfullpathstatusuidss                        O/usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/kr.pymainrF      sO    H*733tE	MMMM" 	 	 	KKABBBHQKKKKK	 %% 	= 	=C''+,,C''122C c N88==EN88==E99S>>Dyy~~Hyyi00Hy  ))E**""))D//3T:::KK47;<<<< 	KK6777HQKKKbo//;;18 	5 	5-HdHg++D(HEEGw||FG44Hw~~h'' 
+ "9$$!w77t99 :%9F#   L223399$QU9VVVKK
+Hf555KK)4000y  -wstt}===-sxx
+7G8T8T/U/UVVVV-w777KK)7333KK)84444E 	DKK+,,,KK4555KKBCCC 	:KK+,,,KK8999
+KKHIIIIIs#   A   8A;:A;?%J%%
+J21J2)	
+__author__r"   r   r+   r/   r   b4.mboxr   rF        rE   <module>rK      so    E
+ 				 
+
+
+
+  				 				  
+KJ KJ KJ KJ KJrJ   
\ No newline at end of file
diff --color -Naur /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/mbox.cpython-311.pyc /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/mbox.cpython-311.pyc
--- /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/mbox.cpython-311.pyc	1970-01-01 00:00:00.000000000 +0000
+++ /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/mbox.cpython-311.pyc	2023-07-17 20:22:03.216602111 +0000
@@ -0,0 +1,117 @@
+
+    dq                        d Z ddlZddlZddlZddlZddlZddlZddlZddlZddl	Z	ddl
+Z
+ddlZddlZddlZddlZddlZddlZddlmZmZ ddlmZ ej        ZdZdeej        j                 dej        ded	dfd
+Zddej        ded	dfdZdeej        j                 ded	dfdZ 	 	 dde!de"dee"         ded	eej        j                 f
+dZ#ded	efdZ$ded	dfdZ%dej        d	dfdZ&dS )z5Konstantin Ryabitsev <konstantin@linuxfoundation.org>    N)OptionalList)TemplatezrMerge ${patch_or_series} "${seriestitle}"
+
+${authorname} <${authoremail}> says:
+
+${covermessage}
+
+Link: ${midurl}
+msgscmdargsmsgidreturnc           
+      *   t          j                    }|j        }|dk    rd|_        |j        }|j        }t          |           }t                              d|           t          j	                    }| D ]}	|
+                    |	           d}
+|j        rd}
+|                    ||j        |
+          }|E|j        dk    r:|t                              d           nt                              d|           d S t          |j                  d	k    r<|s:t                              d
+|j                   t                              d           |j        rt%                      }|j        dk    r|t          j        d	d	          }|j        D ]}|j        r|                    |           d}|j        d	d          D ]$}|d	z  }|r|j        |k    r|g}d| d|_         n%t          |          s.t                              d           t3          j        d	           n|j                            d          dk    rd}|j        d	d          D ];}|d	z  }t9          j        |j        |j                  r|                    |           <t          |          s4t                              d|j                   t3          j        d	           n@t%          t          j        |j        t          |j                  d	z
+                      }nd }	 |                     |j!        ||j"        |j#        |d         ||j$        |j%                  }n$# tL          $ r t3          j        d	           Y nw xY wt                              d           |)t                              dt          |                     n.t                              dt          |          |j                   |j'        r|j        d         j(        r|st                              d           t                              d           tS                      }|j        d         j(        D ]J}||vrDt                              d|*                    d                     |+                    |           Kt                              d           t          |j,                  rt                              d           t                              d           |j,        D ]?\  }}}}t                              d||           t                              d||           @t                              d            d }d }|j        D ]}||j-        }|j        } n|t                              d!           d S t          j.                    }|j/        rx|st                              d"           n[|j0        st                              d#           n9|1                    d $          \  }}|r|rt                              d%||           t                              d           |j2        rnt                              d&|j                   t                              d'           t                              d(           t                              d           |j0        s!|j        st                              d)           |3                    d*          }d }|j4        d+k    rg|j5        }|j6        s|7                    d,d-          d.k    rd}d/} nd}d0} |rN|}!|                    d1          d2k    r0d18                    |9                    d1          d d2                   }!|!}n|3                    d*          }!|dk    rtt          j;        8                    ||! d1|            }tt          j;        8                    ||! d3          }"tt          j;        <                    |          rHtt          j;        =                    |          rt}          j?        |           ntu          j@        |           |rt          jA        ||           ndt          |d4          5 }#t          jC        ||#           d d d            n# 1 swxY w Y   n&d }"t          jC        |t2          jD        jE                   |j'        r|j        s|F                    |"           |d         |z  }$|jG        rNtt          j;        8                    ||! d5          }%t          ||%           t                              d6|%           t                              d7|$           d }&t          jJ        d8|t          jK                  }'|'r|'L                                d         }&n<t          jJ        d9|t          jK                  }'|'r|'L                                d         }&|&rP|rNt          jM        ||&          st                              d:|&           d }&nt                              d;|&           |&s|r|jN        rt                              d<           	 |O                    ||jP        |jQ        =          \  }&}(})|)dk    rt                              d>|&           nA|(|)k    rt                              d?           n t                              d@|&|(|)z
+  |(           n*# t          $ r t                              d?           Y nw xY w|j4        dAk    	r~|s.t                              dB           t3          j        d	           t          jT                    }*t          jC        ||*           |*U                                }+|jV        s|7                    dCdD          },t          jW        |,dE          }-d|-_X        t%          |-          }.t          jY        |d+g|.z   |+d|F          \  }/}0t                              |0Z                                           |/dk    rt          ||G           t3          j        |/           |&sdH}&t          j\        ||&          5 }1t                              dI           t          jY        |1dJdKgdL          \  }/}0|/dk    rHt                              dM           t                              |0           t3          j        |/           t          jY        |1dNgdL          \  }/}0|/dk    rHt                              dO           t                              |0           t3          j        |/           t          jY        |1d+g|+dP          \  }/}0|/dk    rt                              dQ           t                              d           t                              |0Z                                           t                              d           t                              dR           t3          j        |/           t                              d           t                              |0Z                                           t                              d           t                              dS           dT|1g}2t          jY        ||2dL          \  }/}0|/dk    rZt                              dU           t                              |0Z                                           t3          j        |/           g dV}2t          jY        ||2dL          \  }/}3|/dk    rZt                              dW           t                              |0Z                                           t3          j        |/           t          |3]                                dX          5 }4|4^                                }5d d d            n# 1 swxY w Y   |d         |z  }$t          |          d	k    rdY|$z  }6ndZ|$z  }6|5_                    |1|6          }7|7|5k    r=t          |3d[          5 }4|4`                    |7           d d d            n# 1 swxY w Y   d\d]g}2t          jY        ||2dL          \  }/}3|/dk    rZt                              d^           t                              |0Z                                           t3          j        |/           tt          j;        8                    |3]                                d_          }8t          }9|7                    d`          ra	 t          jb        |d`                   }9nE# t          $ r8 t                              da|d`                    t3          j        db           Y nw xY wtt          j;        <                    |8          rtu          j@        |8           |j'        r:|j        d         }:t           jd        e                    |:j-                  };|;d	         }<n|j        d	         }:dc}<|:j        |:jf        |:jg        |<|$dd}=t          |          d	k    rde|=df<   ndg|=df<   t          |9          i                    |=          }>t          |8d[          5 }?|?`                    |>           d d d            n# 1 swxY w Y   d d d            n# 1 swxY w Y   |7                    dhdi          }@t          jW        |@dE          }-d|-_X        |jj        rdj}Andk}Adldmdn|8|Adogt%          |-          z   }Bdpg|Bz   }Ct          ||G           |jk        r|jj        s}t                              dqdr8                    |C                     	 t          ds           nl# t          $ r1 t                              dD           t3          j        dt           Y n2w xY wt                              dudr8                    |C                     t          t2          dv          r,t          jY        d |B          \  }0}Dt3          j        |0           tu          jo        |Cd         |C           t                              dw           t                              dxdr8                    |C                     t3          j        d           |&sq|p                    ||jP        y          \  }E})|Er6t          |)          dk    r#|E|)k    rt                              dz           dH}&nt                              d{           |&t                              d|||&           |j        dk    rt                              d}|           t          ||G           d S )~N-Tz#Analyzing %s messages in the threadF)revisionsloppytrailersreroll_zNo patches found.zUnable to find revision %s   z!Will use the latest revision: v%sz/You can pick other revisions using the -vN flag)r   expectedr   <>z?Specified msgid is not present in the series, cannot cherrypick*z2Could not match "%s" to any subjects in the series)upperlinkmask)noaddtrailerscovertrailersaddmysobaddlinkr   
+cherrypickcopyccsallowbadchars---zTotal patches: %sz$Total patches: %s (cherrypicked: %s)z2NOTE: Some trailers were sent to the cover letter:z      %s)omit_extinfoz0NOTE: Rerun with -t to apply them to all patchesz9NOTE: some trailers ignored due to from/email mismatches:z    ! Trailer: %s: %sz     Msg From: %s <%s>z(NOTE: Rerun with -S to apply them anywayz)Could not find any patches in the series.z0WARNING: cannot prepare 3-way (not in a git dir)z1WARNING: cannot prepare 3-way (series incomplete))gitdirz;Prepared a fake commit range for 3-way merge (%.12s..%.12s)z8WARNING: v%s is a partial reroll from previous revisionszK         Please carefully review the resulting series to ensure correctnessz,         Pass --no-partial-reroll to disablezWARNING: Thread incomplete!extendedamsave-maildirsnoyesmaildirmbx.z.coverwbz.patchesz	Quilt: %sz	 Link: %szbase-commit: .*?([\da-f]+)zbased on .*?([\da-f]{40})z) Base: base-commit %s not known, ignoringz% Base: using specified base-commit %sz) Base: attempting to guess base-commit...)branchesmaxdaysz Base: %s (exact match)z Base: failed to guess basez+ Base: %s (best guess, %s/%s blobs matched)shazamz:Could not figure out where your git dir is, cannot shazam.zshazam-am-flags )posix)stdin	logstderrrundir)r   HEADz"Magic: Preparing a sparse worktreezsparse-checkoutinit)r2   z"Error running sparse-checkout initcheckoutz*Error running checkout into sparse workdir)r1   r2   z5Unable to cleanly apply series, see failure log belowzNot fetching into FETCH_HEADzFetching into FETCH_HEADfetchz!Unable to fetch from the worktree)	rev-parsez
+--git-path
+FETCH_HEADzUnable to find FETCH_HEADrzpatches from %szpatch from %swr8   z	--git-dirzUnable to find git directoryzb4-coverzshazam-merge-templatezBERROR: shazam-merge-template says to use %s, but it does not exist   zRNOTE: No cover letter provided by the author.
+      Add merge commit message here.)seriestitle
+authornameauthoremailcovermessagemidurlzpatch seriespatch_or_seriespatchzshazam-merge-flagsz	--signoffz	--no-editz--editmergez--no-ffz-Fr9   gitzWill exec: %s z*Press Enter to continue or Ctrl-C to abort   zInvoking: %s_running_in_pytestz(You can now merge or checkout FETCH_HEADz
+  e.g.: %s)atz$ Base: applies clean to current treez Base: not specifiedz       git checkout -b %s %sz       git am %s)qb4get_main_configoutdirnocoverwantverr   lenloggerinfoLoreMailboxadd_messagenopartialreroll
+get_seriesr   r   criticalseriesr   list
+LoreSeries	followupshas_diff	add_patchpatchesr   sysexitfindfnmatchsubjectappendparse_int_rangeget_am_readyr   r   r   r   r   KeyError	has_coverfollowup_trailersset	as_stringaddtrailer_mismatchesbodygit_get_toplevelthreewaycompletemake_fake_am_rangepartial_rerollget_slugsubcmdwantnamer'   getjoinsplitospathexistsisdirshutilrmtreeunlinksave_maildiropensave_git_am_mboxstdoutbuffer
+save_cover
+quiltreadysave_as_quiltresearch	MULTILINEgroupsgit_commit_exists	guessbase	find_baseguessbranch	guessdays
+IndexErrorioBytesIOgetvaluemakefetchheadshlexwhitespace_splitgit_run_commandstripthanks_record_amgit_temp_worktreerstripreadreplacewriteDEFAULT_MERGE_TEMPLATEread_templateFileNotFoundErrorLoreMessageget_body_partsfromname	fromemailr   safe_substituteno_interactiverD   inputKeyboardInterrupthasattrexecvpcheck_applies_clean)Fr   r   r   configrL   rN   r   countlmbxmsgr   lserr   followuprI   lmsgam_msgstseenltrtnametvaluefnamefemail	top_msgid
+first_bodytopdirrstartrend	gitbrancham_filenameru   r   dftextslugam_coverfhlinkurl	q_dirnamebase_commitmatchesnblobs
+mismatchesifhambytesamflagsspamargsecodeoutgwtgitargsfhffhhcontentsmmsgnew_contentsmmfmerge_templatecmsgpartsr@   tptvalsrm   mmh
+mergeflagsedit	mergeargsmergecmdlogstrcheckedsF                                                                         Q/usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/mbox.pymake_amr   )   sg   !!F^F}}oG)MIIE
+KK5u===>D  F ??GG<R[a?bbD|*c11?OO/0000OO8'BBB
+4;!G7GGGEFFF "VV
+$$ |}a!<<< N - -$ -NN8,,,BQRR(  a DJ%//"$J)5UG&Ez??  abbb$$S))Q..BQRR( * *a?4<1CDD *%%b)))z??  TV]Vhiiib01C3t|K\K\]^K^___``JJ
+##'2G2?'JZ,3OfZFXeo,3O7K` $ b b     KK+S\\:::::CLL'J\]]]~ 	L$,q/; 	LM 	LLMMM<?4 	 	C%
+CMMtM,L,LMMM		#JKKK
+4"## DSTTT,0,C 	E 	E(E65&OO3UFCCCOO4eVDDDDBCCCIJ  J
+IE  CDDD ""F i 	iOONOOOO 	iOOOPPPP22$2??LFD i$ iY[acghhh
+OOE RTXTabbbefffFGGG= 7!3 75666u--IK~#? 	fjj$??5HHLFF LF 	0D}}S!!B&&xxs 3 3CRC 899II==$=//DS==',,v$/A/A/A/ABBKw||FtOOO<<Hw~~k** +7==-- +M+....Ik*** 55555+t,, 5'4445 5 5 5 5 5 5 5 5 5 5 5 5 5 5 H):;;;> 	&'/ 	&OOH%%%$y0 	4V->->->??I'9---OOK333W---Ki5z2<PPG .nn&&q) )8*blSS 	.!..**1-K Nv N#FK88 	NKKC[QQQKKKK?MMM ;6 ;g&7 ;CDDD	;.2nnVgNaELEV /= /X /X+KQ 9;GGGG:%% =>>>> M{ & 3V= = = 	; 	; 	;OO9:::::	; ~!! 	OOXYYYHQKKKjll
+GS))),,..$ 		jj!2B77GWD111B"&B"XXF+FTFVO7^bkqrrrJE3KK		$$$zz *====HUOOO 	! K!&+66 \	 #KK<===+C2CV1LX\]]]JE3qyy DEEE$$$+C*NNNJE3qyy LMMM$$$+C$wRVWWWJE3qyy WXXX&&&		,,,&&& >???KKKK		$$$KKKK2333nG+FGtLLLJE3qyy CDDD		,,,???G+FGtLLLJE3qyy ;<<<		,,,cjjllC(( &C88::& & & & & & & & & & & & & & &Z(94G7||a(72&0#++C66Lx''#s^^ ,sIIl+++, , , , , , , , , , , , , , , #K0G+FGtLLLJE3qyy >???		,,,',,szz||Z88C3Nzz122   %'%5f=T6U%V%VNN(      OO$h$*+B$CE E EHQKKKKK  w~~c"" 	#~ H|A55di@@$Qx|A!G  $|"m#~ ,! G 7||a-;)**-4)*N++;;GDDDc3  3		$                             w\	  \	  \	  \	  \	  \	  \	  \	  \	  \	  \	  \	  \	  \	  \	 | ZZ 4kBB
+[4000"! 	DDDisD,G$r((R	7Y&*5555= 	-) @OSXXh-?-?@@@"FGGGG( " " "KKOOOHSMMMMM" NCHHX,>,>???s011  0yAAV Ihqk8,,,>???L#((8"4"4555 4"66v'BU6VV 	4s:!++:0E0EOOBCCC KKOO23336	;OOO~*K888Tj111111s!  <M M10M1b&&b*-b*)B	k3 3$ll.MAJ<>AJ<#	#AJ<&#	'AAJ<@?AA!AAJ<A!AA%	A%AJ<A(AA%	A)CAJ<D9AEEAJ<E?AFFAJ<FAFFC-AJ<JAJ%JAJ<J%AJ)	J)AJ<J,AJ)	J-AJ<J<AK KAK M3AN N8AN>N=AN>r   r   c                    t          j                    }|                     d          }d|z  }t                      }t                      }d}t	          t          | j                            }d }	| j        D ]}
+|
+|dz  }
+|                    |
+j	                   |	|
+}	|
+j
+        s|dz  }5|%||vr!t                              d|           |dz  }\|
+j        t                              d            d S t          |
+j                                      |          d|
+j        }|                    |
+j        |
+j        |
+j	        |f           |dz  }|	t                              d	           d S 	 t"          j                            d
+ |	j                            dg           D                       }nG# t,          $ r:}g }t                              d|	j	        t          |                     Y d }~nd }~ww xY w	 t"          j                            d |	j                            dg           D                       }nG# t,          $ r:}g }t                              d|	j	        t          |                     Y d }~nd }~ww xY w|	j	        |	j        |	j        |	j        t          j        |d          t          j        |d          t           j                            |	j        d                   t           j                            |	j        d                   t          j        |	j        d          |d u|d}t>          j         !                    ||          }tE          |dd          5 }tG          j$        ||dd           t                              d|           d d d            n# 1 swxY w Y   t          j%                    }|&                    d          }|rt          j'        ||           d S d S )NTr!   z%s.amr   r   zSkipped non-cherrypicked: %sz=Unable to get hashes for all patches, not tracking for thanks/z,All patches missing, not tracking for thanksc                 ,    g | ]}t          |          S  str.0xs     r   
+<listcomp>z$thanks_record_am.<locals>.<listcomp>      )U)U)UQ#a&&)U)U)U    toz(Unable to parse the To: header in %s: %sc                 ,    g | ]}t          |          S r   r   r   s     r   r   z$thanks_record_am.<locals>.<listcomp>  r   r   ccz(Unable to parse the Cc: header in %s: %sF)clean
+ReferencesDate   )maxlines)r   rb   r   r   r   r   
+referencessentdatequoter   r]   r;   zutf-8)encoding   )ensure_asciiindentzWrote %s for thanks trackingzpw-review-state)(rJ   get_data_dirrs   rX   rO   r   r   r]   rc   r   r[   rP   debugpwhashcounterzfillrb   emailutilsgetaddressesr   get_all	Exceptionfull_subjectr   r   format_addrsr   clean_header
+make_quoterm   ry   rz   rw   r   jsondumprK   rv   patchwork_set_state)r   r   datadirr   filenamer]   msgidsrI   padlenr   pmsgprefixalltoexallccr   fullpathr   r   pwstates                       r   r   r     s;   oG==$=''D~HffGVVF	
+BT]##$$FD  <!GBdj!!!<D} 	!GB!b
+&:&:LL7<<<!GB;LLXYYYFF--33F;;;;T]]Kdk4:vFGGG
+a|CDDDV(()U)U$(:J:J4QS:T:T)U)U)UVV V V V?SQSWWUUUUUUUUVV(()U)U$(:J:J4QS:T:T)U)U)UVV V V V?SQSWWUUUUUUUUV $M^oe5111oe5111n11$(<2HIIN//0@AAty1555 , C w||GX..H	hg	.	.	. ?"	#ra88883X>>>? ? ? ? ? ? ? ? ? ? ? ? ? ? ? !!Fjj*++G 0
+vw/////0 0sD   5AF8 8
+G<0G77G< AI 
+J0JJ14N11N58N5r   r   c           	         t           j                            |          rt                              d|           d S t          j        |                              d           t                      }| D ]}t          j
+        |                    dd                    }d|j        t          j        dd|j                                      d                                          fz  }| d	}|                    |           t           j                            ||          }t          j        |                    t          j        
+          d          \  }}	}
+t/          |d          5 }|                    d          re|                    d|                    d                                          |                    d                                          fz             n=|                    d|                    d                                          z             |                    d|                    d                                          z             |                    d|                    d                                          z             |                    d           |                    |	           |                    |
+           d d d            n# 1 swxY w Y   t                              d|           t/          t           j                            |d          d          5 }|D ]}|                    d|z             	 d d d            d S # 1 swxY w Y   d S )Nz4ERROR: Directory %s exists, not saving quilt patchesT)parentsrb   r/   z%04d_%sz\W+r   z.patch)policy)scissorsr+   Authors   From: %s <%s>
+Emails	   From: %s
+s   Subject: %s
+Subjects	   Date: %s
+r      
+z  Wrote: %srW   r;   z%s
+)ry   rz   r{   rP   rV   pathlibPathmkdirrX   rJ   LoreSubjectrv   r  r   subrb   r   lowerrc   rw   get_mailinfoas_bytes	emlpolicyr   r   encoder  )r   r   patch_filenamesr   lsubjr   patch_filename	quilt_outimpr   sfhs                r   r   r     sc   	w~~i   NPYZZZL!!$!///ffO 4 4swwy"5566EM26&#u}+M+M+S+STW+X+X+^+^+`+`aa ~...GLLN;;	/#,,bl,"C"CdSSS1a)T"" 		buuX B+quuX/E/E/G/GwI^I^I`I`.aabbbbw)>)>)@)@@AAAHH%i(8(8(?(?(A(AABBBHH]QUU6]]%9%9%;%;;<<<HHUOOOHHQKKKHHQKKK		 		 		 		 		 		 		 		 		 		 		 		 		 		 		 	]N3333	bgll9h//	5	5 /- 	/ 	/NIIf~-....	// / / / / / / / / / / / / / / / / /s%   ,E1K))K-	0K-	?M++M/2M/r   F	directionwantversnocachec                 T   d }d }t                      }t                      }t                      }| D ]}	t          j                            |	          }
+|                    |
+           t          j        |	d                   }|j        dk    r]|j        st          j                            |	          \  }}|rt          j
+        d|t          j        t          j        z            }|ret                              d|                                d                    d|                                d         z  }|                    |           |!t                              d|d                    t                              d	|j                   ||j        |k    rC|j        }|j        dk    r |j        s|	}|                    |           |j        dk    r||vr|	}|s|| S t          j        |d                   }t'          |j                  st                              d
+           | S |dk     r"|dk    rt                              d           | S |dk     r||dz
+  g}t*          j                            |                    dg                     d         d         }t*          j                            t5          |d                             }d|j                            dd          d|d}|                    |           t;          j        d|d d                   }|dk    r t                              d           d|z  }nt                              d           d|z  }dd                     |          d|}t          j!        ||          }|s| S tE                      }|D ]}t          j                            |          }t          j        |#                    d                    }||v r!t                              d|j                   n|j        rKt                              d|j                   | $                    |           |                    |           |dk    r,|j        |k    r!t                              d |j                   |dk     r-|j        |k    r"t                              d!|j                   %|dk     r+|j        |vr"t                              d"|j                   V|j        dk    rS|j        |k    rH|dk    r!t                              d#|j                   nt                              d$|j                   n|dk    r2|j        |k    r't                              d%|j        |j                   nZ|dk     r2|j        |k     r't                              d&|j        |j                   n"t                              d'|j                   F|j        |vr
+d||j        <   ||j        xx         dz  cc<   t                              d(|j                   | $                    |           |                    |           |%                                D ]!\  }}t          &                    d)||           "| S )*Nr&  r   z^change-id:\s+(\S+))flagszFound change-id %sr   znq:"change-id: %s"zCurrent base_msg: %szChecking the subject on %sz@Not checking for new revisions: no prefixes on the cover letter.z*This is the earliest version of the seriesfromr   z(s:""r/   z	" AND f:"z")z%Y%m%d	   zChecking for newer revisionszd:%s..zChecking for older revisionszd:..%s(z OR z) AND r<  rb   zSkipping %s: already have itzAdding reply: %sz&Ignoring result (not new revision): %sz&Ignoring result (not old revision): %sz*Ignoring result (not revision we want): %szLikely a new revision: %szLikely an older revision: %sz#Definitely a new revision [v%s]: %sz&Definitely an older revision [v%s]: %szNo idea what this is: %sz
+Adding: %sz  Added from v%s: %s patches)'ri   rJ   r   get_clean_msgidrk   r+  r  replyget_payloadr   r   IMrP   r  r   r  r   counters_inferredrO   prefixesr	  r
+  r  r  parsedate_tzr   rb   r   timestrftimerV   rw   get_pi_search_resultsdictrv   rc   itemsrQ   )r   r:  r;  r<  base_msglatest_revisionseen_msgidsseen_coversqueriesr   r   lsubpayloadcharsetr   qfromemlmsgdate	startdatedatelimq_msgsseen_revisionsq_msgq_msgidrevr   s                             r   get_extra_seriesrc    sX   HO%%K%%KeeG  ..s33~c)n-- <!z 	#!~99#>>GW #)$:G24RTRV;WWW #LL!5w~~7G7G7JKKK,w~~/?/?/BBAKKNNNLL/)1DEEE143DEEE"dm&F&F"mO|q  )? 0000""k'I'I x' >(9-..Dt} WXXX1}}A--ABBB1}})#a'(k&&x'7'7'C'CDDQGJGk&&s8F+;'<'<==GG!%!5!5c2!>!>!>!>HAKKNNNh44I1}}6777Y&6777Y&W----ww7A%a999F VVN +! +!.0077~eii	2233k!!LL79JKKK: 	LL+T->???KKOOG$$$q==T]o==LLA4CTUUU]]t}??LLA4CTUUU]]t}H<<LLEtGXYYY=A$-?"B"B1}}8$:KLLLL ;T=NOOOO]]t}>>LL>tO`aaaa]]t}>>LLA4=RVRcddddLL3T\BBB=..,-N4=)t}%%%*%%%\4#4555E    $**,, @ @
+U2C????Kr   destc                 x   t           j                            t           j                            | d                    r|t           j                            t           j                            | d                    r?t           j                            t           j                            | d                    rdS dS )NnewcurtmpTF)ry   rz   r|   rw   )rd  s    r   
+is_maildirri    s    
+bgll4//00 bgll47788bgll47788 t5r   c                    t          |           rt          j        |           }nt          j        |           }t	                      }|                                D ]\  }}t          j                            |          }||vrCt          j	        |d          }|D ]*}t          j                            |          }||vr|||<   +||v rM|
+                    |||         ff           t                              d|                    d                     t                              d|           |                                 d S )NTrC  zRefetched: %sr&  z!WARNING: Message-id not known: %s)ri  mailboxMaildirmboxrO  rP  rJ   r   rD  get_pi_thread_by_msgidupdaterP   rQ   rv   warnclose)	rd  rm  by_msgidkeyr   r   amsgsamsgamsgids	            r   refetchrw    s<   $ "t$$|D!!vvHJJLL D DS..s33  -eTBBBE , ,77==))'+HV$HKK#x/1222KK););<<<<KK;UCCCCJJLLLLLr   c                    | j         dk    rGd| _        d| _        d| _        d| _        d | _        | j        rd| _        | j        rd| _        nd| _        | j        rd| _	        | j         dk    r| j
+        rt          | j
+                  S 	 t          j        |           \  }}nF# t          $ r9}t                              d|           t!          j        d           Y d }~nd }~ww xY w|st!          j        d           t%          |          r*| j        r#t          j        rt)          |d| j	                  }| j         d	v rt+          || |           d S t                              d
+t%          |                     | j        dk    rBt                              d           t          j        |t           j        j        d           d S t5          | j                  rt7          j        | j                  }t;                      }d}| j        r7|D ]4}|                    t          j         !                    |                     5|D ]=}t          j         !                    |          |vr|dz  }|                    |           >t                              d|| j                   d S t          j"                    }	| j#        s|	$                    dd          dk    rd}
+d}nd}
+d}| j%        r+tL          j'        (                    | j        | j%                  }nStS          j*        dd|          +                    d          }tL          j'        (                    | j        | d|           }|
+rtL          j'        ,                    |          rt[          j.        |           t7          j        |d          }|D ]}|                    |           |/                                 t                              d|           d S ta          |d          5 }t          j        ||d           d d d            n# 1 swxY w Y   t                              d|           d S )Nr.   TFr   rm  zCRITICAL: %sr   )r:  r<  )r#   r.   z%s messages in the threadr   )mangle_fromr   zAdded %s messages to maildir %sr$   r%   r&   r'   r(   z[^\w@.+%-]+r   r)   )createzSaved maildir %sr+   zSaved %s)1rt   
+checknewerro   rT   rL   r   rD   r   r   r<  rw  rJ   retrieve_messagesLookupErrorrP   rV   r^   r_   rO   can_networkrc  r   rQ   save_mboxrd_mboxr   r   ri  rk  rl  ri   filterdupesrk   r   rD  rK   r'   rv   ru   ry   rz   rw   r   r,  r   r|   r}   r~   rq  r   )r   r   r   r  mdrhave_msgidsaddedemsgr   r   r   r   savename
+safe_msgidmdr   s                   r   mainr    s|   ~!!! "'"= 	)$(G!  	& $G %G ~GOw'''*733tt   +++  
+4yy LW' LBN L7?KKK~)))gu%%%
+KK+SYY777~E
+D#*"3GGGG '.!! ogn--ee 	F F F > >t D DEEEE 	 	C~--c22+EE
+5ugnMMM!!F &**_d;;uDD J7<<0@AAVNC77==cBB
+7<<:0H0H0H0HII 7=="" 	$M(###_Xd333 	 	CFF3KKKK
+
+
+
+&111	h		 8
+D"$77778 8 8 8 8 8 8 8 8 8 8 8 8 8 8 KK
+H%%%%%s*   B   
+C#*/CC#P00P47P4)N)r   NF)'
+__author__ry   r^   rk  r	  email.messageemail.utilsr   rL  r  ra   r}   r(  r   r   argparserJ   typingr   r   stringr   rP   r   messageMessage	Namespacer   r   rY   boolr   r   rX   intrc  ri  rw  r  r   r   r   <module>r     sl   E
+ 				 
+
+
+
+           				      				   				 ! ! ! ! ! ! ! !      	 u2$u},- u28J u2SV u2[_ u2 u2 u2 u2pL0 L02= L0d L0d L0 L0 L0 L0^/4 56 /3 /4 / / / /< PT%*v v4 vC vx} v"v/3EM4I/Jv v v vrS T    # $    .V&($ V& V& V& V& V& V& V&r   
\ No newline at end of file
diff --color -Naur /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/pr.cpython-311.pyc /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/pr.cpython-311.pyc
--- /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/pr.cpython-311.pyc	1970-01-01 00:00:00.000000000 +0000
+++ /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/pr.cpython-311.pyc	2023-07-17 20:22:03.220602104 +0000
@@ -0,0 +1,170 @@
+
+    dR                     v   d Z ddlZddlZddlZddlZddlZddlZddlZddlZddl	Z	ddl
+ZddlZddlmZmZ ddlmZmZ ddlmZ ddlmZ ddlmZ ddlmZmZ  ej        d	d           ej        Z ej        d
+ej        ej        z            gZ ej        dej        ej        z            gZ  ej        dej        ej        z             ej        dej        ej        z            gZ!d Z"d Z#d Z$d Z%ddZ&d Z'	 	 ddee(         dej)        dee(         de*deej+        j,                 f
+dZ-de(fdZ.d Z/dS ) z5Konstantin Ryabitsev <konstantin@linuxfoundation.org>    N)datetime	timedelta)utilscharset)MIMEText)MIMEApplication)MIMEMultipart)OptionalListutf-8z%changes since commit ([\da-f]{5,40}):z$fetch changes up to ([\da-f]{5,40}):z7^\s*([\w+-]+(?:://|@)[\w/.@:~-]+)[\s\\]+([\w/._-]+)\s*$z$^\s*([\w+-]+(?:://|@)[\w/.@~-]+)\s*$c                 @    d                     d | D                       S )Nz, c                 6    g | ]}t          j        |          S  )r   
+formataddr).0pairs     O/usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/pr.py
+<listcomp>z format_addrs.<locals>.<listcomp>5   s#    ???e&t,,???    )join)pairss    r   format_addrsr   4   s#    99?????@@@r   c                 b   |                      d          dk    sO|                      d          dk    s6|                      d          dk    st                              d|            d S t                              d| |           t	          j        dd|          }|                     d	          dk     rR|                     d
+          dk     r9t          j        d d| d|z  g          }|st          j        d d| d|z  g          }nP|                     d
+          dk    rt          j        d d| d|z  g          }nt          j        d d| d|z  g          }|st                              d           d S |d                                         d         }t                              d|           |S )Nzgit://r   zhttp://zhttps://z%s uses unsupported protocolzgetting commit-id from: %s %sz^refs/ zheads/ztags/z	ls-remotezrefs/heads/%szrefs/tags/%s^{}z
+refs/%s^{}zrefs/%sz-did not find commit-id, ignoring pull requestzsuccess, commit-id: %s)	findloggerinfodebugresubb4git_get_command_linessplit)reporeflines	commit_ids       r   git_get_commit_id_from_repo_refr(   8   s   IIh1$$		)(<(<(A(ATYYzEZEZ^_E_E_2D999t
+LL0$<<<
+&B
+$
+$C
+xxA#((7"3"3a"7"7(T?UXCX/YZZ 	a,TKGX[^G^3_``E	'		a		(T<RUCU/VWW (T9s?/STT DEEEta  #I
+LL)9555r   c                    t          j        |           }|j        t                              d           d S t                              d|j                   t          D ]?}|                    |j                  }|r!|	                                d         |_
+         n@t          D ]i}|                    |j                  }|rK|	                                }|d         |_        t          |          dk    r|d         |_        nd|_         njt          D ]?}|                    |j                  }|r!|	                                d         |_         n@|j        r&|j        rt#          |j        |j                  |_        |S )Nz/Could not find a plain part in the message bodyzLooking at: %sr      zrefs/heads/master)r!   LoreMessagebodyr   criticalr   full_subjectPULL_BODY_SINCE_ID_REsearchgroupspr_base_commitPULL_BODY_REMOTE_REF_REpr_repolenpr_refPULL_BODY_WITH_COMMIT_ID_REpr_tip_commitr(   pr_remote_tip_commit)msglmsgsince_rematches
+reporef_rechunkscid_res          r   parse_pr_datarA   Z   s   >#DyIJJJt
+KK $"3444)  //$),, 	").."2"21"5DE	 . 	 	
+##DI.. 	^^%%F!!9DL6{{Q$Qi1E	 .  --	** 	!(!1!1!!4DE	 | _ _$CDLRVR]$^$^!Kr   c                 "   t          j                    }|d         }|d         dk    rt           j        }t           j        }nt           j        }t           j        }t          j        | g d          }d}d}d}	t          |          r|d         }	|	d	k    rt          j        | g d
+d          \  }
+}n"|	dk    rt          j        | g dd          \  }
+}t          j	        |          \  }}}}}d }|rl	 t          j
+        |          }|D ]'}|                    d|j                   dk    r|} n(|s|d         }n"# t          $ r |j         d|j         d}Y nw xY w|r|rd}|                                }t!                      }t          |          s|dk    r|                    d|	z             |r=d|z  }t$                              d           t$                              d||           d S |rt$                              d           t          |          rt$                              d           nt$                              d           |D ]}t$                              d||           |dk    rdd l} |j        d           d S d S d S )Nattestation-policyzattestation-checkmarksfancy)zcat-filez-t
+FETCH_HEADFr   unknownr   tag)z
+verify-tag--rawrE   T	logstderrcommit)zverify-commitrH   rE   < <>checkzRemote %s is not signed!z
+Signed: %sz  ---z  %s %sz;  Pull request is signed, but verification did not succeed:z,  Pull request verification did not succeed:z	    %s %shardfail   )r!   get_main_configATT_PASS_FANCYATT_FAIL_FANCYATT_PASS_SIMPLEATT_FAIL_SIMPLEr"   r5   git_run_commandcheck_gpg_statusget_gpg_uidsr   	fromemailKeyErrorfromnamestripsetaddr   r   r-   sysexit)gitdirr;   config	attpolicyattpassattfailhtypepassingoutotypeecodegoodvalidtrustedkeyidsigtimesigneruidsuiderrorstrailererrorr`   s                          r   attest_fetch_headrw      s    !!F+,I&'722##$$$V-M-M-MNNEG
+CE
+5zz a~~'0U0U0Uaefff
+ss	(		'0X0X0Xdhiii
+s+-+>s+C+C(D%%F ;
+	;?5))D  8800011Q66 FE 7  !a 	; 	; 	;:::::FFF	;   
+))++CUUFs88 7	W,,
+
+-5666 'GIw000    s88 	LOOYZZZZOOJKKK 	9 	9EOOK%8888
+""JJJCHSMMMMM  #"s   1AD: :EETc                 V   |j         rVt          j        | |j                   s<t                              d|j                    t                              d           dS |j        |j        k    rBt                              d           t                              d|j        |j                   dS t                              d|j        |j	                   d|j        |j	        g}t          j
+        | |d	          \  }}|d
+k    r6t                              d           t                              |           |S t          j                    }|r|d         dk    rt          | |           t                              d           |rvdd|dg}t                              d|           t          j
+        | |          \  }}|d
+k    r6t                              d           t                              |           |S nt                              d           |rt          |           d
+S )Nz(ERROR: git knows nothing about commit %szB       Are you running inside a git checkout and is it up-to-date?r*   z9ERROR: commit-id mismatch between pull request and remotez       msg=%s, remote=%sz  Fetching %s %sfetchTrI   r   zERROR: Could not fetch remote:rC   off---checkoutz-brE   zFetched into branch %szERROR: Failed to create branchz$Successfully fetched into FETCH_HEAD)r2   r!   git_commit_existsr   r-   r8   r9   r   r4   r6   rW   rR   rw   thanks_record_pr)	rb   r;   branch	check_sigty_trackgitargsrk   ri   rc   s	            r   fetch_remoter      s    2#7@S#T#T BDDWXXX\]]]qT666STTT2D4FHabbbq KK"DL$+>>>dk2G#FGtDDDJE3qyy8999!!F (V01U::&$'''
+KK 	<tV\:,f555'88
+s199OO<===OOC   L 
+ 	:;;; 1r   c                 \   t          j                    }d| j        z  }t          j        |          D ]}||k    r d S t          j        d | j                            dg           D                       }t          j        d | j                            dg           D                       }| j	        | j
+        | j        | j        t          j        |d          t          j        |d          t           j                            | j        d                   | j        | j        t           j                            | j        d	                   t          j        | j        d
+          d}t          j                            ||          }t-          |dd          5 }t/          j        ||dd           t2                              d|           d d d            n# 1 swxY w Y   t          j                    }	|	                    d          }
+|
+rt          j        | j	        |
+           d S d S )Nz%s.prc                 ,    g | ]}t          |          S r   strr   xs     r   r   z$thanks_record_pr.<locals>.<listcomp>       KKK1AKKKr   toc                 ,    g | ]}t          |          S r   r   r   s     r   r   z$thanks_record_pr.<locals>.<listcomp>   r   r   ccF)clean
+ReferencesDate   )maxlines)msgidsubjectr\   rZ   r   r   
+referencesremoter%   sentdatequotewr   )encoding   )ensure_asciiindentzWrote %s for thanks trackingzpw-review-state)r!   get_data_dirr9   oslistdirr   getaddressesr:   get_allr   r.   r\   rZ   r   r+   clean_headerr4   r6   
+make_quoter,   pathr   openjsondumpr   r   rR   getpatchwork_set_state)r;   datadirfilenameentryalltoallccri   fullpathfhrc   pwstates              r   r~   r~      s@   oG22HG$$  HFF KK0@0@r0J0JKKKLLEKK0@0@r0J0JKKKLLE$M^oe5111oe5111n11$(<2HII,{N//0@AAty1555 C w||GX..H	hg	.	.	. ?"	#ra88883X>>>? ? ? ? ? ? ? ? ? ? ? ? ? ? ? !!Fjj*++G 4
+tz7333334 4s   4GG"Grb   r;   mailfromretrieve_linksreturnc                    t          | |dd          }|dk    rt          d          |j        st                              d           g d}t          j        | |d          \  }}|dk    rCt                              d	           t                              |           t          d
+          |                                |_        |j        |j	        k    r)t                              d           t          d          t                              d           t                      }|j        j        D ]-}|                                dvr|                    |           .t          j        |j                            dg                     }	t          j        |j                            dg                     }
+t&          j                            t
+          j                            |j                            d                              }||}nvt&          j                            |          }|d         }|sd}|d                                         |d                                         k    r|d          d| |d         f}t          j                    }t3                      }|r|                    |j                   |j                                        d|j        d|d         |j        z  d}|r2t;                      }|                    t?          |d                     n3t&          j         !                                }|"                    |           d|j         d}|#                    dt          j$        |g                     |#                    d|j%                   |#                    d|j                            d                     |&                    d           |'                    dd            t          j(        | |j        d!||||j)        *                                |d"	  	        }t                      }tW          |          D ]\  }\  }}|,                    d#          }t[          |t\                    r|r|/                                }ta          j1        d$|t`          j2        t`          j3        z  %          }|r|4                    |           ta          j1        d&|t`          j2        t`          j3        z  %          }|r|4                    |           |#                    d'tI          |	                     |
+r#|#                    d(tI          |
+                     |j        d)         r>|#                    d*t
+          j                            |j        d)                              |                    |           t                              d+ta          j5        d,d-|                    d                               t                              d.tm          |                     |r|rto          j8                    5 }tr          j:        ;                    |d/          }ty          j=        |          }t                              d0           t                              d1tm          |                     t3                      }|D ]}||v rt          j>        |          }|r|D ]}t
+          j        ?                    |          }||vrv|                    |           t          @                    d2|                    d                     |                    |A                    t
+          jB        3                     tm          |          r|C                                 t          |d4          5 }t          jF        |G                                          } d5}!t          | d6          }"|"#                    d7d8|!            |                    |"           d d d            n# 1 swxY w Y   d d d            n# 1 swxY w Y   t                              d0           tm          |          r)t                              d9tm          |                     nt                              d:           |S );NF)r   r   r   zFetching unsuccessfulz.Running git merge-base to find common ancestry)z
+merge-baseHEADrE   TrI   zCould not find common ancestry.zCould not find common ancestryz9Cannot auto-discover merge-base on a merged pull request.z/Cannot find merge-base on a merged pull requestz0Generating patches starting from the base-commit)gitpullr   r   Fromz
+B4 Exploder*   z via z
+
+base-commit: z
+
+PR-Link: linkmask
+plainz<b4-exploded-%s-rN   Subjectr   r   zContent-Transfer-Encoding8bitrE   )covermsgprefixes	msgid_tptseriestsr   thread)decodez"^Link:\s+https?://.*/(\S+@\S+)[^/])flagsz^Message-ID:\s+(\S+@\S+)ToCczList-IdzX-Original-List-Id  %sz\n\s* zExploded %s messageszlinked.mboxr{   z"Retrieving %s linked conversationszAdded linked: %spolicyrbzlinked-threads.mbox.gzzx-gzipzContent-Dispositionzattachment; filename=z.Attached %s messages as linked-threads.mbox.gzz%Could not retrieve any linked threads)Ir   RuntimeErrorr2   r   r   r!   rW   r-   r]   r8   listlsubjectr   lowerappendr   r   r:   r   email	parseaddrr+   r   r   rR   r^   r_   r   r,   r	   attachr   messageEmailMessageset_payload
+add_headerr   r.   set_charsetreplace_headergit_range_to_patchesdate	timestamp	enumerateget_payload
+isinstancebytesr   r   findallMIupdater    r5   tempfileTemporaryDirectoryr   r   r   mailboxmboxget_pi_thread_by_msgidget_clean_msgidr   as_bytes	emlpolicycloser   gzipcompressreadr   )#rb   r;   r   r   rk   r   ri   r   prefixr   r   emlfromvianamerc   
+linked_idsr,   cmsgr   pmsgsmsgsatrK   r:   r=   tfdmbftmbxseen_msgidsr   lmsgsamsgidr   mbzfnameatts#                                      r   exploder    sk   GGGEqyy2333 R 	DEEE666'4HHH
+s199OO=>>>OOC   ?@@@!iikk$"444OOWXXXPQQQ
+KKBCCCvvH-( $ $<<>>00OOF### tx//b99::Etx//b99::Ek##BN$?$?V@T@T$U$UVVG;((221+ 	#"G1:!!2!2!4!444"1:55G55x{CH!!FJ # 	tz""" 		4...z0BTZ0O0O0OQD  HT7++,,,,}))++04:000IOOFBOXJ77888OOIt0111OOFDHLL00111W3V<<<#FD,?-1HPY-1Y-@-@-B-BX^bd d dE 66D&u-- H HMVSd++dE"" 	+~ 	+;;==Dj!FTVTX[][_T_```G +!!'***j!<d"$QSQU+VVVG +!!'***t\%00111 	6NN4e!4!45558I 	cNN/1L1LTXV_M`1a1abbbCFBF8S37793E3EFFGGGG
+KK&D		222 %A* %A(** 	%c',,sM22C<$$DKKKK<c*ooNNN%%K# I IK''1%88 I % I I!#!?!?!E!E!44'OOF333"LL);TXXi=P=PQQQ HHT]]",]%G%GHHH4yy %
+
+#t__ %-		22C4E)#x88CNN#8:YRW:Y:YZZZKK$$$% % % % % % % % % % % % % % %3	% 	% 	% 	% 	% 	% 	% 	% 	% 	% 	% 	% 	% 	% 	%@ 	E{ 	AKKH#kJZJZ[[[[KK?@@@Ks8   &E6a&A'aa&a	a&a	a&&a*-a*ghurlc                 `   t           j                            |           }|j                            d                              d          }|d         }|d         }|d         }d| d| d| }t          j                    }t          j	                    }|
+                    d          }	|	r|j                            dd	|	 i           |j                            d
+di           |
+                    |          }
+|
+j        dk    r"t                              d|
+j                   d S |
+                                }|
+                    di           }|
+                    di           }|
+                    di           }|
+                    di           }|
+                    d          }| d}d| }|
+                    |          }
+|
+j        dk    rG|
+                                }|
+                    d          }|s|}|
+                    d          }|s|}n|}|}t"          j                            t          j                  }| d| d|d<   |
+                    dd          }d| |d<   ||d<   t+          j        | d | d!| d"#          |d$<   t+          j        t1          j        |
+                    d%          d&                    }||d'<   |                    d(           |                    |
+                    d)d*          d(+           t          j        |          }|
+                    d,          |_        |
+                    d-          |_        |
+                    d.          |_        |
+                    d,          |_         |
+                    d,          |_!        |S )/N/r   r*   zhttps://api.github.com/repos/z/pulls/z
+gh-api-keyAuthorizationztoken Acceptzapplication/vnd.github.v3+json   zServer returned an error: %sheadr$   baseuserloginz@github.comzhttps://api.github.com/users/namer   r   rM   rN   r   titler   z[GIT PULL] r   r   -z-pr-
+github.com)idstringdomainz
+Message-Id
+created_atz%Y-%m-%dT%H:%M:%SZr   r   r,   z	(no body))r   sha	clone_urlr%   )"urllibparseurlparser   r]   r#   requestssessionr!   rR   r   headersr   status_coder   r-   r   r   r   r   r   r   
+make_msgidformat_datetimer   strptimer   r   r+   r2   r4   r6   r8   r9   )r  locr?   rprojrreporpullapiurlreqrc   ghkeyrespprdatar  r$   r  r  ulogin
+fake_emailudataunameuemailr:   r  r  r;   s                            r   get_pr_from_githubr1    s   
+,
+
+
+&
+&CX^^C  &&s++F1IE1IE2JEJUJJUJJ5JJF
+
+
+
+C!!FJJ|$$E @O-=e-=-=>???K"BCDDD776??D368HIIItYY[[F::fb!!D88FBD::fb!!D::fb!!DXXgF'''J5V55F776??D3				&!! 	E7## 	 F
+-
+$
+$BL
+$
+9
+9C''f'''CKJJw##E*5**C	NCI(U2O2OU2O2O2O2OXdeeeC&x'8L9Q9QSg'h'hiiJCKOOGOOFJJv{33WOEEE>#D((5//D88K((DL((5//DK%D $DKr   c                 6   | j         }d }| j        st          j                                        st
+                              d           t          j        t          j        j	        
+                                          }t          j                            |          | _        t          |          }n| j        rAd| j        v r8d| j        v r/t
+                              d           t!          | j                  }nt
+                              d           t          j        |           }t          j        |          }|sd S |D ]8}t          j                            |          }||k    rt          |          } n9||j        4t
+                              d| j                   t          j        d           |j        s|j        |_        | j        rt          j        |          5 }	 t/          ||| j        | j                  }n># t6          $ r1 t
+                              d	           t          j        d           Y nw xY wd d d            n# 1 swxY w Y   |r| j        rt          j        d
+| j         d          }t=          |          s4t
+                              d| j                   t          j        d           |d                             d          }	dd| j        d|	g}
+| j         r|
+!                    d           d}tE          j#                    5 }|D ]}tH          j%        &                    |d|z            }tO          |d          5 }|(                    |)                    t          j*                             d d d            n# 1 swxY w Y   |
+!                    |           |dz  }t          j+        | j         |
+d          \  }}| j         rt
+          ,                    |           t          j        |           d d d            n# 1 swxY w Y   t          j-                    }|                    dd          dk    rd}d}nd}d}| j.        }||j         d| }tH          j%        /                    |          r/t
+          ,                    d|           t          j        d           |rt          j0        ||           n=tO          |d          5 }t          j1        ||           d d d            n# 1 swxY w Y   t
+          ,                    d            t
+          ,                    d!|           t          j        d           n.t
+                              d	           t          j        d           t          j2        ||j                  }|r"t          j3        ||j                  }t=          |          rit
+          ,                    d"           |D ]}t
+          ,                    d#|           | j4        rt          j        d           t          j        d           t          j5        |g d$          }t=          |          ri|d         6                    |j                  dk    rEt
+          ,                    d%           | j4        r$to          ||           t          j        d           n5| j4        r.t
+          ,                    d&           t          j        d           tq          ||| j9        '           d S )(NzGetting PR message from stdinr  z/pull/zGetting PR info from Githubz$Getting PR message from public-inboxz-ERROR: Could not find pull request info in %sr*   )r   r   zNothing exploded.zsendemail\.z\..*z+Not able to find sendemail.%s configurationr   fromz
+send-emailz
+--identityz--fromz	--dry-runz%04dwbr   TrI   zsave-maildirsnoyesmaildirFmbx.zFile exists: %sr{   zSaved %sz9Pull request tip commit exists in the following branches:r   )logz-1z--pretty=onelinerE   z(Pull request is at the tip of FETCH_HEADz0Pull request does not appear to be in this tree.)r   ):rb   no_stdinr`   stdinisattyr   r   r   message_from_bytesbufferr   r!   r+   r   r   rA   r1  	get_msgidr   r9   r-   ra   r8   r  git_temp_cloner   getlinksr   sendidentityget_config_from_gitr5   r   dryrunr   r   r   r   r   r   r   writer   r   rW   r   rR   outmboxexistssave_maildirsave_git_am_mboxr}   git_branch_containsrO   r"   r   rw   r   r   )cmdargsrb   r;   r:   r   r   mmsgidtcrc   r   r   counterr   outfiletfhrk   ri   rI  dftextsavefiler   rH  branchesr   logliness                            r   mainrV    s   ^FD CI$4$4$6$6 4555&sy'7'<'<'>'>??66s;;S!!= 	\W]::x7=?X?XLL6777%gm44DDLL?@@@L))E,U33D   77<<U??(--DE # |t08GWWW 7!6 ;v&& 	"r4'2BSZScddd    3444	 	 	 	 	 	 	 	 	 	 	 	 	 	 	  2	# $/0Yw?S0Y0Y0YZZ6{{  OO$QSZSghhhHQKKK7;;v..'w7KXW_`> 0NN;///022 
+$c# % %"$',,sFW4D"E"E!'400 ICIIcll",l&G&GHHHI I I I I I I I I I I I I I Iw///1!#!3GNGW[!\!\!\JE3~ )C(((HUOOO
+$ 
+$ 
+$ 
+$ 
+$ 
+$ 
+$ 
+$ 
+$ 
+$ 
+$ 
+$ 
+$ 
+$ 
+$ '))Fzz/400E99#"$H"j33633w~~h'' -x888 2h////(D)) 2R'b1112 2 2 2 2 2 2 2 2 2 2 2 2 2 2KKKK
+H---HQKKKKOO/000HQKKK!&$*<==F )&$2DEEx== 	KKSTTT" , ,FF++++} HQKKK +F4c4c4cddx== 	Xa[--d.@AAQFFKKBCCC} !&$///	 FGGGgn555555s   'I)HI8I?IIIII8P4NPNPNA2PP!$P!)TTT)NTT)NT)0
+__author__r   r`   r   r!   r   r   r   r   r   urllib.parser  r  r   r   r   r   email.mime.textr   email.mime.applicationr   email.mime.multipartr	   typingr
+   r   add_charsetr   compiler   r   r/   r7   r3   r   r(   rA   rw   r   r~   r   r+   boolr   Messager  r1  rV  r   r   r   <module>ra     s   E
+ 				 
+
+
+
+  				 				          ( ( ( ( ( ( ( (                 $ $ $ $ $ $ 2 2 2 2 2 2 . . . . . . ! ! ! ! ! ! ! !  GT " " "	 BJ7EE  BJ6rtDD  BJI24RTRV;WWBJ6rtDD A A A  D" " "J= = =@( ( ( (V4 4 4B TX#'H HHSM H H8C= H H,01F,GH H H HV9c 9 9 9 9xv6 v6 v6 v6 v6r   
\ No newline at end of file
diff --color -Naur /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/ty.cpython-311.pyc /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/ty.cpython-311.pyc
--- /usr/local/google/home/justinstitt/repos/b4/b4/__pycache__/ty.cpython-311.pyc	1970-01-01 00:00:00.000000000 +0000
+++ /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/__pycache__/ty.cpython-311.pyc	2023-07-17 20:22:03.224602098 +0000
@@ -0,0 +1,171 @@
+
+    dOZ                     
+   d Z ddlZddlZddlZddlZddlZddlZddlZddlZddl	m
+Z
+ ddlmZ ddlmZ ej        ZdZdZdadaddZd	 Zd
+ Zd Zd ZddZddZd Zd Zd Zd Zd Zd Zd Z d Z!d Z"d Z#d Z$d Z%d Z&dS ) z5Konstantin Ryabitsev <konstantin@linuxfoundation.org>    N)Template)utils)Pathzj
+On ${sentdate}, ${fromname} wrote:
+${quote}
+
+Merged, thanks!
+
+${summary}
+
+Best regards,
+-- 
+${signature}
+zk
+On ${sentdate}, ${fromname} wrote:
+${quote}
+
+Applied, thanks!
+
+${summary}
+
+Best regards,
+-- 
+${signature}
+c                 ~    dd|z  dg}|||gz  }t          j        | |          }t          |          sd S |d         S )Nzrev-listz%s..z--ancestry-path)b4git_get_command_lineslen)gitdir	commit_idbranchargsliness        O/usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/ty.pygit_get_merge_idr   8   sU    *,=>D$VT22Eu:: t9    c                 >    d|d|g}t          j        | |          S )Ndiffz~..r   git_run_commandr   revr   s      r   git_get_rev_diffr   C   s*    cc*+Dfd+++r   c                 8    ddd|g}t          j        | |          S )Nlogz--format=%Bz-1r   r   s      r   git_get_commit_messager   H   s#    =$,Dfd+++r   c                    t           j                                        }|d         d|d         d|d<   t          j                    }t          j        |d         |d         fg||          }|                    |d                    |                    |d                    t          j        t          j        |d         g          ||          }t          j        t          j        |d	         g          ||          }|r||z  }|	                    d
+t          j
+        |                     |r(|	                    dt          j
+        |                     d|d         z  |d<   t          |d                   r|d         d|d         d|d<   nd|d         z  |d<   t          j        dd|d         t          j                  }|                    d          r|	                    dd|z              n|	                    dd|z              |d                             d          d         }	t           j                            d|	          |d<   t           j                            d          |d <   t'          |                               |          }
+|                    |
+d!"           |                    d!           |S )#Nmynamez <myemail>Fromfromname	fromemailtoccToCcz<%s>msgidzIn-Reply-To
+references
+Referencesz^Re:\s+ subjectflags
+cherrypickSubjectzRe: (subset) zRe: @   zb4-ty)idstringdomainz
+Message-IdT)	localtimeDateutf-8)charset)emailmessageEmailMessager   get_excluded_addrscleanup_email_addrsaddr   getaddresses
+add_headerformat_addrsr
+   resubIgetsplit
+make_msgid
+formatdater   safe_substituteset_payloadset_charset)reply_templatejsondatar   msgexcludesnewtoalltoallccr,   mydomainbodys              r   
+make_replyrU   M   s   
+-
+$
+$
+&
+&C'1118I3F3F3FGCK$&&H"Xj%98K;P$Q#RT\^deeE LL)$%%%LL+&'''"5#5x~6F#G#GSYZZE"5#5x~6F#G#GSYZZE NN4//000 5tR_U33444(7"33C
+8L!"" 7)1,)?)?)?'ARARARSL"Xg%66LfZXi%8EEEG||L!! 4y/G";<<<<y&7"2333	"((--a0H...QQC+((4(88CKN##33H==DOOD'O***OOGJr   c                    |d         }t                               d|d                    t          j        | |          sd S t          j        | |          }t          |          st                               d|           d S ||vrt                               d||           d S t          | ||          }|st                               d|           d S dd|g}t          j        | |          }|st                               d|           d S t          j                    }|d	         |vr>t                               d
+|           t                               d|d                    d S |S )Npr_commit_idChecking %sz%s is not on any branchesz%s is not on branch %sz&Could not get a merge commit-id for %sshowz--format=%aez(Could not get merge commit author for %sr9   z)Merged by a different author, ignoring %sz
+Author: %sr   )	loggerdebugr   git_commit_existsgit_branch_containsr
+   r   r	   get_user_config)	r   rM   r   rW   
+onbranchesmerge_commit_idgitargsoutusercfgs	            r   auto_locate_prrd   u   sm   N+L
+LL 899955 t'==Jz?? 0,???tZ-|VDDDt 'v|VDDO =|LLLt ~7G
+
+"67
+3
+3C ?NNNt ""Gws""@,OOO\3q6***tr   1.weekc                 n   t           t           S t                      a |t          j                    }|d         }dd|ddd||g}t          j        | |          }t          |          s"t                              d|           t           S t                              dt          |          |           t                              d	           |D ]}|	                    d
+          \  }}	t          | |          \  }
+}t          j                            |          }t                              d|           t          | |          \  }
+}t          j        d|t          j        t          j        z            }t%                      }|r|D ]}|                    |           ||	|ft           |<   t           S )Nr9   r   z--committerz--no-abbrevz	--onelinez--sincez/No new commits from the current user --since=%sz!Found %s of your commits since %sz.Calculating patch hashes, may take a moment...r2   )maxsplitzphash=%sz'^\s*(?:message-id|link):[ \t]+(\S+)\s*$r-   )
+MY_COMMITSdictr   r^   r	   r
+   rZ   r[   inforF   r   LoreMessageget_patchwork_hashr   rB   findallrD   Mlistappend)r   r   since	committerrc   ra   r   liner   r,   ecoderb   pwhashmatchestrackerstvalues                   r   get_all_commitsry      s   J$&&G$	mY{IW\^deG$VW55Eu:: FNNN
+KK3SZZGGG
+KK@AAA < <!ZZZ33	7%fi88
+s22377Z(((+FI>>
+s*GTVTX[][_T_```66 	(! ( ('''''(;
+6r   c                 F   t          | ||          }t          |                                          }t                      }d}d}|d         D ]}	|dz  }t                              d|	           |	d         |v rPt                              d|	d                    |                    |||	d                  d         f           |dz  }}d}
+|                                D ]\  }}|d         |	d         k    r@t                              d           |                    ||d         f           d}
+|dz  } nt          |	          d	k    rt          |	d	                   rt          |d	                   rj|d	         D ]a}|	                    |	d	                   dk    r@t                              d
+           |                    ||d         f           d}
+|dz  } nb|
+r n|
+s8t                              d|	d                    |                    |d f           |S )Nr   patchesr2   rX   z	Found: %sFzMatched using subjectT   z!Matched using recorded message-idz   Failed to find a match for: %s)
+ry   setkeysro   rZ   r[   rp   itemsr
+   find)r   rM   r   rq   commitspatchidsfoundrv   atpatchsuccessru   committrackers                 r   auto_locate_seriesr      s)   ffe44G7<<>>""HFFEG	
+B)$ ) )
+a]E***8xLLeAh///LL"geAh/23444qLGG G")--//  !9a((LL!8999LL"fQi111"GqLGEZZ!^^E!H^#fQi..^#)!9 " ""<<a11Q66"LL)LMMM!LL"fQi999&*G#qLG!E 7  E  )?qJJJb$Z(((Lr   c                    t          | |          }||d<   |                                D ]@\  }}|dk    r||d<   |dk    r||d<   |dk    r||d<   )|dk    r||d	<   5|dk    r||d<   Ad|v r|d         |d
+<   nkd|v rb	 t          |d                   }t          j                            |j        d         |j        d                   |d
+<   n#  |d         |d
+<   Y nxY wd|d
+<   ||fS )Nr   zb4-treenamezthanks-treenamezb4-commit-url-maskthanks-commit-url-maskzb4-pr-templatethanks-pr-templatezb4-am-templatethanks-am-templatetreenameurlr   z
+local tree)get_branch_infor   r   ospathjoinparts)r   r   rM   configbinfokeyvalpurls           r   set_branch_detailsr      sI   FF++EHXKKMM 
+% 
+%S-(+F$%%(((/2F+,,$$$+.F'(($$$+.F'((H__!$HXF""%&78	%	0e%%D#%7<<
+2
+2#O#OHZ  	0#(<HZ   +Vs    AC Cc                 l   t          j                    }t          | |||          \  }}t          }|d         ra	 t          j        |d                   }nE# t
+          $ r8 t                              d|d                    t          j	        d           Y nw xY wd|vrlt          | |d                   }|sOt                              d|d                    t                              d           t          j	        d	           ||d<   |d
+         }|sd}||d         z  |d<   t          |||           }|S )Nr   z?ERROR: thanks-pr-template says to use %s, but it does not existr|   r`   rW   z$Could not get merge commit id for %sr,   zWas it actually merged?r2   r   zmerge commit: %ssummary)r   get_main_configr   DEFAULT_PR_TEMPLATEread_templateFileNotFoundErrorrZ   criticalsysexitr   rU   )r   rM   r   r   thanks_templater`   cidmaskrN   s           r   generate_pr_thanksr   	  sW   !!F)&&(FKKHf)O"# 	 .v6J/KLLOO  	 	 	OO]"#78: : :HQKKKKK	
+ ((*68N3KLL 	OOBHYDWXXXOO5666HQKKK&5"#-.G %$!H->$??HY
+_h
+7
+7CJs   A ?BBc                 n   t          j                    }t          | |||          \  }}t          }|d         ra	 t          j        |d                   }nE# t
+          $ r8 t                              d|d                    t          j	        d           Y nw xY wd|vrt          | |||          }n|d         }|d         }|sd}t                      }d}	t          t          t          |                              }
+|d         }|D ]\  }}	 d	||d
+z
+           d         z  }nF# t          $ r9 dt          |                              |
+          dt          |          d}Y nw xY w|                    |||d
+z
+           d                    |.|                    ddt          |          z  z             |	d
+z  }	|                    dt          |          z  ||z             d                    |          |d<   |	t          |          k    r<t                              d|d                    t                              d           nP|	dk    rJt                              d|	t          |          |d                    t                              d           t%          |||           }|S )Nr   z?ERROR: thanks-am-template says to use %s, but it does not existr|   r   r   z
+commit: %sr   r{   z[%s] r2      [/z] z%s(no commit info) 
+r   z.  WARNING: None of the patches matched for: %sr,   z.           Please review the resulting messagez2  WARNING: Could not match %s of %s patches in: %s)r   r   r   DEFAULT_AM_TEMPLATEr   r   rZ   r   r   r   r   ro   r
+   str
+IndexErrorzfillrp   r   rU   )r   rM   r   rq   r   r   r   r   slinesnomatchpadlenr{   r   cidprefixrN   s                   r   generate_am_thanksr   &  s   !!F)&&(FKKHf)O"# 	 .v6J/KLLOO  	 	 	OO]"#78: : :HQKKKKK	   $VXvuEE9%-.G VVFGS\\""##Fy!G 
+G 
+GC	Hwr!t}Q//FF 	H 	H 	H 	H#&r77==#8#8#8#8#g,,,,GFFF	H1a(8(89:::;MM.#F2CDEEEqLGGMMC#f++$5$5w}}EFFFF))F++HY#g,,H(S\J]^^^HIIII	1LWx	/B	D 	D 	DHIII
+_h
+7
+7CJs$   A ?BBD""A E%$E%c                 *   | j         }t          |           }t                              d|           t	                      }t          |          s.t                              d           t          j        d           t                      }|D ]}d|v rt          |||          }|||d<   n3t          |||| j                  }d}|D ]}	|	d         d	} n|sN||d
+<   |                    |           t                              d|d                    t          |          s.t                              d           t          j        d           t                              d           t          |||            t          j        d           d S )NzAuto-thankanating commits in %sNothing to dor   rW   r`   )rq   Fr2   Tr   z  Located: %sr,   ---)r   get_wanted_branchrZ   rj   list_trackedr
+   r   r   ro   rd   r   rq   rp   send_messages)
+cmdargsr   
+wantbranchtrackedappliedrM   r`   r   r   r   s
+             r   auto_thankanatorr   V  s   ^F"7++J
+KK1:>>>nnGw<< O$$$ffG : :X%%,VXzJJO&*9H&'' ):W][[[GE!  !9( EE )  ")HYx   OXi%89999w<< O$$$
+KK':w///HQKKKKKr   c           	         t                               dt          |                      |j        }t	          j                    }d }d }t	          j                    }|j        s*|                    dd          	                                dv ryd}	 t	          j
+                    \  }}n# t          $ rR}	t                               d           t                               |	           t          j        d           Y d }	~	nGd }	~	ww xY wd}t          j                            |j                  st          j        |j                   t	          j                    }
+t	          j                    }d	}t-                      }| D ]}|
+d
+         |d<   |
+d         |d<   ||d<   d|v rt/          |||          }nt1          ||||j                  }|N|                    |d                    |                    dt-                                D ]}|                    |d                    |dz  }|ru|s|d         }t                               dt          j                            |                    d                               t	          j        ||g||j                   nt?          j         dd|d                   }t?          j         dd|d                   }|	                                d|	                                }t?          j         dd|          }t          j        !                    |j        d|z            }t                               d|           tE          |d          5 }|#                    |$                    t          j%                             d d d            n# 1 swxY w Y   |j        rt                               d           _t           &                    d|d                     t          j        !                    ||d                    }t          j'        |d!|z             t                               d"           |st                               d#           d S t	          j                    }|j(        }|s|                    d$          }|rZ|j        rt                               d%|           d S t                               d&|           |rt	          j)        ||           d S d S |r/t	          j)        ||           t                               d"           t           &                    d'|           t                               d(           t                               d)|j                   d S )*NzGenerating %s thank-you letterszty-send-emailno)yestrue1Tz(Failed to configure the smtp connection:r2   Fr   namer   r9   r   	signaturerW   r(   r{   r|   z  Sending: %sr,   )dryrunz\W_r#   z_+z	%s.thanksz  Writing: %swb)policyz#Dry run, preserving tracked series.zCleaning up: %s	trackfilez%s.sentr   No thanks necessary.zpw-accept-statez&DRYRUN: generated %s thank-you letterszSent %s thank-you letterszWrote %s thank-you letterszYou can now run:z  git send-email %s/*.thanks)*rZ   rj   r
+   r   r   get_data_dirr   	sendemailrE   lowerget_smtp	Exceptionr   r   r   r   r   existsoutdirmkdirr^   get_email_signaturero   r   r   rq   rp   rk   clean_header	send_mailr   rB   rC   r   openwriteas_bytes	emlpolicyr[   renamepw_set_statepatchwork_set_state)listingr   r   r   datadirfromaddrsmtpr   
+send_emailexrc   r   outgoingmsgidsrM   rN   pdata	slug_from	slug_subjslugoutfilefhfullpathpwstates                           r   r   r     sQ   
+KK13w<<@@@^FoGHD!!F %FJJ==CCEEI]]]
+	[]]ND(( 	 	 	OOFGGGOOBHQKKKKKKKK	 
+w~~gn-- 	%HW^$$$ ""G&((IHVVF &6 &6$V_%g. )X%%$VXv>>CC %VXvw}MMC;hw'(((\\)TVV44 	$ 	$EMM%(####A 	< /#I.KK)D)DSWWYEWEW)X)XYYYLuhw~FFFFFuc8K+@AAIuc8I+>??I'oo////1B1B1BCD6%d++Dgll7>;3EFFGKK111gt$$ <R\::;;;< < < < < < < < < < < < < < <> 	6KK=>>>>LL*H[,ABBBw||GXk-BCCHIh	H 45555
+KK *+++!!F"G 0**.// D> 	8KK@(KKKKKKK3X>>> 8&vw777778 8  	"67333KK18<<<&'''2GNCCCCCs+   B% %
+D/AC<<D,4N,,N0	3N0	c                     t                      } t          j                    }t          t	          |                                          t          j        j                  }|D ]}|j	        dvr|
+                    dd          5 }t          j        |          }|j        |d<   |j	        dk    r
+|j        |d<   d d d            n# 1 swxY w Y   |                     |           | S )	N)r   ).prz.amrr7   )encodingr   r   rW   )ro   r   r   sortedr   iterdirr   r   getmtimesuffixr   jsonloadr   stemrp   )r   r   pathsr   r   rM   s         r   r   r     s   ffGoG4==((**0@AAAE ! !?.00]]3]11 	9Ry}}H$,MH[!%''+3=(		9 	9 	9 	9 	9 	9 	9 	9 	9 	9 	9 	9 	9 	9 	9
+ 	x    Ns   4CC
+	C
+	c                    d}t          j                    }t                              d           | D ]}t                              d||d                    t                              d|d         |d                    t                              d|d	                    t                              d
+|d         |d         z             |dz  }d S )Nr2   zCurrently tracking:z%3d: %sr,   z       From: %s <%s>r"   r#   z       Date: %ssentdatez       Link: %slinkmaskr(   )r   r   rZ   rj   )r   counterr   entrys       r   write_trackedr    s    G!!F
+KK%&&&  Iwi(8999*E*,=u[?QRRR%uZ'8999%vj'9E'N'JKKK1 r   c                    t                      }t          |          s.t                              d           t	          j        d           | j        dk    r|}n1t                      }t          j	        | j        t          |                    D ]}	 t          |          dz
+  }|                    ||                    1# t          $ rZ t                              d           t                              d           t          |           t	          j        d           Y t          $ r[ t                              d|           t                              d           t          |           t	          j        d           Y w xY wt          |          s.t                              d           t	          j        d           t!          |           }t#          |||            t	          j        d           d S )	Nr   r   allupperr2   (Please provide the number of the messager   Invalid index: %s)r   r
+   rZ   rj   r   r   thankforro   r   parse_int_rangeintrp   
+ValueErrorr   r  r   r   r   )r   r   r   numindexr   s         r   thank_selectedr    s   nnGw<< O$$$5  &&%g&6c'llKKK 	 	CC1wu~....    JKKKE"""g&&&    3S999E"""g&&&	
+ w<< O$$$"7++J':w///HQKKKKK   -CA!F	%A!F	F	c                 ^   t                      }t          |          s.t                              d           t	          j        d           | j        dk    r|}n1t                      }t          j	        | j        t          |                    D ]}	 t          |          dz
+  }|                    ||                    1# t          $ rZ t                              d           t                              d           t          |           t	          j        d           Y t          $ r[ t                              d|           t                              d           t          |           t	          j        d           Y w xY wt          |          s.t                              d           t	          j        d           t          j                    }t                              d	t          |                     t                      }|D ]}t"          j                            ||d
+                   }t#          j        |d|z             t                              d|d                    |                    |d                    |                    dt                                D ]}	|                    |	d                    t          j                    }
+| j        }|s|
+                    d          }|rt          j        ||           t	          j        d           d S )Nr   r   r  r  r2   r  r   r	  zDiscarding %s messagesr   z%s.discardedz  Discarded: %sr,   r(   r{   r|   zpw-discard-state)r   r
+   rZ   rj   r   r   discardro   r   r  r  rp   r  r   r  r   r   r   r   r   r   rE   r   r   r   )r   r   r   r  r  r   r   rM   r   r   r   r   s               r   discard_selectedr    s   nnGw<< O$$$%&&%goS\\JJJ 	 	CC1wu~....    JKKKE"""g&&&    3S999E"""g&&&	 w<< O$$$oG
+KK(#g,,777VVF $ $7<<+)>??
+	(NX5666%x	':;;;hw'(((\\)TVV44 	$ 	$EMM%(####	$ !!F"G 1**/00 0
+vw///HQKKKKKr  c                 l   t           j                            |           rt          |                                           D ]r}|j        dk    rct                              d|            t                              d           t                              d           t          j	        d           qd S d S )Nz.thanksz*ERROR: Found existing .thanks files in: %sz:       Please send them first (or delete if already sent).z4       Refusing to run to avoid potential confusion.r2   )
+r   r   r   r   r   r   rZ   r   r   r   )r   r  s     r   check_stale_thanksr  M  s    	w~~f &\\))++ 	 	E|y(( LfUUU \]]] VWWW 	 	r   c                     | j         }| j        sg d}t          j        ||          \  }}|dk    r.t                              d           t          j        d           t          j	        dd|
+                                          }t                              d|           nkdd	d
+d| j        g}t          j        ||          }t          |          s4t                              d| j                   t          j        d           | j        }|S )N)zsymbolic-refz-qHEADr   z6Not able to get current branch (git symbolic-ref HEAD)r2   ^refs/heads/r+   zwill check branch=%sr   z--format=%(refname)z--listz--allz8Requested branch not found in git branch --list --all %s)r   r   r   r   rZ   r   r   r   rB   rC   stripr[   r	   r
+   )r   r   ra   rt   rb   r   r   s          r   r   r   W  s    ^F> $000'88
+s199OOTUUUHQKKKVOR==
++Z8888 2Hgw~V(995zz 	OOVX_XfgggHQKKK^
+r   c                    t           t           S t                      a t          j        d|z            }|d|vrddg}t          j        | |          }t          |          st           S d }|D ]"}|                    | d          dk    r|} n#|t           S |t           d<   |                    | dd          t           d<   n8|d         t           d<   d|v r$t          j	        d	d|d                   t           d<   t          j        d
+t           d         z            }t           
+                    |           t           S )Nzbranch\.%s\..*remoterY   r   r   r+   r   merger  zremote\.%s\..*)BRANCH_INFOri   r   get_config_from_gitr	   r
+   r   replacerB   rC   update)r   r   	remotecfgra   r   r  r  s          r   r   r   o  sU   &&K&'9F'BCCIHI55V$(995zz 	 	 	E{{e;;;''1,, - > &H &&|||R @ @H !*( 3Hi$&F?B	'@R$S$SK! &'9K<Q'QRRIy!!!r   c                    t          j                    }d|vr.t                              d           t	          j        d           | j        r%t          | j                   t          |            d S | j
+        r%t          | j                   t          |            d S | j        rt          |            d S t                      }t          |          s.t                              d           t	          j        d           t#          |           t                              d           t                              d           t                              d           d S )	Nr9   z7Please set user.email in gitconfig to use this feature.r2   r   r   r   z+You can send them using number ranges, e.g:z  b4 ty -t 1-3,5,7-)r   r^   rZ   r   r   r   autor  r   r   r
+  r  r  r  r   r
+   rj   r  )r   rc   r   s      r   mainr%    s9    ""GgQRRR| +7>***!!!!!		 +7>***w	 
++!!!!!..7|| 	KK.///HQKKKgEABBB)*****r   )N)re   N)re   )'
+__author__r   r   r   rB   r9   email.messageemail.policyr   stringr   r   pathlibr   rZ   r   r   rh   r  r   r   r   rU   rd   ry   r   r   r   r   r   r   r   r  r  r  r  r   r   r%   r   r   <module>r,     s
+   E
+ 				 
+
+
+
+ 				 				                            	   
+   , , ,
+, , ,
+% % %P! ! !H" " " "J( ( ( (V  @  :- - -`& & &R[D [D [D|  "	 	 	  B/ / /d    0& & &R+ + + + +r   
\ No newline at end of file
diff --color -Naur /usr/local/google/home/justinstitt/repos/b4/b4/ty.py /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/ty.py
--- /usr/local/google/home/justinstitt/repos/b4/b4/ty.py	2023-07-17 22:13:41.942073527 +0000
+++ /usr/local/google/home/justinstitt/.local/lib/python3.11/site-packages/b4/ty.py	2023-07-17 20:22:03.168602190 +0000
@@ -404,16 +404,13 @@
             os.mkdir(cmdargs.outdir)
 
     usercfg = b4.get_user_config()
-    config = b4.get_main_config()
-    user_name = config.get('thanks-from-name', usercfg['name'])
-    user_email = config.get('thanks-from-email', usercfg['email'])
     signature = b4.get_email_signature()
 
     outgoing = 0
     msgids = list()
     for jsondata in listing:
-        jsondata['myname'] = user_name
-        jsondata['myemail'] = user_email
+        jsondata['myname'] = usercfg['name']
+        jsondata['myemail'] = usercfg['email']
         jsondata['signature'] = signature
         if 'pr_commit_id' in jsondata:
             # This is a pull request
@@ -456,6 +453,7 @@
         logger.info('No thanks necessary.')
         return
 
+    config = b4.get_main_config()
     pwstate = cmdargs.pw_set_state
     if not pwstate:
         pwstate = config.get('pw-accept-state')
